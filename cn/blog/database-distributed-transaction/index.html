<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>数据库分布式事务简介 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="分布式事务与传统的单机事务要复杂很多，由此衍生出来多种算法，这里简单介绍。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>数据库分布式事务简介</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2024-09-21</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/database/ role=button>database</a></div></div><hr><div class=content><p>分布式事务与传统的单机事务要复杂很多，由此衍生出来多种算法，这里简单介绍。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p>当多节点参与时，除了要满足 ACID 特性之外，还有共识 (Consensus) 问题。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Atomic: 在网络、节点故障场景下如何保证
</span></span><span class=line><span class=cl>Consistency: 不会出现中间态
</span></span><span class=line><span class=cl>Isolation: 大延迟会不会导致持锁时间过长
</span></span><span class=line><span class=cl>Durability: 多副本
</span></span><span class=line><span class=cl>Consensus: 多副本能否表现的像一个副本
</span></span></code></pre></div><p>分布式事务实际使用时有两种场景：</p><ul><li>数据库层面，当单机无法满足时，拆分为多机对外提供服务，可以是类似 OceanBase、TiDB 这种分布式数据库，也可以是基于 XA 协议在 MySQL 上封装的代理层。</li><li>微服务层面，某个服务被拆分到不同的服务器上，例如交易系统，需要同时调用订单、扣款、库存等服务，这一过程中如何保证业务整体的事务性。有很多 SDK 的相关实现，例如 <a href=https://seata.apache.org>Seata</a>、<a href=https://github.com/liuyangming/ByteTCC>ByteTCC</a>、<a href=https://github.com/changmingxie/tcc-transaction>TccTransaction</a>、<a href=https://github.com/QNJR-GROUP/EasyTransaction>EasyTransaction</a> 等。</li></ul><p>相比单机事务，分布式系统的事务处理要更加复杂，主要原因有：</p><ul><li>多节点，不同节点在事务执行的不同阶段可能会出现异常，例如 A 节点成功锁住资源，但是 B 节点加锁失败；A 节点事务提交成功，但是 B 节点在提交时宕机了；多个节点提交时，始终有某个节点失败。</li><li>网络或者主机异常导致未收到响应，在 A 告诉 B 提交事务时超时，可能是 B 压根没有收到请求，也有可能是 B 已经处理完了，但是响应的报文丢失了。</li><li>网络延迟，通常在单机上的简单实现在分布式场景下已经不再适用，例如事务 ID，需要同时保证唯一性，可能还需要保持递增。</li></ul><a class=anchor id=2pc></a><h1>2PC <a href=#2pc aria-hidden=true>#</a></h1><p>也就是 <code>Two Phase Commit, 2PC</code> 两阶段提交，包含了两个角色，对应 A) 参与者 (Participant)，管理本地资源，实现本地事务；B) 协调者 (Coordinator)，管理分布式事务，协调各个参与者。</p><p>第一阶段中，协调者分配事务 ID 并持久化到磁盘，然后调用所有参与者执行事务；参与者开始执行事务，可能需要对资源加锁以及 Redo/Undo 日志落盘；如果参与者执行成功，则返回 Yes 否则返回 No 结果。</p><p>第二阶段中，分成了两种情况。</p><ul><li><strong>所有参与者回复 Yes，事务准备成功，执行 Commit 操作</strong> 协调者写 Commit 日志并落盘，并向所有参与者发送 Commit 请求；参与者执行 Commit 操作，包括 Commit 日志落盘、释放资源，然后响应协调者；协调者接受到所有参与者完成消息后，事务提交成功。</li><li><strong>至少一个参与者回复 No，事务准备失败，执行 Abort 操作</strong> 协调者写 Abort 日志并落盘，并向所有参与者发送 Abort 请求；参与者执行 Rollback 操作，释放资源，然后响应协调者回滚完成；协调者接受到所有参与者完成消息后，取消事务。</li></ul><p>看着很简单，关键是如何处理服务器宕机和网络超时等问题。其中有个原子，如果协调者已经提交事务，那么各个参与者就必须要提交，绝对不允许回滚。</p><a class=anchor id=tcc></a><h1>TCC <a href=#tcc aria-hidden=true>#</a></h1><p>最早由 2007 年 Pat Helland 在 <a href=https://ics.uci.edu/~cs223/papers/cidr07p15.pdf>Life beyond Distributed Transactions</a> 提出，该模型中，事务参与者需要实现如下三个接口：</p><ul><li><code>Try</code> 参与者检查资源是否有效，预留资源。</li><li><code>Confirm</code> 参与者提交资源。</li><li><code>Cancel</code> 参与者执行回滚操作，恢复预留资源。</li></ul><p>该模型没有在 Try 阶段加锁，性能要高于两阶段提交，不同事务可以并发执行。</p><a class=anchor id=percolator></a><h1>Percolator <a href=#percolator aria-hidden=true>#</a></h1><p>Google 会定期爬取页面并保存到索引中，通过 Percolator 系统处理大规模的增量数据，该系统是构建在 BigTable 之上的，提供了 Snapshot Isolation 语义。简言之，其基于 BigTable 的单行事务和全局授时服务器 TSO 实现了跨机多行的分布式事务。</p><blockquote><p>TSO 的全称是 TiemStamp Oracle，虽然带了 Oracle 关键字，但并非指数据库，而是其原始含义，也就是神谕、神授的、不可质疑的。</p></blockquote><p>总体来说，这是一个优化后的两阶段提交，最初源自 <a href=http://notes.stephenholiday.com/Percolator.pdf>Large-scale Incremental Processing</a> 这篇论文。</p><a class=anchor id=基本原理></a><h2>基本原理 <a href=#%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86 aria-hidden=true>#</a></h2><p>在论文中定义了 5 列，实际核心的涉及到如下三列：</p><ul><li><code>lock</code> 保存未提交的锁信息。</li><li><code>write</code> 提交信息，包含对应的时间戳。</li><li><code>data</code> 真实的数据。</li></ul><a class=anchor id=omid></a><h1>OMID <a href=#omid aria-hidden=true>#</a></h1><p>这是基于 Percolator 的改进。</p></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#2pc>2PC</a></li><li><a href=#tcc>TCC</a></li><li><a href=#percolator>Percolator</a><ul><li><a href=#基本原理>基本原理</a></li></ul></li><li><a href=#omid>OMID</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>