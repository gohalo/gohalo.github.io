<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>MySQL 关闭过程 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="简单分析下 mysqld 进程关闭的过程，并讨论如何安全地关闭 MySQL 实例。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>MySQL 关闭过程</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2017-03-01</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/database/ role=button>database</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/mysql/ role=button>mysql</a></div></div><hr><div class=content><p>简单分析下 mysqld 进程关闭的过程，并讨论如何安全地关闭 MySQL 实例。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p>通常有几种方式关闭 MySQL 服务器，常见有如下：A) 执行 <code>mysqladmin shutdown</code> 命令；B) 向服务器发送 <code>SIGTERM</code>、<code>SIGQUIT</code> 信号。</p><a class=anchor id=mysqladmin></a><h2>mysqladmin <a href=#mysqladmin aria-hidden=true>#</a></h2><p>首先，看下通过 <code>mysqladmin shutdown</code> 调用时的执行流程。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>execute_commands</span><span class=p>(</span><span class=n>MYSQL</span> <span class=o>*</span><span class=n>mysql</span><span class=p>,</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span> <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(;</span> <span class=n>argc</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>;</span> <span class=n>argv</span><span class=o>++</span><span class=p>,</span><span class=n>argc</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>option</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>log_warnings</span><span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>option</span><span class=o>=</span> <span class=n>find_type</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>command_typelib</span><span class=p>,</span> <span class=n>FIND_TYPE_BASIC</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>ADMIN_SHUTDOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span> <span class=p>...</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span><span class=p>(</span><span class=n>mysql_get_server_version</span><span class=p>(</span><span class=n>mysql</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>50709</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>resShutdown</span><span class=o>=</span> <span class=n>mysql_shutdown</span><span class=p>(</span><span class=n>mysql</span><span class=p>,</span> <span class=n>SHUTDOWN_DEFAULT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>resShutdown</span><span class=o>=</span> <span class=n>mysql_query</span><span class=p>(</span><span class=n>mysql</span><span class=p>,</span> <span class=s>&#34;shutdown&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span><span class=p>(</span><span class=n>resShutdown</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>my_printf_error</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s>&#34;shutdown failed; error: &#39;%s&#39;&#34;</span><span class=p>,</span> <span class=n>error_flags</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>mysql_error</span><span class=p>(</span><span class=n>mysql</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如上，当版本小于 <code>5.7.9</code> 时，实际上会调用 <code>mysql_shutdown()</code> 函数，而在 <code>5.7.9</code> 版本之后(包括该版本)，则会调用 <code>mysql_query()</code> 函数。</p><p>在此，主要看下后者的处理。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>dispatch_command()
</span></span><span class=line><span class=cl> |                              ← COM_SHUTDOWN:
</span></span><span class=line><span class=cl> |-shutdown()                   ← 调用相同文件下的函数，关闭mysqld服务
</span></span><span class=line><span class=cl>   |-check_global_access()
</span></span><span class=line><span class=cl>   |-my_ok()                    ← 返回客户端，COM_QUERY&lt;=&gt;my_ok()，COM_SHUTDOWN&lt;=&gt;my_eof()
</span></span><span class=line><span class=cl>   |-general_log_print()        ← 打印日志&#34;Got shutdown command for&#34;
</span></span><span class=line><span class=cl>   |-kill_mysql()
</span></span><span class=line><span class=cl>     |-pthread_kill()           ← 向signal_thread发送SIGTERM信号
</span></span></code></pre></div><p>也就是说，实际上还是通过用户线程向服务发送 <code>SIGTERM</code> 信号完成。</p><a class=anchor id=sigterm></a><h2>sigterm <a href=#sigterm aria-hidden=true>#</a></h2><p>如上，两种方式最终的实现都是通过发送 <code>SIGTERM</code> 信号完成的，那么我们接下来就看看 mysqld 服务是如何处理该信号量的。</p><a class=anchor id=初始化></a><h3>初始化 <a href=#%e5%88%9d%e5%a7%8b%e5%8c%96 aria-hidden=true>#</a></h3><p>其中部分信号，如 <code>SIGABRT</code>、<code>SIGSEGV</code> 等会在 <code>my_init_signals()</code> 函数中进行初始化信号处理函数，而 <code>SIGTERM</code>、<code>SIGQUIT</code>、<code>SIGHUP</code> 则会在单独的线程中进行处理，对应 <code>signal_hand()</code> 函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mysqld_main()
</span></span><span class=line><span class=cl> |-my_init_signals()               ← 设置信号处理函数
</span></span><span class=line><span class=cl> |-start_signal_handler()          ← 创建一个单独的信号处理线程
</span></span><span class=line><span class=cl>   |-mysql_thread_create()         ← 创建signal_hand()单独线程
</span></span></code></pre></div><a class=anchor id=信号处理></a><h3>信号处理 <a href=#%e4%bf%a1%e5%8f%b7%e5%a4%84%e7%90%86 aria-hidden=true>#</a></h3><p>接下来看看 <code>signal_hand()</code> 函数中的处理方式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>signal_hand()
</span></span><span class=line><span class=cl> |-abort_loop=true                 ← 设置abort_loop变量，很多循环会检查该变量
</span></span><span class=line><span class=cl> |-pthread_kill()                  ← 先主线程发送SIGUSR1信号
</span></span><span class=line><span class=cl> |-close_connections()             ← 关闭所有链接
</span></span></code></pre></div><p>实际上，在主线程中对 <code>SIGUSR1</code> 信号并没有进行处理，应该只是一个线程切换；接下来，还是看看主线程的处理：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mysqld_main()
</span></span><span class=line><span class=cl> |-my_thread_join()                ← 等待上述的signal_hand()处理线程
</span></span><span class=line><span class=cl> |-clean_up()
</span></span><span class=line><span class=cl>   |-plugin_shutdown()
</span></span><span class=line><span class=cl>     |-plugin_deinitialize()
</span></span><span class=line><span class=cl>       |-ha_finalize_handlerton()
</span></span><span class=line><span class=cl>         |-hton-&gt;panic()           ← 调用插件的关闭函数
</span></span></code></pre></div><p>也就是会依次调用各个存储引擎的 <code>panic()</code> 函数，对应到 InnoDB 就是 <code>innobase_end()</code> 函数。</p><a class=anchor id=innodb-关闭过程></a><h1>InnoDB 关闭过程 <a href=#innodb-%e5%85%b3%e9%97%ad%e8%bf%87%e7%a8%8b aria-hidden=true>#</a></h1><p>在关闭 MySQL 时，可以通过 <code>innodb_fast_shutdown</code> 参数控制存储引擎 InnoDB 的行为，该参数可以取 0、1、2，各个值的含义分别如下：</p><ul><li><code>0</code> 关闭时 InnoDB 需要完成所有的 <code>full purge</code> 和 <code>merge insert buffer</code> 操作，这个过程会需要一定的时间，有时候可能会花上几个小时；通常在升级 InnoDB 时，需要设置为 0。</li><li><code>1</code> 默认值，关闭 InooDB 时不完成 <code>full purge</code> 和 <code>merge insert buffer</code>，但是会将缓冲池中的脏页写到磁盘中。</li><li><code>2</code> 意味着既不完成 <code>full purge</code> 和 <code>merge insert buffer</code>，同时也不将缓冲池中的脏页刷新到磁盘，但是会将 redo log 写入到磁盘；这种情况下，事务也不会丢失，但是下次启动时需要执行崩溃恢复。</li></ul><p>接着看看 InnoDB 关闭时的详细处理过程。</p><a class=anchor id=源码解析></a><h2>源码解析 <a href=#%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90 aria-hidden=true>#</a></h2><p>如下是代码的处理过程，其中 <code>logs_empty_and_mark_files_at_shutdown()</code> 函数是主要的关闭处理函数，在系统关闭时同时执行 sharp checkpoint 操作。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>innobase_end()
</span></span><span class=line><span class=cl> |-srv_fast_shutdown                           ← 根据参数innodb_fast_shutdown判断是否快速关闭
</span></span><span class=line><span class=cl> |-hash_table_free()                           ← 释放innodb表占用的内存
</span></span><span class=line><span class=cl> |-innobase_shutdown_for_mysql()
</span></span><span class=line><span class=cl> | |-fts_optimize_shutdown()
</span></span><span class=line><span class=cl> | |-dict_stats_shutdown()
</span></span><span class=line><span class=cl> | |-logs_empty_and_mark_files_at_shutdown()   ← 1.  将buffer pool落盘，并将LSN写入表空间，主要函数，后面均为资源清理
</span></span><span class=line><span class=cl> | | |-ib::info()                              ← 1.0 打印Starting shutdown日志 &lt;&lt;&lt;&lt;&lt;&lt;
</span></span><span class=line><span class=cl> | | |-srt_shutdown_state                            设置变量，进入SRV_SHUTDOWN_CLEANUP状态
</span></span><span class=line><span class=cl> | | |
</span></span><span class=line><span class=cl> | | |-srv_any_background_threads_are_active() ← 1.1 等待后台线程关闭，没1min打印一次等待线程信息
</span></span><span class=line><span class=cl> | | |
</span></span><span class=line><span class=cl> | | |-trx_sys_any_active_transactions()       ← 1.2 如果事务已经在prepare阶段了，则等待其处理完成
</span></span><span class=line><span class=cl> | | |
</span></span><span class=line><span class=cl> | | |-srv_get_active_thread_type()            ← 1.3 等待worker、master、purge线程进入suspend状态
</span></span><span class=line><span class=cl> | | |
</span></span><span class=line><span class=cl> | | |-srt_shutdown_state                            设置变量，进入SRV_SHUTDOWN_FLUSH_PHASE状态
</span></span><span class=line><span class=cl> | | |-buf_page_cleaner_is_active              ← 1.4 正常此时只剩下了page_cleaner线程刷Buffer Pool了，等待其完成
</span></span><span class=line><span class=cl> | | |-buf_pool_check_no_pending_io()                检查IO操作是否都已经完成
</span></span><span class=line><span class=cl> | | |
</span></span><span class=line><span class=cl> | | |                                         ← 1.5 如果srv_fast_shutdown变量值为2
</span></span><span class=line><span class=cl> | | |-log_buffer_flush_to_disk()                    将redo-log刷新到磁盘
</span></span><span class=line><span class=cl> | | |-srv_any_background_threads_are_active()
</span></span><span class=line><span class=cl> | | |-fil_close_all_files()                         关闭文件，然后返回
</span></span><span class=line><span class=cl> | | |
</span></span><span class=line><span class=cl> | | |-log_make_checkpoint_at()                ← 1.6 将最近LSN做checkpoint
</span></span><span class=line><span class=cl> | | |-fil_flush_file_spaces()                       将表空间文件和日志文件刷新到磁盘
</span></span><span class=line><span class=cl> | | |-srt_shutdown_state                            设置变量，进入SRV_SHUTDOWN_LAST_PHASE状态
</span></span><span class=line><span class=cl> | | |-srv_get_active_thread_type()                  再次确认所有服务已经关闭
</span></span><span class=line><span class=cl> | | |
</span></span><span class=line><span class=cl> | | |-fil_write_flushed_lsn()                 ← 1.7 将LSN写入到系统表空间的第一页中
</span></span><span class=line><span class=cl> | | |-fil_close_all_files()                         关闭所有文件
</span></span><span class=line><span class=cl> | |
</span></span><span class=line><span class=cl> | |-srv_conc_get_active_threads()             ← 正常应该无活跃的线程，有则打印到日志
</span></span><span class=line><span class=cl> | |
</span></span><span class=line><span class=cl> | |                                           ← 2. 接下来是一些资源的清理
</span></span><span class=line><span class=cl> | |-srv_shutdown_all_bg_threads()                  关闭InnoDB创建的后台线程
</span></span><span class=line><span class=cl> | |-fclose()                                       关闭InnoDB打开的文件
</span></span><span class=line><span class=cl> | |-dict_stats_thread_deinit()
</span></span><span class=line><span class=cl> | |                                                释放mutexes，释放内存
</span></span><span class=line><span class=cl> | |-os_thread_free()                               释放线程相关的资源
</span></span><span class=line><span class=cl> | |-sync_check_close()                             释放同步相关资源
</span></span><span class=line><span class=cl> |
</span></span><span class=line><span class=cl> |-innobase_space_shutdown()
</span></span></code></pre></div><p>实际上，Buffer Pool 中脏页刷到磁盘的操作是最耗时的，脏页越多需要 flush 的块也就越多，从而导致关闭时间变长；可以通过下面的命令来观察 Dirty Page 的数量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ mysqladmin -uroot ext -i 1 | grep &#34;Innodb_buffer_pool_pages_dirty&#34;
</span></span></code></pre></div><a class=anchor id=faqs></a><h2>FAQs <a href=#faqs aria-hidden=true>#</a></h2><a class=anchor id=1-如何查看-innodb-在等待那些线程></a><h5>1. 如何查看 InnoDB 在等待那些线程？ <a href=#1-%e5%a6%82%e4%bd%95%e6%9f%a5%e7%9c%8b-innodb-%e5%9c%a8%e7%ad%89%e5%be%85%e9%82%a3%e4%ba%9b%e7%ba%bf%e7%a8%8b aria-hidden=true>#</a></h5><p>InnoDB 在关闭时，会每隔 100ms 检查一次后台线程是否已经全部退出，具体检查那些线程可以查看 <code>srv_any_background_threads_are_active()</code> 函数；等待超过了 1min ，则会打印日志 &ldquo;Waiting for&rdquo; 。</p><a class=anchor id=2-为什么要等待出于-prepare-阶段的事务></a><h5>2. 为什么要等待出于 prepare 阶段的事务？ <a href=#2-%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e7%ad%89%e5%be%85%e5%87%ba%e4%ba%8e-prepare-%e9%98%b6%e6%ae%b5%e7%9a%84%e4%ba%8b%e5%8a%a1 aria-hidden=true>#</a></h5><p>如果事务处于 prepare 阶段，说明已经在 InnoDB 执行了 commit 操作，也就是在存储引擎中认为已经提交，只需要服务端提交即可，显然，我们不希望丢失这部分数据。</p><p>实际上，接下来的操作不会再与客户端进行交互，都是服务端的执行流程了，正常来说执行的时间会非常短。</p><a class=anchor id=参考></a><h1>参考 <a href=#%e5%8f%82%e8%80%83 aria-hidden=true>#</a></h1><p><a href=https://dev.mysql.com/doc/refman/en/server-shutdown.html>Reference Manual - The Server Shutdown Process</a></p></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#mysqladmin>mysqladmin</a></li><li><a href=#sigterm>sigterm</a></li></ul></li><li><a href=#innodb-关闭过程>InnoDB 关闭过程</a><ul><li><a href=#源码解析>源码解析</a></li><li><a href=#faqs>FAQs</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>