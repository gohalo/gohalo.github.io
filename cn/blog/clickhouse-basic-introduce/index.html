<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>ClickHouse 使用详解 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>ClickHouse 使用详解</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2023-09-29</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/database/ role=button>database</a></div></div><hr><div class=content><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><a class=anchor id=安装部署></a><h1>安装部署 <a href=#%e5%ae%89%e8%a3%85%e9%83%a8%e7%bd%b2 aria-hidden=true>#</a></h1><p>以 RPM 包为例，可以从 <a href=https://packages.clickhouse.com/rpm/stable/>Package ClickHouse</a> 下载关键的包，通常是 <code>clickhouse-server</code> <code>clickhouse-common-static</code> <code>clickhouse-client</code> 就可以了。</p><p>安装后，会包含一个 <code>/usr/lib/systemd/system/clickhouse-server.service</code> 服务管理文件，默认与 <code>systemd</code> 相关的配置文件保存在 <code>/etc/clickhouse-server</code> 目录下，可以使用 <a href=/cn/blog/golang-some-third-tools/>goreman</a> 进行部署。</p><a class=anchor id=配置文件></a><h2>配置文件 <a href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-hidden=true>#</a></h2><p>其中系统的配置文件在 <code>/etc/clickhouse-server</code> 目录下，包括了默认 <code>config.xml</code> 系统配置，以及 <code>users.d/default-password.xml</code> 用户配置。用户有如下几种配置方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 明文密码
</span></span><span class=line><span class=cl>&lt;password&gt;HelloCK&lt;/password&gt;
</span></span><span class=line><span class=cl>----- 通过SHA256加密
</span></span><span class=line><span class=cl>echo -n HelloCK | openssl dgst -sha256
</span></span><span class=line><span class=cl>&lt;password_sha256_hex&gt;8757d5ea...&lt;/password_sha256_hex&gt;
</span></span><span class=line><span class=cl>----- 通过double_sha1加密
</span></span><span class=line><span class=cl>echo -n HelloCK | openssl dgst -shal -binary | openssl dgst -shal
</span></span><span class=line><span class=cl>&lt;password_double_sha1_hex&gt;60a5a877...&lt;/password_double_shal_hex&gt;
</span></span></code></pre></div><p>在线修改后无需重启，还可以修改监听地址 <code>&lt;listen_host></code> 配置，如果是 <code>::</code> 则支持 IPv4 和 IPv6，而 <code>0.0.0.0</code> 则只支持 IPv4。另外，异常可以查看 <code>/var/log/clickhouse-server/clickhouse-server.log</code> 日志。</p><a class=anchor id=启动服务></a><h2>启动服务 <a href=#%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1 aria-hidden=true>#</a></h2><p>后续可以直接通过 <code>systemd</code> 进行管理。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>----- 启动服务，会通过watchdog进程进行保活
</span></span><span class=line><span class=cl># systemctl start clickhouse-server
</span></span><span class=line><span class=cl>----- 建立连接，其中port对应服务配置中的tcp_port配置项
</span></span><span class=line><span class=cl>$ clickhouse-client --host=127.0.0.1 --port=9002 --user=default --password=&#39;YourPassword&#39;
</span></span></code></pre></div><p>在官方 <a href=https://clickhouse.com/docs/en/getting-started/example-datasets>Example Datasets</a> 包含了很多测试集，初始建议使用 <a href=https://clickhouse.com/docs/en/getting-started/example-datasets/uk-price-paid>UK Property Prices</a> 这个数据集，暂时没有找到 CSV 格式的列名映射，离线直接通过 <code>python3 -m http.server -d . 8080</code> 启动一个简单的静态服务器。</p><a class=anchor id=目录结构></a><h3>目录结构 <a href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 aria-hidden=true>#</a></h3><p>数据默认保存在 <code>/var/lib/clickhouse/data</code> 目录下，各个目录保存内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>data     真正数据保存目录，符号连接指向 store 目录
</span></span><span class=line><span class=cl>metadata 保存相关的建表语句，符号连接指向 store 目录
</span></span></code></pre></div><p>如果自定义了 <code>storage_configuration</code> 配置参数，那么会保存在 <code>disks</code> 目录下，某些版本里的符号连接有问题。</p><a class=anchor id=端口></a><h3>端口 <a href=#%e7%ab%af%e5%8f%a3 aria-hidden=true>#</a></h3><p>会启动如下几个端口：</p><ul><li><code>8123</code> HTTP 协议，包括 <code>/dashboard</code> 图形界面等。</li></ul><a class=anchor id=keeper></a><h2>Keeper <a href=#keeper aria-hidden=true>#</a></h2><p>这里的配置文件很简单，可以在 CK 的进程内嵌入式部署，而且分成了 Shared 是否共享，也可以独立部署。其配置项比较简单，可以参考 <a href=https://clickhouse.com/docs/en/operations/clickhouse-keeper>Keeper</a> 中的介绍。</p><p>CK 依赖 ZK 主要是为了解决两个场景：A) 分布式 DDL 执行；B) 复制表的节点间同步，包括了写入、Merge、Mutation 等。</p><p>另外，关于 ZK 的部署可以参考 <a href=/cn/blog/zookeeper-basic-introduce/>ZooKeeper 基本介绍</a> 内容。</p><a class=anchor id=使用技巧></a><h1>使用技巧 <a href=#%e4%bd%bf%e7%94%a8%e6%8a%80%e5%b7%a7 aria-hidden=true>#</a></h1><a class=anchor id=变量></a><h2>变量 <a href=#%e5%8f%98%e9%87%8f aria-hidden=true>#</a></h2><p>在内部表 <code>system.settings</code> 保存了相关的配置参数，可以通过 <code>SET send_logs_level='trace'</code> 类似方式设置，并通过 <code>SHOW SETTINGS LIKE 'send_logs%'</code> 查看。</p><a class=anchor id=mergetree></a><h1>MergeTree <a href=#mergetree aria-hidden=true>#</a></h1><p>这应该是最复杂也最常用的引擎，包括了基于此的扩展引擎。</p><ul><li><code>Replacing</code> 唯一键特性，根据建表语句 <code>ReplacingMergeTree(xxx)</code> 中的 <code>xxx</code> 版本信息删除重复数据，不指定则保存最后一行。</li><li><code>Summing</code> 在合并时会指定的字段进行累加，如果不指定则聚合所有的非排序键。</li><li><code>Aggregating</code> 通过预聚合提升读取性能，建表时针对列指定聚合函数。</li><li><code>Collapsing</code> 支持行级别的数据修改和删除，会先以新增方式保存数据，在合并过程中实际修改数据。</li><li><code>VersionedCollapsing</code> 同上，区别是通过版本修改。</li><li><code>Graphite</code> 时序数据的兼容实现。</li></ul><p>建表时，可以通过 <code>ORDER BY</code> 和 <code>PRIMARY KEY</code> 指定排序键和主键，大部分场景只需要 <code>ORDER BY</code> 即可，而在 <code>Summing</code> 和 <code>Aggregating</code> 聚合场景中可以指定不同的值，不过要求 <code>PRIMARY KEY</code> 必须是 <code>ORDER BY</code> 的前缀列。</p><p>将颗粒 (granule) 作为并行的最小单位，在 DDL 中通过 <code>index_granularity</code> 参数指定，默认是 <code>8192=8x1024</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>primary.idx    主键索引，一个未压缩的扁平数据结构
</span></span><span class=line><span class=cl>col.mrk        每个颗粒在数据文件中的偏移，包括了压缩和非压缩数据
</span></span></code></pre></div><a class=anchor id=索引></a><h2>索引 <a href=#%e7%b4%a2%e5%bc%95 aria-hidden=true>#</a></h2><p>与 TP 类似 AP 也会存在主键索引，当查询命中主键时最快，但有些场景可能无法命中，对于 TP 来说会引入二级索引，但 AP 通常是列存，无法直接映射到具体的行，所以，在 ClickHouse 中引入了跳数索引。</p><a class=anchor id=分布式></a><h1>分布式 <a href=#%e5%88%86%e5%b8%83%e5%bc%8f aria-hidden=true>#</a></h1><p>原本的 CK 是单机引擎，因为高可用就有了 <code>Replicate</code> 复制到多个机器上，而为了便于查询则有了分布式引擎。支持多主写入，其处理逻辑相同，通过基于 ZK 实现日志复制，包括了主副本选举、副本状态感知、操作日志分发、任务队列、Block 去重等。</p><a class=anchor id=目录结构-1></a><h2>目录结构 <a href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84-1 aria-hidden=true>#</a></h2><p>这里主要是 ZK 的元数据组织结构，通常以 <code>/clickhouse/tables/{shard}/table_name</code> 作为表级别的路径。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>metadata   元数据，包括主键、分区键等
</span></span><span class=line><span class=cl>columns    列信息，含名称、数据类型
</span></span><span class=line><span class=cl>replicas/                            副本信息，在建表时指定，各副本执行本地任务会使用
</span></span><span class=line><span class=cl>replicas/{replica}/log_pointer       日志复制的偏移
</span></span><span class=line><span class=cl>replicas/{replica}/mutation_pointer  Mutation 指针
</span></span><span class=line><span class=cl>replicas/{replica}/queue             执行过程以队列方式实现，用于顺序执行
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>leader_election/  用于副本的选举，会主导 Merge Mutation 操作，主完成后复制到其它副本
</span></span><span class=line><span class=cl>blocks/           块Hash信息，与log对应，用于block去重
</span></span><span class=line><span class=cl>block_numbers/
</span></span><span class=line><span class=cl>quorum/           超过 quorum 指定数量之后整个写入才算成功
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>log/                核心操作日志 (Insert Merge Drop)，日志顺序递增
</span></span><span class=line><span class=cl>log/log-0000000001  保存了创建时间、源、BlockID 等信息
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mutations/  与 log 类似，对应 Alter Delete/Update 操作
</span></span></code></pre></div><a class=anchor id=ddl></a><h2>DDL <a href=#ddl aria-hidden=true>#</a></h2><p>分布式 DDL 实现依赖 ZooKeeper 组件，在 <code>/clickhouse/task_queue/ddl/{task}</code> 中同时包含了 <code>active</code> 和 <code>finished</code> 两个节点，用来保存未完成和已完成的任务，相关的配置如下，任务执行可以查看 <code>system.distributed_ddl_queue</code> 系统表。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;distributed_ddl&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;path&gt;</span>/clickhouse/task_queue/ddl<span class=nt>&lt;/path&gt;</span>         // ZK中的保存路径
</span></span><span class=line><span class=cl>    <span class=nt>&lt;max_tasks_in_queue&gt;</span>3<span class=nt>&lt;/max_tasks_in_queue&gt;</span>      // 队列中的最大任务数
</span></span><span class=line><span class=cl>    <span class=nt>&lt;cleanup_delay_period&gt;</span>60<span class=nt>&lt;/cleanup_delay_period&gt;</span> // 检查 DDL 记录清理间隔
</span></span><span class=line><span class=cl>    <span class=nt>&lt;task_max_lifetime&gt;</span>604800<span class=nt>&lt;/task_max_lifetime&gt;</span>   // 已完成节点的最大存活时间
</span></span><span class=line><span class=cl><span class=nt>&lt;/distributed_ddl&gt;</span>
</span></span></code></pre></div><p>注意，当超过了队列长度之后，并不会抛出异常。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ASTQueryWithOnCluster 分布式 SQL 父类，对应 ON CLUSTER 语句
</span></span><span class=line><span class=cl> |
</span></span></code></pre></div><a class=anchor id=常见操作></a><h2>常见操作 <a href=#%e5%b8%b8%e8%a7%81%e6%93%8d%e4%bd%9c aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>------ 查看集群信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>cluster</span><span class=p>,</span><span class=w> </span><span class=n>shard_num</span><span class=p>,</span><span class=w> </span><span class=n>replica_num</span><span class=p>,</span><span class=w> </span><span class=n>host_name</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>is_local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>system</span><span class=p>.</span><span class=n>clusters</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>TCPHandler</span><span class=p>::</span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=err>通过</span><span class=w> </span><span class=n>POCO</span><span class=w> </span><span class=err>库建立</span><span class=w> </span><span class=n>Server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>TCPHandler</span><span class=p>.</span><span class=nf>runImpl</span><span class=p>()[</span><span class=n>Server</span><span class=o>/</span><span class=n>TCPHandler</span><span class=p>.</span><span class=n>cpp</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>TCPHandler</span><span class=p>::</span><span class=nf>receiveHello</span><span class=p>()</span><span class=o>/</span><span class=nf>sendHello</span><span class=p>()</span><span class=w> </span><span class=err>会有个初始化的交互</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>TCPHandler</span><span class=p>::</span><span class=nf>receivePacket</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=n>STEP</span><span class=c1>#1&gt; 接收报文，建立连接握手成功后，会在一个循环里处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>   </span><span class=o>|-</span><span class=n>DB</span><span class=p>::</span><span class=nf>executeQuery</span><span class=p>()</span><span class=w> </span><span class=p>[</span><span class=n>Interpreters</span><span class=o>/</span><span class=n>executeQuery</span><span class=p>.</span><span class=n>cpp</span><span class=p>]</span><span class=w> </span><span class=err>开始处理请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>DB</span><span class=p>::</span><span class=nf>executeQueryImpl</span><span class=p>()</span><span class=w> </span><span class=err>真正执行，包括解析生成</span><span class=n>AST</span><span class=err>、重写等，通过</span><span class=w> </span><span class=n>Interpreter</span><span class=w> </span><span class=err>构建</span><span class=w> </span><span class=n>Pipeline</span><span class=err>，返回</span><span class=n>AST</span><span class=err>和解析后的结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>DB</span><span class=p>::</span><span class=nf>parseQuery</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=n>STEP</span><span class=c1>#2&gt; 解析语句生成AST，支持不同的协议的解析
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>InterpreterFactory</span><span class=p>::</span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=n>STEP</span><span class=c1>#3&gt; 创建执行的流水线，根据上述的AST创建对应的 Interpreter(解释器)，这里会根据不同的 SQL 类型构建对应的对象，一般是通过 make_unique 创建
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=nf>InterpreterSelectQuery</span><span class=p>()</span><span class=w> </span><span class=err>最基础的构造函数实现很复杂，详见与之对应的文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=nf>checkStackSize</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>InterpreterSelectQuery</span><span class=p>::</span><span class=nf>initSettings</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=nf>RewriteCountDistinctFunctionVisitor</span><span class=p>()</span><span class=w> </span><span class=err>开启了</span><span class=w> </span><span class=n>count_distinct_optimization</span><span class=w> </span><span class=err>参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=nf>RewriteUniqToCountVisitor</span><span class=p>()</span><span class=w> </span><span class=err>开启了</span><span class=w> </span><span class=n>optimize_uniq_to_count</span><span class=w> </span><span class=err>参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>InterpreterSelectQuery</span><span class=p>.</span><span class=k>analyze</span><span class=p>()</span><span class=w> </span><span class=err>这里实际上是一个闭包实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>TreeRewriter</span><span class=p>::</span><span class=nf>analyzeSelect</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>TreeRewriter</span><span class=p>::</span><span class=nf>renameDuplicatedColumns</span><span class=p>()</span><span class=w> </span><span class=err>对一些别名等进行重命名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>TreeRewriter</span><span class=p>::</span><span class=nf>translateQualifiedNames</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>TreeRewriter</span><span class=p>::</span><span class=nf>removeUnneededColumnsFromSelectClause</span><span class=p>()</span><span class=w> </span><span class=err>消除</span><span class=n>select</span><span class=err>子句后的冗余列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>TreeRewriter</span><span class=p>::</span><span class=nf>executeScalarSubqueries</span><span class=p>()</span><span class=w> </span><span class=err>执行标量子查询，并且用常量替代子查询结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>InterpreterSelectQuery</span><span class=p>::</span><span class=nf>getSampleBlockImpl</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=n>MergeTreeData</span><span class=p>::</span><span class=nf>getQueryProcessingStage</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>         </span><span class=o>|-</span><span class=n>MergeTreeData</span><span class=p>::</span><span class=nf>getQueryProcessingStageWithAggregateProjection</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>           </span><span class=o>|-</span><span class=nf>selectBestProjection</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>             </span><span class=o>|-</span><span class=n>MergeTreeDataSelectExecutor</span><span class=p>::</span><span class=nf>estimateNumMarksToRead</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>               </span><span class=o>|-</span><span class=n>ReadFromMergeTree</span><span class=p>::</span><span class=nf>selectRangesToRead</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>                 </span><span class=o>|-</span><span class=n>ReadFromMergeTree</span><span class=p>::</span><span class=nf>selectRangesToReadImpl</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>                   </span><span class=o>|-</span><span class=n>MergeTreeDataSelectExecutor</span><span class=p>::</span><span class=nf>filterPartsByPrimaryKeyAndSkipIndexes</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|&gt;&gt;&gt;</span><span class=p>.</span><span class=nf>execute</span><span class=p>()</span><span class=w> </span><span class=err>根据不同的语法开始执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|===</span><span class=n>InterpreterSelectQuery</span><span class=p>::</span><span class=nf>execute</span><span class=p>()</span><span class=w> </span><span class=err>构建查询计划</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>InterpreterSelectQuery</span><span class=p>::</span><span class=nf>buildQueryPlan</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>InterpreterSelectQuery</span><span class=p>::</span><span class=nf>executeImpl</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>InterpreterSelectQuery</span><span class=p>::</span><span class=nf>executeFetchColumns</span><span class=p>()</span><span class=w> </span><span class=err>从存储读取数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>IStorage</span><span class=p>::</span><span class=k>read</span><span class=p>()</span><span class=w> </span><span class=err>开始读取，会调用具体的实现，可以查看</span><span class=w> </span><span class=n>public</span><span class=w> </span><span class=n>IStorage</span><span class=w> </span><span class=err>的实现类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>StorageMergeTree</span><span class=p>::</span><span class=k>read</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>MergeTreeDataSelectExecutor</span><span class=p>::</span><span class=k>read</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>MergeTreeDataSelectExecutor</span><span class=p>::</span><span class=nf>readFromParts</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=n>new</span><span class=w> </span><span class=nf>ReadFromMergeTree</span><span class=p>()</span><span class=w> </span><span class=err>通过</span><span class=w> </span><span class=n>make_unique</span><span class=w> </span><span class=err>创建，后续通过</span><span class=w> </span><span class=n>InterpreterSelectWithUnionQuery</span><span class=p>.</span><span class=nf>execute</span><span class=p>()</span><span class=w> </span><span class=err>触发</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>InterpreterSelectQuery</span><span class=p>::</span><span class=nf>executeWhere</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>InterpreterSelectQuery</span><span class=p>::</span><span class=nf>executeAggregation</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>InterpreterSelectQuery</span><span class=p>::</span><span class=nf>executeDistinct</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>QueryPlan</span><span class=p>::</span><span class=nf>buildQueryPipeline</span><span class=p>()</span><span class=w> </span><span class=err>构建</span><span class=w> </span><span class=n>QueryPipeline</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|===</span><span class=n>InterpreterSelectWithUnionQuery</span><span class=p>::</span><span class=nf>execute</span><span class=p>()</span><span class=w> </span><span class=err>构建查询计划</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>InterpreterSelectWithUnionQuery</span><span class=p>::</span><span class=nf>buildQueryPlan</span><span class=p>()</span><span class=w> </span><span class=err>构建查询计划</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>QueryPlan</span><span class=p>::</span><span class=nf>buildQueryPipeline</span><span class=p>()</span><span class=w> </span><span class=err>构建</span><span class=w> </span><span class=n>QueryPipeline</span><span class=err>，以</span><span class=w> </span><span class=n>DFS</span><span class=w> </span><span class=err>方式遍历</span><span class=w> </span><span class=n>QueryPlan</span><span class=err>，会先调用叶子节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>QueryPlan</span><span class=p>::</span><span class=k>optimize</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>ITransformingStep</span><span class=p>::</span><span class=nf>updatePipeline</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>ExpressionStep</span><span class=p>::</span><span class=nf>transformPipeline</span><span class=p>()</span><span class=w> </span><span class=err>如果某个节点类型是</span><span class=w> </span><span class=n>ExpressionStep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=nf>ExpressionActions</span><span class=p>()</span><span class=w> </span><span class=err>以</span><span class=w> </span><span class=n>make_shared</span><span class=w> </span><span class=err>方式构建对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>ActionsDAG</span><span class=p>::</span><span class=nf>compileExpressions</span><span class=p>()</span><span class=w> </span><span class=err>这里需要开启</span><span class=w> </span><span class=n>USE_EMBEDDED_COMPILER</span><span class=w> </span><span class=err>宏</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=n>ActionsDAG</span><span class=p>::</span><span class=nf>compileFunctions</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>ExpressionJIT</span><span class=p>::</span><span class=nf>getCompilableDAG</span><span class=p>()</span><span class=w> </span><span class=err>获取类型为</span><span class=w> </span><span class=n>CompileDAG</span><span class=w> </span><span class=err>的对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>ExpressionJIT</span><span class=p>::</span><span class=nf>compile</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=nf>LLVMFunction</span><span class=p>()</span><span class=w> </span><span class=err>同样会通过</span><span class=w> </span><span class=n>make_shared</span><span class=w> </span><span class=err>创建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=nf>compileFunction</span><span class=p>(</span><span class=n>CHJIT</span><span class=p>,</span><span class=w> </span><span class=n>const</span><span class=w> </span><span class=n>IFunctionBase</span><span class=p>)</span><span class=w> </span><span class=err>实现详见</span><span class=n>JIT</span><span class=o>/</span><span class=n>compileFunction</span><span class=p>.</span><span class=n>cpp</span><span class=err>代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>CHJIT</span><span class=p>::</span><span class=nf>compileModule</span><span class=p>(</span><span class=n>std</span><span class=p>::</span><span class=n>function</span><span class=p>)</span><span class=w> </span><span class=err>这里传入的是函数，负责将</span><span class=n>Module</span><span class=err>编译成机器码，并建立一个函数名称与函数地址的映射关系</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=n>CHJIT</span><span class=p>::</span><span class=nf>createModuleForCompilation</span><span class=p>()</span><span class=w> </span><span class=err>创建</span><span class=w> </span><span class=n>llvm</span><span class=p>::</span><span class=n>Module</span><span class=w> </span><span class=err>对象并配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=n>CHJIT</span><span class=p>::</span><span class=nf>compileFunction</span><span class=p>(</span><span class=n>llvm</span><span class=p>::</span><span class=n>Module</span><span class=p>,</span><span class=w> </span><span class=n>const</span><span class=w> </span><span class=n>IFunctionBase</span><span class=p>)</span><span class=w> </span><span class=err>调用入参指定的函数，生成</span><span class=w> </span><span class=n>IR</span><span class=w> </span><span class=err>的具体函数在</span><span class=w> </span><span class=n>src</span><span class=o>/</span><span class=n>Interpreters</span><span class=o>/</span><span class=n>JIT</span><span class=o>/</span><span class=n>compileFunction</span><span class=p>.</span><span class=n>cpp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=o>|&gt;&gt;&gt;</span><span class=n>IFunctionBase</span><span class=p>::</span><span class=nf>compile</span><span class=p>()</span><span class=w> </span><span class=err>这里会调用该函数，只有</span><span class=w> </span><span class=n>LLVMFunction</span><span class=w> </span><span class=err>实现了该方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=o>|===</span><span class=n>LLVMFunction</span><span class=p>::</span><span class=nf>compile</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>CompileDAG</span><span class=p>::</span><span class=nf>compile</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>     </span><span class=o>|&gt;&gt;&gt;</span><span class=n>IFunctionBase</span><span class=p>::</span><span class=nf>compile</span><span class=p>()</span><span class=w> </span><span class=err>如果是</span><span class=w> </span><span class=n>CompileType</span><span class=p>::</span><span class=n>FUNCTION</span><span class=w> </span><span class=err>类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>     </span><span class=o>|===</span><span class=n>IFunction</span><span class=p>::</span><span class=nf>compile</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=n>FunctionBinaryArithmetic</span><span class=p>::</span><span class=nf>compileImpl</span><span class=p>()</span><span class=w> </span><span class=err>这里会调用操作符的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>         </span><span class=o>|-</span><span class=n>PlusImpl</span><span class=p>::</span><span class=nf>compile</span><span class=p>()</span><span class=w> </span><span class=err>这里是</span><span class=w> </span><span class=n>plus</span><span class=w> </span><span class=err>方法，这里最终调用的就是</span><span class=n>LLVM</span><span class=err>提供的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=n>CHJIT</span><span class=p>::</span><span class=nf>compileModule</span><span class=p>(</span><span class=n>llvm</span><span class=p>::</span><span class=n>Module</span><span class=p>)</span><span class=w> </span><span class=err>在</span><span class=w> </span><span class=n>llvm</span><span class=p>::</span><span class=n>Module</span><span class=w> </span><span class=err>基础上封装出</span><span class=w> </span><span class=n>CompiledModule</span><span class=w> </span><span class=err>模块，便于函数调用完成后生成的代码相关内存析构</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>         </span><span class=o>|-</span><span class=n>CHJIT</span><span class=p>::</span><span class=nf>runOptimizationPassesOnModule</span><span class=p>()</span><span class=w> </span><span class=err>设置默认的编译参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>         </span><span class=o>|-</span><span class=n>JITCompiler</span><span class=p>::</span><span class=nf>compile</span><span class=p>()</span><span class=w> </span><span class=err>代码生成，结果保存在</span><span class=w> </span><span class=n>llvm</span><span class=p>::</span><span class=n>MemoryBuffer</span><span class=w> </span><span class=err>中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|</span><span class=w>           </span><span class=o>|-</span><span class=n>llvm</span><span class=p>::</span><span class=n>legacy</span><span class=p>::</span><span class=n>PassManager</span><span class=p>::</span><span class=nf>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=n>ActionsDAG</span><span class=p>::</span><span class=nf>removeUnusedActions</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>ISourceStep</span><span class=p>::</span><span class=nf>updatePipeline</span><span class=p>()</span><span class=w> </span><span class=err>这里就是数据源了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>ReadFromMergeTree</span><span class=p>.</span><span class=nf>initializePipeline</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>Pipe</span><span class=p>.</span><span class=nf>addSimpleTransform</span><span class=p>()</span><span class=w> </span><span class=err>这里会在匿名函数中通过</span><span class=n>make_shared</span><span class=err>创建如下对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=nf>ExpressionTransform</span><span class=p>()</span><span class=w> </span><span class=err>当执行</span><span class=w> </span><span class=n>a</span><span class=o>+</span><span class=n>b</span><span class=o>*</span><span class=n>c</span><span class=o>+</span><span class=mi>5</span><span class=w> </span><span class=err>类似的表达式时，在物理查询计划中就是该步骤，会在初始化列表中调用如下函数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=o>|-</span><span class=n>ExpressionTransform</span><span class=p>::</span><span class=nf>transformHeader</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>           </span><span class=o>|-</span><span class=n>ActionsDAG</span><span class=p>::</span><span class=nf>updateHeader</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>             </span><span class=o>|-</span><span class=n>ActionsDAG</span><span class=p>::</span><span class=nf>executeActionForHeader</span><span class=p>()</span><span class=w> </span><span class=err>这里是个函数类型会调用如下方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>               </span><span class=o>|-</span><span class=n>IExecutableFunction</span><span class=p>::</span><span class=nf>execute</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>                 </span><span class=o>|-</span><span class=n>IExecutableFunction</span><span class=p>::</span><span class=nf>executeWithoutSparseColumns</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>                   </span><span class=o>|-</span><span class=n>IExecutableFunction</span><span class=p>::</span><span class=nf>executeWithoutLowCardinalityColumns</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>                     </span><span class=o>|-</span><span class=n>IExecutableFunction</span><span class=p>::</span><span class=nf>executeImpl</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|</span><span class=w>                       </span><span class=o>|-</span><span class=n>LLVMExecutableFunction</span><span class=p>::</span><span class=nf>executeImpl</span><span class=p>()</span><span class=w> </span><span class=err>这里会执行生成的代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>QueryPipelineBuilder</span><span class=p>::</span><span class=nf>getPipeline</span><span class=p>()</span><span class=w> </span><span class=err>最后生成</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|===</span><span class=n>InterpreterInsertQuery</span><span class=p>.</span><span class=nf>execute</span><span class=p>()[</span><span class=n>Interpreters</span><span class=o>/</span><span class=n>InterpreterInsertQuery</span><span class=p>.</span><span class=n>cpp</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>InterpreterInsertQuery</span><span class=p>.</span><span class=nf>getTable</span><span class=p>()</span><span class=w> </span><span class=err>会从</span><span class=w> </span><span class=n>DB</span><span class=w> </span><span class=err>缓存对象中获取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>InterpreterInsertQuery</span><span class=p>.</span><span class=nf>buildInsertSelectPipeline</span><span class=p>()</span><span class=w> </span><span class=err>采用</span><span class=w> </span><span class=k>INSERT</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=err>方式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>InterpreterInsertQuery</span><span class=p>.</span><span class=nf>buildInsertPipeline</span><span class=p>()</span><span class=w> </span><span class=err>只使用</span><span class=w> </span><span class=k>INSERT</span><span class=w> </span><span class=err>这里仅解析该路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>       </span><span class=o>|-</span><span class=n>InterpreterInsertQuery</span><span class=p>.</span><span class=nf>buildPreAndSinkChains</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>         </span><span class=o>|-</span><span class=n>InterpreterInsertQuery</span><span class=p>.</span><span class=nf>buildSink</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>           </span><span class=o>|&gt;&gt;&gt;</span><span class=n>Storage</span><span class=p>.</span><span class=k>write</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>           </span><span class=o>|===</span><span class=n>StorageMergeTree</span><span class=p>.</span><span class=k>write</span><span class=p>()</span><span class=w> </span><span class=err>新建</span><span class=w> </span><span class=n>MergeTreeSink</span><span class=w> </span><span class=err>对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|</span><span class=w>           </span><span class=o>|-</span><span class=n>InterpreterInsertQuery</span><span class=p>.</span><span class=nf>buildPushingToViewsChain</span><span class=p>()</span><span class=w> </span><span class=err>物化视图处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>TCPHandler</span><span class=p>::</span><span class=nf>processInsertQuery</span><span class=p>()</span><span class=w> </span><span class=err>处理</span><span class=w> </span><span class=k>Insert</span><span class=w> </span><span class=err>请求结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>TCPHandler</span><span class=p>::</span><span class=nf>processOrdinaryQueryWithProcessors</span><span class=p>()</span><span class=w> </span><span class=err>处理普通的并发查询执行结果</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|-</span><span class=n>QueryPipeline</span><span class=p>::</span><span class=nf>getHeader</span><span class=p>()</span><span class=w> </span><span class=err>先发送头信息给客户端</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|-</span><span class=n>PullingAsyncPipelineExecutor</span><span class=p>::</span><span class=nf>pull</span><span class=p>()</span><span class=w> </span><span class=err>循环获取数据发送给客户端</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Server</span><span class=p>::</span><span class=nf>main</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=nf>registerStorages</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=nf>registerStorageMerge</span><span class=p>()</span><span class=w> </span><span class=err>会返回</span><span class=w> </span><span class=n>StorageMerge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|-</span><span class=n>registerStorageMergeTree</span><span class=p>::</span><span class=k>create</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>作为列式数据库，以</span><span class=w> </span><span class=n>Block</span><span class=w> </span><span class=err>为单位读取数据，包括了</span><span class=w> </span><span class=o>`</span><span class=n>IBlockOutputStream</span><span class=o>`</span><span class=w> </span><span class=err>和</span><span class=w> </span><span class=o>`</span><span class=n>IBlockInputStream</span><span class=o>`</span><span class=w> </span><span class=err>分别负责写入和读取。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>zhuanlan</span><span class=p>.</span><span class=n>zhihu</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>p</span><span class=o>/</span><span class=mi>590261481</span><span class=w>  </span><span class=n>ClickHouse</span><span class=err>分布式</span><span class=n>DDL</span><span class=err>执行原理分析</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>executeDDLQueryOnCluster</span><span class=p>()</span><span class=w> </span><span class=err>执行分布式</span><span class=w> </span><span class=n>DDL</span><span class=w> </span><span class=err>语句</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>DDLWorker</span><span class=p>::</span><span class=nf>enqueueQuery</span><span class=p>()</span><span class=w> </span><span class=err>将变更信息添加到</span><span class=w> </span><span class=n>ZK</span><span class=w> </span><span class=err>中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=nf>getDistributedDDLStatus</span><span class=p>()</span><span class=w> </span><span class=err>监控执行情况，应该是通过</span><span class=w> </span><span class=n>DDLQueryStatusSource</span><span class=w> </span><span class=err>实现，不过每搞懂</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DDLWorker</span><span class=p>::</span><span class=nf>runMainThread</span><span class=p>()</span><span class=w> </span><span class=err>获取任务信息并执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>DDLWorker</span><span class=p>::</span><span class=nf>processTask</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>DDLWorker</span><span class=p>::</span><span class=nf>taskShouldBeExecutedOnLeader</span><span class=p>()</span><span class=w> </span><span class=err>是否需要在</span><span class=w> </span><span class=n>Leader</span><span class=w> </span><span class=err>上运行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>DDLWorker</span><span class=p>::</span><span class=nf>tryExecuteQueryOnLeaderReplica</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>DDLWorker</span><span class=p>::</span><span class=nf>tryExecuteQuery</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|-</span><span class=nf>executeQuery</span><span class=p>()</span><span class=w> </span><span class=err>开始真正执行，此时就是非分布式</span><span class=w> </span><span class=n>DDL</span><span class=w> </span><span class=err>操作了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ReplicatedMergeTreeSinkImpl</span><span class=p>::</span><span class=nf>consume</span><span class=p>()</span><span class=w> </span><span class=err>复制表实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeData</span><span class=p>::</span><span class=nf>delayInsertOrThrowIfNeeded</span><span class=p>()</span><span class=w> </span><span class=err>当写入</span><span class=w> </span><span class=n>Block</span><span class=w> </span><span class=err>过多时会延迟写入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>ReplicatedMergeTreeSinkImpl</span><span class=p>::</span><span class=nf>checkQuorumPrecondition</span><span class=p>()</span><span class=w> </span><span class=err>如果设定了</span><span class=w> </span><span class=n>quorum</span><span class=w> </span><span class=err>提交，会进行一系列检查</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeDataWriter</span><span class=p>::</span><span class=nf>splitBlockIntoParts</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeDataWriter</span><span class=p>::</span><span class=nf>writeTempPart</span><span class=p>()</span><span class=w> </span><span class=err>写入本地磁盘，包括计算</span><span class=w> </span><span class=n>Checksum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>ReplicatedMergeTreeSinkImpl</span><span class=p>::</span><span class=nf>finishDelayedChunk</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>ReplicatedMergeTreeSinkImpl</span><span class=p>::</span><span class=nf>commitPart</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|-</span><span class=nf>commit_new_part_stage</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>ReplicatedMergeTreeSinkImpl</span><span class=p>::</span><span class=nf>detectConflictInAsyncBlockIDs</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>allocateBlockNumber</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>getCommitPartOps</span><span class=p>()</span><span class=w> </span><span class=err>一般是</span><span class=w> </span><span class=n>GET</span><span class=w> </span><span class=err>请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeData</span><span class=p>::</span><span class=nf>renameTempPartAndAdd</span><span class=p>()</span><span class=w> </span><span class=err>将临时目录修改为正式目录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|-</span><span class=nf>resolve_duplicate_stage</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>StorageReplicatedMergeTree</span><span class=p>()</span><span class=w> </span><span class=err>构造函数中会启动相关的线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>queueUpdatingTask</span><span class=p>()</span><span class=w> </span><span class=err>定时拉取任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>ReplicatedMergeTreeQueue</span><span class=p>::</span><span class=nf>pullLogsToQueue</span><span class=p>()</span><span class=w> </span><span class=err>将任务保存在</span><span class=w> </span><span class=n>ZK</span><span class=w> </span><span class=err>的</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=err>队列中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>mutationsUpdatingTask</span><span class=p>()</span><span class=w> </span><span class=err>定时拉取任务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>BackgroundJobsAssignee</span><span class=p>::</span><span class=nf>threadFunc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|&gt;&gt;&gt;</span><span class=n>MergeTreeData</span><span class=p>::</span><span class=nf>scheduleDataProcessingJob</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|===</span><span class=n>StorageMergeTree</span><span class=p>::</span><span class=nf>scheduleDataProcessingJob</span><span class=p>()</span><span class=w> </span><span class=n>Merge</span><span class=w> </span><span class=err>合并</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|===</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>scheduleDataProcessingJob</span><span class=p>()</span><span class=w> </span><span class=err>同步主节点数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>processQueueEntry</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>executeLogEntry</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>executeDropRange</span><span class=p>()</span><span class=w> </span><span class=err>处理</span><span class=w> </span><span class=n>DROP_RANGE</span><span class=w> </span><span class=n>DROP_PART</span><span class=w> </span><span class=err>操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>executeReplaceRange</span><span class=p>()</span><span class=w> </span><span class=err>处理</span><span class=w> </span><span class=n>REPLACE_RANGE</span><span class=w> </span><span class=err>操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>executeFetch</span><span class=p>()</span><span class=w> </span><span class=err>处理</span><span class=w> </span><span class=n>GET_PART</span><span class=w> </span><span class=err>操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>fetchPart</span><span class=p>()</span><span class=w> </span><span class=err>从其它节点读取分区数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>MergeTreeData</span><span class=p>::</span><span class=nf>renameTempPartAndReplace</span><span class=p>()</span><span class=w> </span><span class=err>将文件写入本地并更新内存</span><span class=w> </span><span class=n>Meta</span><span class=w> </span><span class=err>信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>checkPartChecksumsAndCommit</span><span class=p>()</span><span class=w> </span><span class=err>获取并提交</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>StorageReplicatedMergeTree</span><span class=p>::</span><span class=nf>executeMetadataAlter</span><span class=p>()</span><span class=w> </span><span class=err>处理</span><span class=w> </span><span class=n>ALTER_METADATA</span><span class=w> </span><span class=err>操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeData</span><span class=p>::</span><span class=nf>scheduleDataMovingJob</span><span class=p>()</span><span class=w> </span><span class=err>含</span><span class=w> </span><span class=n>TTL</span><span class=err>、移动</span><span class=w> </span><span class=n>Partition</span><span class=w> </span><span class=err>等操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ReplicatedMergeTreeQueue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MergeTreeSink</span><span class=p>::</span><span class=nf>consume</span><span class=p>()</span><span class=w> </span><span class=err>写入的最终实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeDataWriter</span><span class=p>::</span><span class=nf>splitBlockIntoParts</span><span class=p>()</span><span class=w> </span><span class=err>将数据按照分区进行划分多个</span><span class=w> </span><span class=n>Block</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeDataWriter</span><span class=p>::</span><span class=nf>writeTempPart</span><span class=p>()</span><span class=w> </span><span class=err>遍历所有上述切割的</span><span class=w> </span><span class=n>Block</span><span class=w> </span><span class=err>，并将</span><span class=w> </span><span class=n>Block</span><span class=w> </span><span class=err>写入临时</span><span class=w> </span><span class=n>Part</span><span class=w> </span><span class=err>目录，包括计算</span><span class=w> </span><span class=n>Checksum</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeDataWriter</span><span class=p>::</span><span class=nf>writeTempPartImpl</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>MinMaxIndex</span><span class=p>::</span><span class=k>update</span><span class=p>()</span><span class=w> </span><span class=err>计算</span><span class=w> </span><span class=n>Block</span><span class=w> </span><span class=err>与</span><span class=w> </span><span class=n>Partition</span><span class=w> </span><span class=err>相关字段的</span><span class=w> </span><span class=n>MinMax</span><span class=w> </span><span class=err>统计值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>MergeTreeDataWriter</span><span class=p>::</span><span class=nf>stableGetPermutation</span><span class=p>()</span><span class=w> </span><span class=err>根据</span><span class=w> </span><span class=n>SORT</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=err>字句进行排序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>MergeTreeDataWriter</span><span class=p>::</span><span class=nf>updateTTL</span><span class=p>()</span><span class=w> </span><span class=err>计算</span><span class=w> </span><span class=n>TTL</span><span class=w> </span><span class=err>相关字段的</span><span class=w> </span><span class=n>MinMax</span><span class=w> </span><span class=err>统计值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>MergedBlockOutputStream</span><span class=p>::</span><span class=nf>writeWithPermutation</span><span class=p>()</span><span class=w> </span><span class=err>写入</span><span class=w> </span><span class=n>Partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>MergedBlockOutputStream</span><span class=p>::</span><span class=nf>writeImpl</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>Block</span><span class=p>::</span><span class=nf>checkNumberOfRows</span><span class=p>()</span><span class=w> </span><span class=err>检查各个列的行数是否相同</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>MergeTreeDataPartWriterWide</span><span class=p>::</span><span class=k>write</span><span class=p>()</span><span class=w> </span><span class=err>真正写入数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>MergeTreeDataPartWriterWide</span><span class=p>::</span><span class=nf>computeIndexGranularity</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>MergeTreeDataPartWriterWide</span><span class=p>::</span><span class=nf>writeColumn</span><span class=p>()</span><span class=w> </span><span class=err>对所有字段分批写入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeDataPartWriterWide</span><span class=p>::</span><span class=nf>writeSingleGranule</span><span class=p>()</span><span class=w> </span><span class=err>写入单个</span><span class=w> </span><span class=n>Granule</span><span class=w> </span><span class=err>的数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeDataPartWriterWide</span><span class=p>::</span><span class=nf>flushMarkToFile</span><span class=p>()</span><span class=w> </span><span class=err>对应</span><span class=w> </span><span class=n>mrk</span><span class=w> </span><span class=err>索引写入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>MergeTreeDataPartWriterWide</span><span class=p>::</span><span class=nf>calculateAndSerializePrimaryIndex</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>MergeTreeDataPartWriterWide</span><span class=p>::</span><span class=nf>calculateAndSerializeSkipIndices</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>MergeTreeDataPartWriterWide</span><span class=p>::</span><span class=nf>calculateAndSerializeStatistics</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|-</span><span class=n>MergeTreeDataPartWriterWide</span><span class=p>::</span><span class=nf>shiftCurrentMark</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=o>|-</span><span class=n>MergedBlockOutputStream</span><span class=p>::</span><span class=nf>finalizePartAsync</span><span class=p>()</span><span class=w> </span><span class=err>异步写入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeDataWriter</span><span class=p>::</span><span class=nf>finishDelayedChunk</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>MergeTreeData</span><span class=p>::</span><span class=nf>renameTempPartAndAdd</span><span class=p>()</span><span class=w> </span><span class=err>将临时目录挂载到表空间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>BackgroundJobsAssignee</span><span class=p>::</span><span class=k>trigger</span><span class=p>()</span><span class=w> </span><span class=err>触发后台的任务调度，例如</span><span class=w> </span><span class=n>Merge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>IResolvedFunction</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>IFunctionBase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>FunctionExpression</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=w> </span><span class=n>src</span><span class=o>/</span><span class=n>Functions</span><span class=o>/</span><span class=n>plus</span><span class=p>.</span><span class=n>cpp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>static</span><span class=w> </span><span class=n>inline</span><span class=w> </span><span class=n>llvm</span><span class=p>::</span><span class=n>Value</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nf>compile</span><span class=p>(</span><span class=n>llvm</span><span class=p>::</span><span class=n>IRBuilder</span><span class=o>&lt;&gt;</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>llvm</span><span class=p>::</span><span class=n>Value</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>left</span><span class=p>,</span><span class=w> </span><span class=n>llvm</span><span class=p>::</span><span class=n>Value</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>right</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>left</span><span class=o>-&gt;</span><span class=nf>getType</span><span class=p>()</span><span class=o>-&gt;</span><span class=nf>isIntegerTy</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>CreateAdd</span><span class=p>(</span><span class=k>left</span><span class=p>,</span><span class=w> </span><span class=k>right</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=nf>CreateFAdd</span><span class=p>(</span><span class=k>left</span><span class=p>,</span><span class=w> </span><span class=k>right</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>如何调用已编译的函数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ISourceStep</span><span class=p>::</span><span class=nf>updatePipeline</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>执行的时候第一个参数是记录行数，第二个则是通过</span><span class=w> </span><span class=n>ColumnData</span><span class=p>.</span><span class=nf>data</span><span class=p>()</span><span class=w> </span><span class=err>获取的值。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ReadFromMergeTree</span><span class=p>::</span><span class=k>read</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ReadFromMergeTree</span><span class=p>::</span><span class=nf>readFromPoolParallelReplicas</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>MergeTreeSelectProcessor</span><span class=p>()</span><span class=w> </span><span class=err>构造函数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MergeTreeSelectProcessor</span><span class=p>::</span><span class=nf>getPrewhereActions</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DB</span><span class=p>::</span><span class=nf>tryBuildPrewhereSteps</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>removeDuplicateColumns</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>StatementImpl</span><span class=p>::</span><span class=nf>execute</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>StatementImpl</span><span class=p>::</span><span class=nf>compile</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>StatementImpl</span><span class=p>::</span><span class=nf>compileImpl</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=nf>compile</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>compileFunction</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LLVMFunction</span><span class=p>.</span><span class=nf>prepare</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>zhuanlan</span><span class=p>.</span><span class=n>zhihu</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>p</span><span class=o>/</span><span class=mi>461631180</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>www</span><span class=p>.</span><span class=n>ihnfsa</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=k>database</span><span class=o>/</span><span class=n>clickhouse</span><span class=o>-</span><span class=n>jit</span><span class=o>-</span><span class=n>source</span><span class=o>-</span><span class=n>code</span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>在</span><span class=w> </span><span class=n>CHJIT</span><span class=p>::</span><span class=nf>compileFunction</span><span class=p>(</span><span class=n>llvm</span><span class=p>::</span><span class=n>Module</span><span class=p>,</span><span class=w> </span><span class=n>const</span><span class=w> </span><span class=n>IFunctionBase</span><span class=p>)</span><span class=w> </span><span class=err>中会创建</span><span class=w> </span><span class=n>LLVM</span><span class=w> </span><span class=err>函数，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ClientBase</span><span class=p>::</span><span class=nf>executeMultiQuery</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ClientBase</span><span class=p>::</span><span class=nf>processParsedSingleQuery</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ClientBase</span><span class=p>::</span><span class=nf>processOrdinaryQuery</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CHJIT</span><span class=p>::</span><span class=nf>deleteCompiledModule</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>IStorage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>MergeTreeData</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>StorageMergeTree</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CompiledExpressionCacheEntry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>CompiledAggregateFunctionsHolder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>CompiledFunctionHolder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>CompiledSortDescriptionFunctionHolder</span><span class=w>
</span></span></span></code></pre></div><a class=anchor id=参考></a><h1>参考 <a href=#%e5%8f%82%e8%80%83 aria-hidden=true>#</a></h1><ul><li><a href=https://github.com/duyet/clickhouse-monitoring>ClickHouse Monitoring</a> 不错的观测 system 元数据信息，还有 <a href=https://github.com/metrico/qryn>QRYN</a> 基于 CK 的观测系统实现。</li></ul></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#安装部署>安装部署</a><ul><li><a href=#配置文件>配置文件</a></li><li><a href=#启动服务>启动服务</a></li><li><a href=#keeper>Keeper</a></li></ul></li><li><a href=#使用技巧>使用技巧</a><ul><li><a href=#变量>变量</a></li></ul></li><li><a href=#mergetree>MergeTree</a><ul><li><a href=#索引>索引</a></li></ul></li><li><a href=#分布式>分布式</a><ul><li><a href=#目录结构-1>目录结构</a></li><li><a href=#ddl>DDL</a></li><li><a href=#常见操作>常见操作</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>