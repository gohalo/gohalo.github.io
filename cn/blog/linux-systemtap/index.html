<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Systemtap | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="Systemtap 几乎是目前所知的最强大的内核调试工具，甚至有人说它无所不能，接下来，我们就看看 SystemTAP 。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>Systemtap</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2016-09-15</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/linux/ role=button>linux</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/monitor/ role=button>monitor</a></div></div><hr><div class=content><p>Systemtap 几乎是目前所知的最强大的内核调试工具，甚至有人说它无所不能，接下来，我们就看看 SystemTAP 。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p><img alt="Systemtap Logo" src=images/systemtap-logo.svg class="mx-auto d-block"></p><p>通过 Kprobe 可以动态地收集调试和性能信息，是一种非破坏性的工具，用户可以用它跟踪运行中内核任何函数或执行的指令等。但 Kprobe 并没有提供一种易用的框架，用户需要自己去写模块，然后安装，所以在使用时非常麻烦。</p><p>而 systemtap 是利用 Kprobe 提供的 API 来实现动态地监控和跟踪运行中的 Linux 内核的工具，相比于 Kprobe，systemtap 更加简单，提供给用户简单的命令行接口，以及编写内核指令的脚本语言。</p><a class=anchor id=工作原理></a><h2>工作原理 <a href=#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86 aria-hidden=true>#</a></h2><p>systemtap 的核心思想是定义一个事件 (event)，并给出处理该事件的句柄 (Handler)，当一个特定的事件发生时，内核运行该处理句柄，就像快速调用一个子函数一样，处理完之后恢复到内核原始状态。</p><ul><li>事件<br>定义了很多种事件，例如进入或退出某个内核函数、定时器时间到、整个 systemtap 会话启动或退出等等。</li><li>句柄<br>描述了当事件发生时要完成的工作，通常是从事件的上下文提取数据，将它们存入内部变量中，或者打印出来。</li></ul><p>如下是 systemtap 的工作原理。</p><p><img alt="How Systemtap Works" src=images/systemtap-how-works.png class="mx-auto d-block"></p><p>其原理是，systemtap 通过将脚本语句翻译成 C 语言，编译成内核模块；模块加载之后，将所有探测的事件以钩子的方式挂到内核上，当任何处理器上的某个事件发生时，相应钩子上句柄就会被执行。</p><p>最后，当 systemtap 会话结束之后，钩子从内核上取下，然后移除模块；而整个过程只需要用一个命令 stap 就可以完成。</p><a class=anchor id=安装></a><h2>安装 <a href=#%e5%ae%89%e8%a3%85 aria-hidden=true>#</a></h2><p>可以通过 YUM 进行安装，详细的内容在下面；对于 CentOS 来说，此时会在 <code>/usr/share/systemtap/tapset/</code> 目录下安装 tapset 库。</p><a class=anchor id=0-判断内核是否支持-systemtap></a><h4>0. 判断内核是否支持 systemtap <a href=#0-%e5%88%a4%e6%96%ad%e5%86%85%e6%a0%b8%e6%98%af%e5%90%a6%e6%94%af%e6%8c%81-systemtap aria-hidden=true>#</a></h4><p>在 /boot 目录下查看当前版本的配置信息，是否包含如下的编译选项，CentOS 中通常都会包含。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># cat /boot/config-`uname -r` | egrep &#39;CONFIG_(DEBUG_INFO|KPROBES|DEBUG_FS|RELAY)=&#39;
</span></span><span class=line><span class=cl>CONFIG_RELAY=y
</span></span><span class=line><span class=cl>CONFIG_KPROBES=y
</span></span><span class=line><span class=cl>CONFIG_DEBUG_FS=y
</span></span><span class=line><span class=cl>CONFIG_DEBUG_INFO=y
</span></span></code></pre></div><p>如果没有上述的配置项，则需要重新编译，需要打开调试信息、Kprobe 和 debugfs ，确保 .config 文件中看到上面的四个选项。</p><a class=anchor id=1-安装></a><h4>1. 安装 <a href=#1-%e5%ae%89%e8%a3%85 aria-hidden=true>#</a></h4><p>使用 systemtap 需要安装几个依赖包：kernel-devel (一般会安装在 /usr/src/kernels/`uname -r` 目录下)，kernel-debuginfo (包比较大，下载很慢)；对于 systemtap 直接通过 yum 安装即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># yum install kernel-devel kernel-debuginfo kernel-debuginfo-common
</span></span><span class=line><span class=cl># yum install systemtap systemtap-server
</span></span></code></pre></div><p>除了上述的包之外，如果需要编译还可以安装 devel，还有测试示例 testsuite 等包。另外，需要注意是，安装时一定要注意 systemtap 版本要与内核的版本一致。</p><a class=anchor id=2-简单测试></a><h4>2. 简单测试 <a href=#2-%e7%ae%80%e5%8d%95%e6%b5%8b%e8%af%95 aria-hidden=true>#</a></h4><p>如下是一个简单的示例，会输出 hello world。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># stap -v -e &#39;probe begin { printf(&#34;Hello, World!\n&#34;); exit() }&#39;
</span></span></code></pre></div><a class=anchor id=源码安装></a><h2>源码安装 <a href=#%e6%ba%90%e7%a0%81%e5%ae%89%e8%a3%85 aria-hidden=true>#</a></h2><p>上述的方式只能安装 repository 中的包，通常都比较老，如果需要安装最新的版本可以从源码编译安装。可以从 <a href=ftp://sources.redhat.com/pub/systemtap/releases/>SystemTap</a> 下载相应的版本，而且需要 <a href=https://fedorahosted.org/releases/e/l/elfutils/>elfutils</a> 的支持。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>./configure --with-elfutils=/local/elfutils-0.166 --with-prefix=/usr
</span></span></code></pre></div><a class=anchor id=远程使用></a><h2>远程使用 <a href=#%e8%bf%9c%e7%a8%8b%e4%bd%bf%e7%94%a8 aria-hidden=true>#</a></h2><p>如果有很多相同类型的机器（内核版本、机型），那么只需要在一台机器上做上述的完整安装，然后在其它机器安装 systemtap-runtime 即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># stap -r `uname -r` -e &#39;probe vfs.read {exit()}&#39; -m simple    # 生成simple.ko
</span></span><span class=line><span class=cl># staprun simple.ko
</span></span></code></pre></div><p>除了上述的标准使用、远程使用，还可以使用 Flight Recorder Mode，简单说就是会在内核中申请一块内存，在需要的时候链接上去。</p><a class=anchor id=uefi-secure-boot-support></a><h1>UEFI Secure Boot Support <a href=#uefi-secure-boot-support aria-hidden=true>#</a></h1><p>这是 2.5 引入的新特性，对安全的支持，需要添加一个认证方式到 MOK(Machine Owner Keys) 数据库中，详细的可以参考 <a href=https://sourceware.org/systemtap/wiki/SecureBoot>Systemtap UEFI Secure Boot Support</a>。</p><p>上述文章没有提及需要安装 systemtap-server 并启动，实际上，在 CentOS 7 中可以通过如下的方式安装，简单记录如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># yum install systemtap-server       # 安装服务端
</span></span><span class=line><span class=cl># systemctl start stap-server        # 启动服务
</span></span></code></pre></div><p>然后，通过如下的方式执行，详细的内容可以参考上述的示例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 查看当前所有的server
</span></span><span class=line><span class=cl># stap --list-servers=all
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 生成相应的signing_key.x509
</span></span><span class=line><span class=cl># stap --use-server=192.168.2.108:38557 -e &#39;probe begin { exit() }&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 导入
</span></span><span class=line><span class=cl># mokutil --import signing_key.x509
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 重启，需要验证输入密码
</span></span><span class=line><span class=cl># shutdown -r now
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 查看是否生效
</span></span><span class=line><span class=cl># stap --list-servers
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 测试
</span></span><span class=line><span class=cl># stap -ve &#39;probe begin { printf(&#34;hello\n&#34;); exit() }&#39;
</span></span></code></pre></div><a class=anchor id=详细使用></a><h1>详细使用 <a href=#%e8%af%a6%e7%bb%86%e4%bd%bf%e7%94%a8 aria-hidden=true>#</a></h1><p>还可以参考 /usr/share/doc/systemtap-client-X.X/examples 中的示例，可以简单使用如下文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># cat hello-world.stp
</span></span><span class=line><span class=cl>probe begin
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>    print (&#34;hello world\n&#34;)
</span></span><span class=line><span class=cl>    exit ()
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># stap hello-world.stp
</span></span></code></pre></div><p>探测点描述包含三个部分，function@filename:lineno ，可以使用 * 表示任意字符，例如，指定文件名为 net/socket.c，探测函数的入口和返回。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>probe kernel.function(&#34;*@net/socket.c&#34;) {}
</span></span><span class=line><span class=cl>probe kernel.function(&#34;*@net/socket.c&#34;).return {}
</span></span></code></pre></div><p>可以通过如下方式查找匹配的内核函数和变量。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># stap -l &#39;kernel.function(&#34;*nit*&#34;)&#39;      // 查看函数
</span></span><span class=line><span class=cl># stap -L &#39;kernel.function(&#34;*nit*&#34;)&#39;      // 查找函数以及变量
</span></span></code></pre></div><a class=anchor id=执行步骤></a><h2>执行步骤 <a href=#%e6%89%a7%e8%a1%8c%e6%ad%a5%e9%aa%a4 aria-hidden=true>#</a></h2><p>脚本的执行总共分为了 5 步：</p><a class=anchor id=1-解析脚本></a><h4>1. 解析脚本 <a href=#1-%e8%a7%a3%e6%9e%90%e8%84%9a%e6%9c%ac aria-hidden=true>#</a></h4><p>解析 stap 输入脚本，或者 -e 中指定的内容，以及 tapset 库，也可以通过 -I 指定检索路径中的 *.stp 文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># stap --vp 50000 -I /tmp -e &#39;probe syscall.read {printf(&#34;hello i am digoal.\n&#34;); exit()}&#39;
</span></span></code></pre></div><a class=anchor id=2-匹配库></a><h4>2. 匹配库 <a href=#2-%e5%8c%b9%e9%85%8d%e5%ba%93 aria-hidden=true>#</a></h4><p>解析脚本，对库进行匹配，并选择对应的 stp(探针库)、stpm(宏库) 文件，直到所有的符号都分析匹配完。如果没有使用 -u 选项，则优化脚本，移除未使用的变量、表达式、函数等。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># stap --vp 05000 -I /tmp -e &#39;probe syscall.read {printf(&#34;hello i am digoal.\n&#34;); exit()}&#39;
</span></span></code></pre></div><a class=anchor id=3-转换成c></a><h4>3. 转换成C <a href=#3-%e8%bd%ac%e6%8d%a2%e6%88%90c aria-hidden=true>#</a></h4><p>将以上解析好的 stap 脚本转换成 C 代码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># stap --vp 00500 -I /tmp -e &#39;probe syscall.read {printf(&#34;hello i am digoal.\n&#34;); exit()}&#39;
</span></span></code></pre></div><a class=anchor id=4-编译成ko文件></a><h4>4. 编译成.ko文件 <a href=#4-%e7%bc%96%e8%af%91%e6%88%90ko%e6%96%87%e4%bb%b6 aria-hidden=true>#</a></h4><p>使用上述生成的 C 文件创建 Linux 内核对象文件 (.ko)。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># stap --vp 00050 -I /tmp -e &#39;probe syscall.read {printf(&#34;hello i am digoal.\n&#34;); exit()}&#39;
</span></span></code></pre></div><a class=anchor id=5-加载的内核运行></a><h4>5. 加载的内核运行 <a href=#5-%e5%8a%a0%e8%bd%bd%e7%9a%84%e5%86%85%e6%a0%b8%e8%bf%90%e8%a1%8c aria-hidden=true>#</a></h4><p>调用 staprun 将 ko 文件加载到内核中，并与之通讯，直到运行结束或受到中断请求信号；最后，staprun 从内核中卸载这个 ko 模块，并且清除整个 stap 过程产生的临时文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># stap --vp 00005 -I /tmp -e &#39;probe syscall.read {printf(&#34;hello i am digoal.\n&#34;); exit()}&#39;
</span></span></code></pre></div><a class=anchor id=配置选项></a><h2>配置选项 <a href=#%e9%85%8d%e7%bd%ae%e9%80%89%e9%a1%b9 aria-hidden=true>#</a></h2><p>常用的配置选项有：</p><ul><li><code>-p NUM</code> 运行至某个步骤停止，一般可用于生成可移动模块。</li><li><code>--vp ABCDE</code> 指定各步骤的输出详细级别。</li></ul><a class=anchor id=常见错误排查></a><h1>常见错误排查 <a href=#%e5%b8%b8%e8%a7%81%e9%94%99%e8%af%af%e6%8e%92%e6%9f%a5 aria-hidden=true>#</a></h1><p>简单列举如下。</p><a class=anchor id=semantic-error></a><h2>semantic error <a href=#semantic-error aria-hidden=true>#</a></h2><p>详细报错信息如下，主要原因是缺乏 debuginfo 包：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-v data-lang=v><span class=line><span class=cl><span class=nv>semantic</span> <span class=kt>error</span><span class=p>:</span> <span class=nv>missing</span> <span class=nv>x86_64</span> <span class=nv>kernel</span><span class=o>/</span><span class=kn>module</span> <span class=nv>debuginfo</span> <span class=p>[</span><span class=na>man</span> <span class=na>warning</span><span class=p>::</span><span class=s>debuginfo</span><span class=p>]</span> <span class=nv>under</span> <span class=s1>&#39;/lib/modules/xxx/build&#39;</span>
</span></span></code></pre></div><p>可以参考 <a href="https://www.sourceware.org/git/?p=systemtap.git;a=blob_plain;f=README;hb=HEAD">systemtap: a linux trace/probe tool</a> ，其中包含了如下内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>- By default, systemtap looks for the debug info in these locations:
</span></span><span class=line><span class=cl>/boot/vmlinux-`uname -r`
</span></span><span class=line><span class=cl>/usr/lib/debug/lib/modules/`uname -r`/vmlinux
</span></span><span class=line><span class=cl>/lib/modules/`uname -r`/vmlinux
</span></span><span class=line><span class=cl>/lib/modules/`uname -r`/build/vmlinux
</span></span></code></pre></div><p>也就是说，依据这个默认搜索路径，可以将 debug 的 vmlinux 链接到 /lib/modules 下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># ln -s /usr/lib/debug/lib/modules/`uname -r`/vmlinux /lib/modules/`uname -r`
</span></span></code></pre></div><a class=anchor id=参考></a><h1>参考 <a href=#%e5%8f%82%e8%80%83 aria-hidden=true>#</a></h1><p>可以参考 <a href=https://sourceware.org/systemtap/>systemtap官网</a> ；也可以参考 <a href=https://sourceware.org/systemtap/documentation.html>systemtap Documentation</a>，也就是 systemtap 的参考文档；以及相关的示例 <a href=https://sourceware.org/systemtap/wiki/WarStories>WarStories</a> 。</p><p>另外，<a href=https://sourceware.org/systemtap/SystemTap_Beginners_Guide/index.html>SystemTap Beginners Guide</a> 是一篇不错的入门文档，包括了详细的介绍以及示例。</p></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#工作原理>工作原理</a></li><li><a href=#安装>安装</a></li><li><a href=#源码安装>源码安装</a></li><li><a href=#远程使用>远程使用</a></li></ul></li><li><a href=#uefi-secure-boot-support>UEFI Secure Boot Support</a></li><li><a href=#详细使用>详细使用</a><ul><li><a href=#执行步骤>执行步骤</a></li><li><a href=#配置选项>配置选项</a></li></ul></li><li><a href=#常见错误排查>常见错误排查</a><ul><li><a href=#semantic-error>semantic error</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>