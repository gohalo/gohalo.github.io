<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Linux 内核模块 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="简单介绍下 Linux 中的内核模块编写，包括了内核签名机制的配置。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>Linux 内核模块</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2016-02-23</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/kernel/ role=button>kernel</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/linux/ role=button>linux</a></div></div><hr><div class=content><p>简单介绍下 Linux 中的内核模块编写，包括了内核签名机制的配置。</p><a class=anchor id=简单示例></a><h1>简单示例 <a href=#%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b aria-hidden=true>#</a></h1><p>如下是 Makefile 文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ifneq	($(KERNELRELEASE),)
</span></span><span class=line><span class=cl>obj-m := hello.o
</span></span><span class=line><span class=cl>else
</span></span><span class=line><span class=cl>KERNEL_DIR := /lib/modules/$(shell uname -r)/build
</span></span><span class=line><span class=cl>PWD := $(shell pwd)
</span></span><span class=line><span class=cl>all:
</span></span><span class=line><span class=cl>	make -C $(KERNEL_DIR) SUBDIRS=$(PWD) modules
</span></span><span class=line><span class=cl>#    rm -r -f .tmp_versions *.mod.c .*.cmd *.o *.symvers
</span></span><span class=line><span class=cl>endif
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>clean:
</span></span><span class=line><span class=cl>	rm -rf *.o *.ko *.mod.c *.order *.symvers .*.cmd .tmp_versions
</span></span><span class=line><span class=cl>.PHONY:clean
</span></span></code></pre></div><p>下面是驱动的测试程序。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* FILE: hello.c */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/init.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>hello_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_ALERT</span> <span class=s>&#34;hello module!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=n>__exit</span> <span class=nf>hello_exit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_ALERT</span> <span class=s>&#34;bye module!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>module_init</span><span class=p>(</span><span class=n>hello_init</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>module_exit</span><span class=p>(</span><span class=n>hello_exit</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;Dual BSD/GPL&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_AUTHOR</span><span class=p>(</span><span class=s>&#34;Andy &lt;justkidding@gmail.com&gt;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_DESCRIPTION</span><span class=p>(</span><span class=s>&#34;A simple Hello World Module&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>MODULE_ALIAS</span><span class=p>(</span><span class=s>&#34;the simplest module&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>然后可以通过如的方式进行测试。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># insmod hello.ko
</span></span><span class=line><span class=cl># lsmod
</span></span><span class=line><span class=cl># dmesg | tail -5
</span></span><span class=line><span class=cl>Module                  Size  Used by
</span></span><span class=line><span class=cl>hello                  12496  0
</span></span><span class=line><span class=cl># rmmod hello
</span></span></code></pre></div><a class=anchor id=内核签名机制></a><h1>内核签名机制 <a href=#%e5%86%85%e6%a0%b8%e7%ad%be%e5%90%8d%e6%9c%ba%e5%88%b6 aria-hidden=true>#</a></h1><p>在插入到内核模块时，可能会报如下错误。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-v data-lang=v><span class=line><span class=cl><span class=o>#</span> <span class=nv>insmod</span> <span class=nv>hello</span><span class=p>.</span><span class=nv>ko</span>
</span></span><span class=line><span class=cl><span class=nv>insmod</span><span class=p>:</span> <span class=nc>ERROR</span><span class=p>:</span> <span class=nv>could</span> <span class=nv>not</span> <span class=nv>insert</span> <span class=kn>module</span> <span class=nv>hello</span><span class=p>.</span><span class=nv>ko</span><span class=p>:</span> <span class=nc>Required</span> <span class=nv>key</span> <span class=nv>not</span> <span class=nv>available</span>
</span></span></code></pre></div><p>原因是内核启用了 <a href=https://lwn.net/Articles/222162/>Module signature verification</a> ，可以通过如下命令检测内核配置项。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 查看内核的配置项
</span></span><span class=line><span class=cl>$ grep &#34;CONFIG_MODULE_SIG&#34; /boot/config-`uname -r`
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 查看当前系统key
</span></span><span class=line><span class=cl># keyctl list %:.system_keyring
</span></span></code></pre></div><p>内核启动时，会有类似如下的输出。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Loaded X.509 cert &#39;CentOS Linux kpatch signing key: xxxx&#39;
</span></span><span class=line><span class=cl>Loaded X.509 cert &#39;CentOS Linux Driver update signing key: xxxx&#39;
</span></span><span class=line><span class=cl>Loaded X.509 cert &#39;CentOS Linux kernel signing key: xxxx&#39;
</span></span><span class=line><span class=cl>EFI: Loaded cert &#39;Lenovo Ltd.: ThinkPad Product CA 2012: xxxx&#39; linked to &#39;.system_keyring&#39;
</span></span><span class=line><span class=cl>EFI: Loaded cert &#39;Lenovo UEFI CA 2014: xxxx&#39; linked to &#39;.system_keyring&#39;
</span></span></code></pre></div><p>主要是由于目前 BIOS 支持 EFI，如果支持 UEFI Secure Boot 启动，那么内核所有模块都必须使用 UEFI Secure key 签名；当然，如果 BIOS 支持关闭 UEFI Secure Boot，那么可以在 BIOS 的 boot 项中关闭 UEFI Secure Boot 。</p><p>否则只能为自己制作一个。</p><p>接下来看看如何使用，主要包括了如下工具：</p><ul><li>openssl，生成X509公私秘钥对。</li><li>sign-file，对内核模块使用X509公私秘钥对签名。</li><li>mokutil，手动注册公钥到系统。</li><li>keyctl，手动取消注册公钥到系统。</li></ul><p>下面看看如何设置。</p><a class=anchor id=配置示例></a><h2>配置示例 <a href=#%e9%85%8d%e7%bd%ae%e7%a4%ba%e4%be%8b aria-hidden=true>#</a></h2><a class=anchor id=1-生成配置文件></a><h4>1. 生成配置文件 <a href=#1-%e7%94%9f%e6%88%90%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-hidden=true>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># cat &lt;&lt; EOF &gt; configuration_file.config
</span></span><span class=line><span class=cl>[ req ]
</span></span><span class=line><span class=cl>default_bits = 4096
</span></span><span class=line><span class=cl>distinguished_name = req_distinguished_name
</span></span><span class=line><span class=cl>prompt = no
</span></span><span class=line><span class=cl>string_mask = utf8only
</span></span><span class=line><span class=cl>x509_extensions = myexts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[ req_distinguished_name ]
</span></span><span class=line><span class=cl>O = Organization
</span></span><span class=line><span class=cl>CN = Organization signing key
</span></span><span class=line><span class=cl>emailAddress = E-mail address
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[ myexts ]
</span></span><span class=line><span class=cl>basicConstraints=critical,CA:FALSE
</span></span><span class=line><span class=cl>keyUsage=digitalSignature
</span></span><span class=line><span class=cl>subjectKeyIdentifier=hash
</span></span><span class=line><span class=cl>authorityKeyIdentifier=keyid
</span></span><span class=line><span class=cl>EOF
</span></span></code></pre></div><a class=anchor id=2-生成秘钥></a><h4>2. 生成秘钥 <a href=#2-%e7%94%9f%e6%88%90%e7%a7%98%e9%92%a5 aria-hidden=true>#</a></h4><p>一般会把公私钥放在 <code>/usr/src/kernels/</code> 目录下，对应内核版本可以通过 <code>uname -r</code> 命令查看，不过还是建议方法 HOME 目录下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ openssl req -x509 -new -nodes -utf8 -sha256 -days 36500 \
</span></span><span class=line><span class=cl>  -batch -config configuration_file.config -outform DER \
</span></span><span class=line><span class=cl>  -out public_key.der -keyout private_key.priv
</span></span></code></pre></div><a class=anchor id=3-导入到-mok-列表></a><h4>3. 导入到 mok 列表 <a href=#3-%e5%af%bc%e5%85%a5%e5%88%b0-mok-%e5%88%97%e8%a1%a8 aria-hidden=true>#</a></h4><p>上步生成了一对公私钥，接下来将其添加到 mok 列表中，此时会需要输入密码，该密码会在确认 MOK 请求的时候输入。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># mokutil --import public_key.der
</span></span></code></pre></div><a class=anchor id=4-重启系统></a><h4>4. 重启系统 <a href=#4-%e9%87%8d%e5%90%af%e7%b3%bb%e7%bb%9f aria-hidden=true>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># shutdown -r now
</span></span></code></pre></div><p>在启动时，shim.efi 会发现新添加的 KEY，并会启动 MokManager.efi 模块，此时需要选择 Eroll Key 选项，然后输入上面的密码。</p><a class=anchor id=5-查看-key-ring></a><h4>5. 查看 key ring <a href=#5-%e6%9f%a5%e7%9c%8b-key-ring aria-hidden=true>#</a></h4><p>接着 key ring 会添加到内核中，其中描述是配置文件中指定的 req_distinguished_name.O 中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># keyctl list %:.system_keyring | grep &#34;Organization&#34;
</span></span><span class=line><span class=cl># cat /proc/keys
</span></span></code></pre></div><p>同样，也可以查看系统的启动日志。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># dmesg | grep &#39;EFI: Loaded cert&#39;
</span></span></code></pre></div><a class=anchor id=6-添加到模块中></a><h4>6. 添加到模块中 <a href=#6-%e6%b7%bb%e5%8a%a0%e5%88%b0%e6%a8%a1%e5%9d%97%e4%b8%ad aria-hidden=true>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/usr/src/kernels/$(uname -r)/scripts/sign-file sha256 private_key.priv public_key.der hello.ko
</span></span></code></pre></div><a class=anchor id=7-添加-helloko></a><h4>7. 添加 hello.ko <a href=#7-%e6%b7%bb%e5%8a%a0-helloko aria-hidden=true>#</a></h4><p>仍然同上，直接插入模块即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># insmod hello.ko
</span></span></code></pre></div><a class=anchor id=proc-文件系统></a><h1>PROC 文件系统 <a href=#proc-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f aria-hidden=true>#</a></h1><p>最初 proc 文件系统是为提供一种内核及其模块向进程 (process) 发送信息的机制，这就是 proc 名字的由来。通过 proc 可以和内核内部数据结构进行交互，获取对于进程的有用信息，并可在运行时改变设置内核参数。</p><p>后来，这个系统的使用有些混乱和失控，于是在新内核中建议使用 sysfs 实现内核信息向用户空间的导出，例如，模块参数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ls /sys/module/hid/parameters               # 查看HID(Human Interface Devices)的参数
</span></span></code></pre></div><p>Linux 内核和用户空间的通信可通过 /proc 目录下的文件实现，编译时需要 <code>CONFIG_PROC_FS</code> 配置，通常来说，可写的配置项一般保存在 /proc/sys 目录下。其它介绍如下：</p><a class=anchor id=1-进程相关的目录></a><h4>1. 进程相关的目录 <a href=#1-%e8%bf%9b%e7%a8%8b%e7%9b%b8%e5%85%b3%e7%9a%84%e7%9b%ae%e5%bd%95 aria-hidden=true>#</a></h4><p>proc 目录下以 PID 作为目录，存储了进程相关信息，可以通过 cat 查看。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ cat /proc/1/cmdline              # 查看init命令启动参数
</span></span></code></pre></div><a class=anchor id=2-通用系统信息></a><h4>2. 通用系统信息 <a href=#2-%e9%80%9a%e7%94%a8%e7%b3%bb%e7%bb%9f%e4%bf%a1%e6%81%af aria-hidden=true>#</a></h4><p>包括了内存、文件系统、设备驱动、系统总线、电源等管理，如 devices、diskstats、meminfo、modules 等。</p><a class=anchor id=3-系统控制信息></a><h4>3. 系统控制信息 <a href=#3-%e7%b3%bb%e7%bb%9f%e6%8e%a7%e5%88%b6%e4%bf%a1%e6%81%af aria-hidden=true>#</a></h4><p>用来检测修改系统的运行参数，存在于 <code>/proc/sys</code> 目录下，可以使用 cat、echo 来查看或修改系统的运行参数。不过此处修改只是临时，如果要持久化需要修改 <code>/etc/sysctl.conf</code> 中的配置。</p><p>接下来看看内核中的实现。</p><a class=anchor id=内核实现></a><h2>内核实现 <a href=#%e5%86%85%e6%a0%b8%e5%ae%9e%e7%8e%b0 aria-hidden=true>#</a></h2><p>相关的 API 实现在 <code>fs/proc/generic.c</code> 文件中，常见的 <code>/proc/meminfo</code>、<code>/proc/stat</code> 等统计项的源码在 fs/proc 目录下，具体的实现可以查看这里的源码。</p><p>很多简单的示例可以参考源码中的 loadavg.c 实现。</p><a class=anchor id=问题排查></a><h1>问题排查 <a href=#%e9%97%ae%e9%a2%98%e6%8e%92%e6%9f%a5 aria-hidden=true>#</a></h1><p>正常来说，在通过如上的配置之后可以正常加载，不过仍有可能会出现部分问题。</p><a class=anchor id=参考></a><h1>参考 <a href=#%e5%8f%82%e8%80%83 aria-hidden=true>#</a></h1><ul><li>关于 Signed Kernel Modules 可以参考 Gentoo 中的文档 <a href=https://wiki.gentoo.org/wiki/Signed_kernel_module_support>Signed kernel module support</a>。</li><li>关于 proc 的文档，可参考源码 Documentation/filesystems 目录下的 <a href=https://www.kernel.org/doc/Documentation/filesystems/seq_file.txt>seq_file.txt</a> 以及 <a href=https://www.kernel.org/doc/Documentation/filesystems/proc.txt>proc.txt</a> 。</li></ul></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简单示例>简单示例</a></li><li><a href=#内核签名机制>内核签名机制</a><ul><li><a href=#配置示例>配置示例</a></li></ul></li><li><a href=#proc-文件系统>PROC 文件系统</a><ul><li></li><li><a href=#内核实现>内核实现</a></li></ul></li><li><a href=#问题排查>问题排查</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>