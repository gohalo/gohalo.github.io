<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>MySQL 主备数据校验 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="由于各种原因，MySQL 主从架构可能会出现数据不一致的情况出现，为此需要对主备复制的数据进行校验。
在此，简单介绍 Percona-Toolkits 提供的数据校验方式。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>MySQL 主备数据校验</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2015-01-20</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/database/ role=button>database</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/mysql/ role=button>mysql</a></div></div><hr><div class=content><p>由于各种原因，MySQL 主从架构可能会出现数据不一致的情况出现，为此需要对主备复制的数据进行校验。</p><p>在此，简单介绍 Percona-Toolkits 提供的数据校验方式。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p>由于各种原因，MySQL 主从架构可能会出现数据不一致的情况出现，大致归结为如下几类：</p><ul><li>主备方式，且在备库写数据；</li><li>执行了 non-deterministic query，如用户自定义函数、rand() 等；</li><li>回滚掺杂事务表和非事务表的事务；</li><li>binlog 或者 relaylog 数据损坏。</li></ul><p>在主库执行基于 statement 的 SQL 语句生成主库数据块的 checksum，把相同的 SQL 语句传递到从库，并在从库上计算相同数据块的 checksum，最后，比较主从库上相同数据块的 checksum 值，由此判断主从数据是否一致。</p><p>这种校验是分表进行的，在每个表内部又是分块进行的，而且提供了非常多的限流选项，因此对线上服务的冲击较小。</p><a class=anchor id=环境搭建></a><h2>环境搭建 <a href=#%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba aria-hidden=true>#</a></h2><p>在 CentOS 中可以通过如下方式安装依赖 RPM 包。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># rpm -ivh perl-DBD-MySQL perl-TermReadKey
</span></span><span class=line><span class=cl># rpm -ivh percona-toolkit-x.x.x.el7.x86_64.rpm
</span></span></code></pre></div><p>三个包分别为 MySQL 驱动、交互密码输入、主备数据校验工具。如果是双主配置，只需要在一个节点部署即可。如果要测试，可以通过 <code>PTDEBUG=1 pt-table-checksum > /tmp/checksum.log 2>&amp;1</code> 测试。</p><p>可以通过 <code>pt-table-checksum --help</code> 查看帮助信息，或者 <code>perldoc /usr/local/bin/pt-table-checksum</code> 查看详细帮助。</p><a class=anchor id=新建校验结果保存表></a><h2>新建校验结果保存表 <a href=#%e6%96%b0%e5%bb%ba%e6%a0%a1%e9%aa%8c%e7%bb%93%e6%9e%9c%e4%bf%9d%e5%ad%98%e8%a1%a8 aria-hidden=true>#</a></h2><p>分别在主备新建数据校验表。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>zabbix</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>checksums</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>db</span><span class=o>`</span><span class=w> </span><span class=nb>char</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>tbl</span><span class=o>`</span><span class=w> </span><span class=nb>char</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>chunk</span><span class=o>`</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>chunk_time</span><span class=o>`</span><span class=w> </span><span class=nb>float</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>chunk_index</span><span class=o>`</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>lower_boundary</span><span class=o>`</span><span class=w> </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>upper_boundary</span><span class=o>`</span><span class=w> </span><span class=nb>text</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>this_crc</span><span class=o>`</span><span class=w> </span><span class=nb>char</span><span class=p>(</span><span class=mi>40</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>this_cnt</span><span class=o>`</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>master_crc</span><span class=o>`</span><span class=w> </span><span class=nb>char</span><span class=p>(</span><span class=mi>40</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>master_cnt</span><span class=o>`</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>ts</span><span class=o>`</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>db</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>tbl</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>chunk</span><span class=o>`</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>KEY</span><span class=w> </span><span class=o>`</span><span class=n>ts_db_tbl</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>ts</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>db</span><span class=o>`</span><span class=p>,</span><span class=o>`</span><span class=n>tbl</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=n>ENGINE</span><span class=o>=</span><span class=n>InnoDB</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=n>CHARSET</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><a class=anchor id=主机用户创建></a><h2>主机用户创建 <a href=#%e4%b8%bb%e6%9c%ba%e7%94%a8%e6%88%b7%e5%88%9b%e5%bb%ba aria-hidden=true>#</a></h2><p>首先需要创建如下用户。</p><a class=anchor id=脚本部署主机></a><h3>脚本部署主机 <a href=#%e8%84%9a%e6%9c%ac%e9%83%a8%e7%bd%b2%e4%b8%bb%e6%9c%ba aria-hidden=true>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>USER</span><span class=w> </span><span class=s1>&#39;checker&#39;</span><span class=w> </span><span class=n>IDENTIFIED</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=s1>&#39;password&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GRANT</span><span class=w> </span><span class=n>SUPER</span><span class=p>,</span><span class=w> </span><span class=n>PROCESS</span><span class=p>,</span><span class=w> </span><span class=k>SHOW</span><span class=w> </span><span class=n>DATABASES</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=o>*</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=s1>&#39;checker&#39;</span><span class=o>@</span><span class=s1>&#39;localhost&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GRANT</span><span class=w> </span><span class=k>DELETE</span><span class=p>,</span><span class=w> </span><span class=k>INSERT</span><span class=p>,</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>zabbix</span><span class=p>.</span><span class=n>checksums</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=s1>&#39;checker&#39;</span><span class=o>@</span><span class=s1>&#39;localhost&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>权限配置解析：</p><ul><li>SUPER: SET @@binlog_format:=&ldquo;STATEMENT&rdquo; 设置会话级的 binlog 格式；</li><li>PROCESS: SHOW GRANTS FOR 查看当前用户的权限信息；</li><li>SHOW DATABASES: 查看是否存在数据库；</li><li>DELETE,INSERT,UPDATE: 用于清理、REPLACE INTO、UPDATE checksums 的历史数据；</li></ul><a class=anchor id=另外一台主机></a><h3>另外一台主机 <a href=#%e5%8f%a6%e5%a4%96%e4%b8%80%e5%8f%b0%e4%b8%bb%e6%9c%ba aria-hidden=true>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>USER</span><span class=w> </span><span class=s1>&#39;checker&#39;</span><span class=w> </span><span class=n>IDENTIFIED</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=s1>&#39;password&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GRANT</span><span class=w> </span><span class=n>PROCESS</span><span class=p>,</span><span class=w> </span><span class=n>SUPER</span><span class=p>,</span><span class=w> </span><span class=n>REPLICATION</span><span class=w> </span><span class=n>CLIENT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=o>*</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=s1>&#39;checker&#39;</span><span class=o>@</span><span class=s1>&#39;IP-MASTER&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GRANT</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>zabbix</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=s1>&#39;checker&#39;</span><span class=o>@</span><span class=s1>&#39;IP-MASTER&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>权限配置解析：</p><ul><li>SUPER, REPLICATION CLIENT: SHOW SLAVE STATUS 查看是否已经同步完成；</li><li>SELECT: EXPLAIN 评估备库数据量；</li></ul><a class=anchor id=数据校验命令></a><h2>数据校验命令 <a href=#%e6%95%b0%e6%8d%ae%e6%a0%a1%e9%aa%8c%e5%91%bd%e4%bb%a4 aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ pt-table-checksum --nocheck-replication-filters --check-slave-tables --chunk-size-limit=1.5 \
</span></span><span class=line><span class=cl>  --check-interval=3 --max-lag=1s --nocheck-binlog-format \
</span></span><span class=line><span class=cl>  --empty-replicate-table --progress=time,30 \
</span></span><span class=line><span class=cl>  --nocreate-replicate-table --replicate=zabbix.checksums \
</span></span><span class=line><span class=cl>  --replicate-check --check-plan --replicate-database=zabbix \
</span></span><span class=line><span class=cl>  --float-precision=2 --chunk-time=0.5 \
</span></span><span class=line><span class=cl>  --user=checker --password=password --port=3306 --host=localhost \
</span></span><span class=line><span class=cl>  --databases=somedb --tables=table1,table2,table3
</span></span></code></pre></div><a class=anchor id=数据不一致检查></a><h2>数据不一致检查 <a href=#%e6%95%b0%e6%8d%ae%e4%b8%8d%e4%b8%80%e8%87%b4%e6%a3%80%e6%9f%a5 aria-hidden=true>#</a></h2><p>可以直接通过如下命令查看数据不一致的表，需要在备库执行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>SELECT db, tbl, SUM(this_cnt) AS total_rows, COUNT(*) AS chunks
</span></span><span class=line><span class=cl>  FROM checksums
</span></span><span class=line><span class=cl>  WHERE (
</span></span><span class=line><span class=cl>    master_cnt &lt;&gt; this_cnt
</span></span><span class=line><span class=cl>    OR master_crc &lt;&gt; this_crc
</span></span><span class=line><span class=cl>    OR ISNULL(master_crc) &lt;&gt; ISNULL(this_crc))
</span></span><span class=line><span class=cl>  GROUP BY db, tbl;
</span></span></code></pre></div><a class=anchor id=执行流程></a><h1>执行流程 <a href=#%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b aria-hidden=true>#</a></h1><p>该工具每次只检测一个表，对于表中的数据会分割成 chunk，一般是 1000 条左右数据(默认会动态调整)；这个系统的调用流程可以阐述如下：</p><a class=anchor id=设置超时时间></a><h3>设置超时时间 <a href=#%e8%ae%be%e7%bd%ae%e8%b6%85%e6%97%b6%e6%97%b6%e9%97%b4 aria-hidden=true>#</a></h3><p>为了减小对线上事务的影响，在主库建立链接后，会先设置会话变量 <code>innodb_lock_wait_timeout=1</code> 和 <code>wait_timeout=10000</code>，也可以通过 <code>--set-vars wait_timeout=500</code> 参数覆盖默认值。</p><a class=anchor id=检查-sql_mode></a><h3>检查 sql_mode <a href=#%e6%a3%80%e6%9f%a5-sql_mode aria-hidden=true>#</a></h3><p>通过 <code>SELECT @@SQL_MODE</code> 命令，确认该变量中不包含 <code>ONLY_FULL_GROUP_BY</code>，因为对于一些正常的函数，该模式仍可能会出错，因此需要通过 <code>SET SQL_MODE</code> 命令重新设置。</p><a class=anchor id=设置-binlog_mode></a><h3>设置 binlog_mode <a href=#%e8%ae%be%e7%bd%ae-binlog_mode aria-hidden=true>#</a></h3><p>查看当前 <code>SELECT @@binlog_mode</code> 模式，如果不是 STATEMENT，默认会报错直接退出；当然，可以通过 <code>--[no]check-binlog-format</code> 参数不检查该参数。</p><p>然后，仍会设置会话变量 <code>/*!50108 SET @@binlog_format := 'STATEMENT'*/</code> 。</p><a class=anchor id=设置隔离级别></a><h3>设置隔离级别 <a href=#%e8%ae%be%e7%bd%ae%e9%9a%94%e7%a6%bb%e7%ba%a7%e5%88%ab aria-hidden=true>#</a></h3><p>设置会话的隔离级别为 <code>SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ</code>，主要因为在将 binog_format 设置为 STATEMENT 后，且隔离级别为 RR，那么会报如下的错误 <code>Transaction level 'READ-COMMITTED' in InnoDB is not safe for binlog mode 'STATEMENT'</code>，当然，这正是我们需要的，所以直接忽略该报错信息。</p><a class=anchor id=查找备库></a><h3>查找备库 <a href=#%e6%9f%a5%e6%89%be%e5%a4%87%e5%ba%93 aria-hidden=true>#</a></h3><p>通过 <code>get_slaves()</code> 函数查找备库，当然可以在启动时设置不同的备库查找方式，详见 <code>find_slave_hosts()</code> 函数。</p><a class=anchor id=拼接-sql></a><h3>拼接 SQL <a href=#%e6%8b%bc%e6%8e%a5-sql aria-hidden=true>#</a></h3><p>接下来就是拼接主库执行的 SQL 语句，主要的格式如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>REPLACE</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=nf>checksum_table</span><span class=p>(</span><span class=n>db</span><span class=p>,</span><span class=w> </span><span class=n>tbl</span><span class=p>,</span><span class=w> </span><span class=n>chunk</span><span class=p>,</span><span class=w> </span><span class=p>...)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=p>...,</span><span class=w> </span><span class=nf>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>cnt</span><span class=p>,</span><span class=w> </span><span class=nf>COALESCE</span><span class=p>(</span><span class=nf>LOWER</span><span class=p>(</span><span class=nf>CONV</span><span class=p>(</span><span class=nf>BIT_XOR</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>CAST</span><span class=p>(</span><span class=nf>CRC32</span><span class=p>(</span><span class=nf>CONCAT_WS</span><span class=p>(</span><span class=s1>&#39;#&#39;</span><span class=p>,...))</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>UNSIGNED</span><span class=p>)),</span><span class=w> </span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>16</span><span class=p>)),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>crc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=kp>tables</span><span class=w> </span><span class=k>FORCE</span><span class=w> </span><span class=k>INDEX</span><span class=p>(</span><span class=o>`</span><span class=k>PRIMARY</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=p>((</span><span class=n>col</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=o>?</span><span class=p>))</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>((</span><span class=n>col</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=o>?</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></div><p>简单介绍下拼接上述 SQL 时的注意内容：</p><ul><li>拼接各个列时，会根据不同的数据类型进行处理，例如以 <code>TIMESTAMP</code> 类型使用 <code>UNIX_TIMESTAMP()</code> 函数；可能为 <code>NULL</code> 时，使用 <code>CONCAT(ISNULL())</code> 等等；</li><li>每次执行查询前会通过 <code>EXPLAIN</code> 生成执行计划，主要关注评估数据量、索引使用情况，执行时会强制使用索引；</li><li>通过 <code>WHERE</code> 进行分区，也就是 chunk 块，默认会使执行结果尽量接近 <code>--chunk-time</code> 参数指定的时间，所以每次 chunk 的大小会动态调整。</li></ul><a class=anchor id=等待备库执行完成></a><h3>等待备库执行完成 <a href=#%e7%ad%89%e5%be%85%e5%a4%87%e5%ba%93%e6%89%a7%e8%a1%8c%e5%ae%8c%e6%88%90 aria-hidden=true>#</a></h3><p>在执行完上述的 SQL 后，需要等待备库执行完成上述的 SQL 语句，也即是计算备库的 CRC 值。</p><a class=anchor id=更新主库校验值></a><h3>更新主库校验值 <a href=#%e6%9b%b4%e6%96%b0%e4%b8%bb%e5%ba%93%e6%a0%a1%e9%aa%8c%e5%80%bc aria-hidden=true>#</a></h3><p>校验完成后在主库更新校验值，SQL 如下，该语句会将主库校验值同步到备库：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>checksum_table</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>chunk_time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=n>master_crc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=n>master_cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>WHERE</span><span class=w> </span><span class=n>db</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>tbl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>chunk</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><a class=anchor id=等待同步完成></a><h3>等待同步完成 <a href=#%e7%ad%89%e5%be%85%e5%90%8c%e6%ad%a5%e5%ae%8c%e6%88%90 aria-hidden=true>#</a></h3><p>接下来就是等待备库执行完成上述的 SQL 语句，也即将主库的校验值同步到备库。在按照 chunk 执行完成之后，接下来只需要去备库的 checksums 表中找 <code>master_cnt &lt;> this_cnt or OR master_crc &lt;> this_crc</code> 的记录即可。</p><a class=anchor id=校验函数></a><h2>校验函数 <a href=#%e6%a0%a1%e9%aa%8c%e5%87%bd%e6%95%b0 aria-hidden=true>#</a></h2><p>简单介绍下上述校验命令中的函数。</p><a class=anchor id=coalesce></a><h3>COALESCE() <a href=#coalesce aria-hidden=true>#</a></h3><p>类似于 Oracle 中的 <code>NVL()</code> 函数，语义略有区别，会返回参数中第一个非 <code>NULL</code> 表达式的值，从左到右：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 如下函数返回 1
</span></span><span class=line><span class=cl>mysql&gt; SELECT COALESCE(NULL, NULL, 1);
</span></span></code></pre></div><p>通常使用场景为，如果某个字段默认是 NULL，如果不想返回 NULL，而是 0 或其它值，可以使用该函数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mysql&gt; SELECT COALESCE(field_name, 0) AS value FROM table;
</span></span></code></pre></div><a class=anchor id=bit_xor></a><h4>BIT_XOR() <a href=#bit_xor aria-hidden=true>#</a></h4><p>用于 Binary String 的检测，会字段的值逐位进行检测，如果 bit 相同则返回 0，否则返回 1；比较时会按照行逐行进行检测，示例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mysql&gt; CREATE TABLE foobar (id INT);
</span></span><span class=line><span class=cl>mysql&gt; INSERT INTO foobar VALUES(100), (100), (120);
</span></span><span class=line><span class=cl>mysql&gt; SELECT BIT_XOR(id) FROM foobar;
</span></span></code></pre></div><p>首先是第一行与第二行比较，结果是 0；然后结果 0 与第三行比较，结果是 120。</p><a class=anchor id=castconvert></a><h3>CAST()/CONVERT() <a href=#castconvert aria-hidden=true>#</a></h3><p><code>CAST()</code> 和 <code>CONVERT()</code> 用来进行类型转换，只是语法不同，可用类型包括了 BINARY、CHAR(N)、DATE、TIME、DATETIME、DECIMAL、SIGNED、UNSIGNED 等：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CAST(value AS type);
</span></span><span class=line><span class=cl>CONVERT(value, type);
</span></span></code></pre></div><a class=anchor id=conv></a><h3>CONV() <a href=#conv aria-hidden=true>#</a></h3><p>语法为 <code>CONV(N,from_base,to_base)</code>，该函数用于数字的基数转换，最小基数值是2，最大值为36，如果任一参数为NULL，则该函数返回NULL。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 将数字5从基数16转为基数2
</span></span><span class=line><span class=cl>SELECT CONV(5,16,2);
</span></span></code></pre></div><a class=anchor id=配置选项></a><h1>配置选项 <a href=#%e9%85%8d%e7%bd%ae%e9%80%89%e9%a1%b9 aria-hidden=true>#</a></h1><p>接下来，看下执行命令时的常用参数。</p><a class=anchor id=安全选项></a><h2>安全选项 <a href=#%e5%ae%89%e5%85%a8%e9%80%89%e9%a1%b9 aria-hidden=true>#</a></h2><ul><li><code>--[no]check-replication-filters</code> (可选)<br>是否检查复制过滤规则，默认会检查，如果检查到有设置过滤规则会直接退出，主要防治检查的表在主库存在，而备库不存在导致 SQL 异常，主备复制出错；</li><li><code>--[no]check-slave-tables</code> (设置)<br>默认检查，查看是否所有从库都有被检查的表和列，防止由于改程序导致主备复制异常；每次同时会通过 EXPLAIN 检查备库的执行计划，评估行数；</li><li><code>--chunk-size-limit=2.0</code> (设置，尽量确保有主键或者唯一索引)<br>每次执行校验 SQL 前，会通过 EXPLAIN 检查本次执行SQL的数据量，对于没有唯一索引的表，通过 EXPLAIN 查看的行数差异会比较大，该参数就用于设置最大可以超过 chunk-size 几倍；如果超过 chunk-size*chunk-size-limit，那么就不会对本次的 chunk 做校验。</li></ul><p>如果是 1.0，就以 chunk-size 为准；是 0.0 则表示不对 chunk 大小做校验。</p><a class=anchor id=限速选项></a><h2>限速选项 <a href=#%e9%99%90%e9%80%9f%e9%80%89%e9%a1%b9 aria-hidden=true>#</a></h2><ul><li><code>--check-interval=1</code> (可选)<br>需要睡眠多久，再检查一次主从延迟是否超过 max-lag，默认是 1 秒；</li><li><code>--max-load=Threads_running=25</code> (建议设置)<br>设置最大负载，当超过这个值时就等待，防止由于工具导致过载，默认是 <code>Threads_running=25</code> 等价于 <code>Threads_running:25</code>，可以逗号分隔设置多个值；如果不指定值则会在开始检查变量对应的值，并将上限设置为 <code>120%</code>；</li></ul><p>每次执行完一个 chunk 之后，会通过 <code>SHOW GLOBAL STATUS</code> 查看当前服务器的状态，如果超过了上述值，就会等待；如果校验 SQL 导致锁等待，则会导致队列增加，进而 <code>Threads_running</code> 增加，通过该参数可以减小系统负载。</p><ul><li><code>--check-slave-lag="h=slave1"</code> (可选)<br>是否只检查这个从库的复制延迟，如果有些场景通过 <code>pt-slave-delay</code> 特意设置了延迟复制，那么可以通过该参数指定需要关注哪些复制延迟。</li><li><code>--max-lag=1s</code> (设置)<br>检查备库的最大延迟，也就是 <code>Seconds_Behind_Master</code> 参数，当超过这个就等待，而且如果备库复制线程异常，同样会等待；默认会检查所有库，也可以通过 check-slave-lag 指定需要检查哪些库。</li></ul><a class=anchor id=过滤选项></a><h2>过滤选项 <a href=#%e8%bf%87%e6%bb%a4%e9%80%89%e9%a1%b9 aria-hidden=true>#</a></h2><p>可以指定只检查哪些数据库、表、列、存储引擎等，也可以使用 Perl 正则表达式；除此之外，也可以指定忽略哪些。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>--ignore-databases
</span></span><span class=line><span class=cl>--ignore-databases-regex
</span></span><span class=line><span class=cl>--ignore-tables
</span></span><span class=line><span class=cl>--ignore-tables-regex
</span></span><span class=line><span class=cl>--ignore-columns
</span></span><span class=line><span class=cl>--ignore-engines
</span></span><span class=line><span class=cl>--databases
</span></span><span class=line><span class=cl>--databases-regex
</span></span><span class=line><span class=cl>--tables
</span></span><span class=line><span class=cl>--tables-regex
</span></span><span class=line><span class=cl>--columns
</span></span><span class=line><span class=cl>--engines
</span></span></code></pre></div><a class=anchor id=主库登陆选项></a><h2>主库登陆选项 <a href=#%e4%b8%bb%e5%ba%93%e7%99%bb%e9%99%86%e9%80%89%e9%a1%b9 aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>--host
</span></span><span class=line><span class=cl>--user
</span></span><span class=line><span class=cl>--password
</span></span><span class=line><span class=cl>--port
</span></span><span class=line><span class=cl>--ask-pass
</span></span><span class=line><span class=cl>--socket
</span></span></code></pre></div><a class=anchor id=其它参数></a><h2>其它参数： <a href=#%e5%85%b6%e5%ae%83%e5%8f%82%e6%95%b0 aria-hidden=true>#</a></h2><ul><li><code>--[no]empty-replicate-table</code><br>默认yes，会在每次执行校验前清理要校验表对应的记录，注意该操作不会TRUNCATE TABLE，如果需要，则要手动执行；</li><li><code>--progress=time,30</code><br>输出当前的进展，有三种输出方式，包括了两个参数值，默认是 time,30，还可以设置为 percentage,time,iterations；</li><li><code>--explain</code><br>打印要执行的命令，但是不执行 (dry run)；</li><li><code>--[no]create-replicate-table</code><br>检查 replicate 参数指定的表，如果不存在是否创建；</li><li><code>--replicate=percona.checksums</code><br>将校验结果写入到那个表中，默认是 percona.checksums，可以通过该参数指定；</li><li><code>--binary-index</code> (默认不开启测试)<br>默认通过 replicate 指定的表的 lower_boundary、upper_boundary 字段格式为 text，有些情况下可能会存在不兼容，通过该参数将定义上述字段为 blob 格式；</li><li><code>--[no]replicate-check</code><br>默认 yes，也就是每次校验完一个表之后，会等待各个备库同步完成，从而进行数据校验，如果关闭则需要通过 replicate-check-only 参数再检查一遍；</li><li><code>--replicate-check-only</code><br>不执行数据校验的 SQL，只查询保存的结果；</li><li><code>--run-time=NUM</code><br>要执行多长时间，每个循环会检测是否达到该参数设置值，可以指定单位，默认是秒，可以指定参数 s=seconds,m=minutes,h=hours,d=days；如果使用 <code>--resume</code> 那么之前的时间也会计算在内；</li><li><code>--recurse=NUM</code><br>在查找复制库时指定递归层次，可以查看 <code>recurse_to_slaves()</code> 函数；</li><li><code>--recursion-method=processlist</code><br>递归查找时的方法，包括了 <code>processlist(SHOW PROCESSLIST)</code>、<code>hosts(SHOW SLAVE HOSTS)</code>、<code>none</code>，详细查看 <code>recurse_to_slaves()</code> 函数；默认在启动时会检查所有的级联备库，可以通过该参数确认递归方法，通过 recurse 设置检查级联数；</li></ul><a class=anchor id=faqs></a><h1>FAQs <a href=#faqs aria-hidden=true>#</a></h1><a class=anchor id=1-binlog在row模式下是否支持></a><h4>1. binlog在row模式下是否支持？ <a href=#1-binlog%e5%9c%a8row%e6%a8%a1%e5%bc%8f%e4%b8%8b%e6%98%af%e5%90%a6%e6%94%af%e6%8c%81 aria-hidden=true>#</a></h4><p>工具在执行时会将会话变量binlog格式设置为statement；如果级联开启了&ndash;log-slave-updates选项，而binlog_format=ROW，那么此时仍有可能在会导致下一层的级联校验失败。</p><a class=anchor id=2-如何做到流量控制></a><h4>2. 如何做到流量控制？ <a href=#2-%e5%a6%82%e4%bd%95%e5%81%9a%e5%88%b0%e6%b5%81%e9%87%8f%e6%8e%a7%e5%88%b6 aria-hidden=true>#</a></h4><p>提供了多个参数进行流量控制，每次执行完一个chunk之后，会检查参数是否满足限流要求，如果超过限制则睡眠等待，直到满足要求。详见参数配置中的 &ldquo;限速选项&rdquo; 。</p><a class=anchor id=参考></a><h1>参考 <a href=#%e5%8f%82%e8%80%83 aria-hidden=true>#</a></h1><p><a href=https://www.percona.com/doc/percona-toolkit/2.1/dsn_data_source_name_specifications.html>DSN (DATA SOURCE NAME) SPECIFICATIONS</a></p></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#环境搭建>环境搭建</a></li><li><a href=#新建校验结果保存表>新建校验结果保存表</a></li><li><a href=#主机用户创建>主机用户创建</a></li><li><a href=#数据校验命令>数据校验命令</a></li><li><a href=#数据不一致检查>数据不一致检查</a></li></ul></li><li><a href=#执行流程>执行流程</a><ul><li></li><li><a href=#校验函数>校验函数</a></li></ul></li><li><a href=#配置选项>配置选项</a><ul><li><a href=#安全选项>安全选项</a></li><li><a href=#限速选项>限速选项</a></li><li><a href=#过滤选项>过滤选项</a></li><li><a href=#主库登陆选项>主库登陆选项</a></li><li><a href=#其它参数>其它参数：</a></li></ul></li><li><a href=#faqs>FAQs</a><ul><li></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>