<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Linux PAM 认证机制使用详解 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="Linux 通常会通过 login 进程完成登陆，最开始时只是简单的提示用户输入用户名和密码，然后校验用户是否存在、密码是否正确，如果都正常，那么就会直接完成登陆，进入到 Shell 程序运行。
PAM 提供了独立于具体程序配置机制，可以更加灵活的鉴权方案，这里详细介绍其使用方式。
简介 # 通常在用户登陆时，需要有一套的验证授权机制，最开始的时候，这一整套的验证机制是硬编码到程序中的，这样当程序有 bug 或者需要修改验证策略时，只能修改源程序。
为了改善这些问题，人们开始思考其他的方法，也就是所谓的 Pluggable Authentication Modules, PAM 应运而生了。
PAM 提供了一整套的鉴权、授权、密码管理、会话管理机制等，只需要程序支持 PAM 框架，用户就可以在完全不修改程序的条件下，动态修改鉴权机制，例如除了常规的用户名密码登陆，还可以使用指纹、One-Time-Password 等机制。
运行机制 # 如下是一个最常见的 login 示例程序，其中包括了二进制 login 可执行程序，该程序会动态链接 libpam.so 库，该库会读取 /etc/pam.d/login 配置文件，并根据配置文件中的内容，按照顺序生成不同栈。
然后，会根据不同的栈以及配置执行相关的动作。
相关文件 # 在 64 位系统中，与 PAM 相关的文件包含了如下几类：
/usr/lib64/libpam.so* 核心库，使用 PAM 机制的应用会链接到该库上。 /etc/pam.conf /etc/pam.d/* 配置文件，配置内容基本类似，前者为全局配置，通过第一列标识应用程序，而后者则以文件名标识应用程序，结构层次更加明确，也更常见。 /usr/lib64/security/pam_*.so 可以动态加载的模块，在配置文件中可以直接通过文件名引用。 如果一个应用程序 (例如 login) 想使用 PAM 提供的机制，那么需要链接到 libpam.so 库，否则就不支持 PAM 机制，可以通过如下命令查看。
$ ldd /usr/bin/login | grep pam libpam.so.0 =&amp;gt; /lib64/libpam."><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>Linux PAM 认证机制使用详解</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2020-10-13</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/linux/ role=button>linux</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/security/ role=button>security</a></div></div><hr><div class=content><p>Linux 通常会通过 login 进程完成登陆，最开始时只是简单的提示用户输入用户名和密码，然后校验用户是否存在、密码是否正确，如果都正常，那么就会直接完成登陆，进入到 Shell 程序运行。</p><p>PAM 提供了独立于具体程序配置机制，可以更加灵活的鉴权方案，这里详细介绍其使用方式。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p>通常在用户登陆时，需要有一套的验证授权机制，最开始的时候，这一整套的验证机制是硬编码到程序中的，这样当程序有 bug 或者需要修改验证策略时，只能修改源程序。</p><p>为了改善这些问题，人们开始思考其他的方法，也就是所谓的 <code>Pluggable Authentication Modules, PAM</code> 应运而生了。</p><p>PAM 提供了一整套的鉴权、授权、密码管理、会话管理机制等，只需要程序支持 PAM 框架，用户就可以在完全不修改程序的条件下，动态修改鉴权机制，例如除了常规的用户名密码登陆，还可以使用指纹、One-Time-Password 等机制。</p><a class=anchor id=运行机制></a><h2>运行机制 <a href=#%e8%bf%90%e8%a1%8c%e6%9c%ba%e5%88%b6 aria-hidden=true>#</a></h2><p>如下是一个最常见的 <code>login</code> 示例程序，其中包括了二进制 <code>login</code> 可执行程序，该程序会动态链接 <code>libpam.so</code> 库，该库会读取 <code>/etc/pam.d/login</code> 配置文件，并根据配置文件中的内容，按照顺序生成不同栈。</p><p><img alt="linux pam arch" src=images/linux-pam-arch.png class="mx-auto d-block"></p><p>然后，会根据不同的栈以及配置执行相关的动作。</p><a class=anchor id=相关文件></a><h2>相关文件 <a href=#%e7%9b%b8%e5%85%b3%e6%96%87%e4%bb%b6 aria-hidden=true>#</a></h2><p>在 64 位系统中，与 PAM 相关的文件包含了如下几类：</p><ol><li><code>/usr/lib64/libpam.so*</code> 核心库，使用 PAM 机制的应用会链接到该库上。</li><li><code>/etc/pam.conf</code> <code>/etc/pam.d/*</code> 配置文件，配置内容基本类似，前者为全局配置，通过第一列标识应用程序，而后者则以文件名标识应用程序，结构层次更加明确，也更常见。</li><li><code>/usr/lib64/security/pam_*.so</code> 可以动态加载的模块，在配置文件中可以直接通过文件名引用。</li></ol><p>如果一个应用程序 (例如 login) 想使用 PAM 提供的机制，那么需要链接到 <code>libpam.so</code> 库，否则就不支持 PAM 机制，可以通过如下命令查看。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ldd /usr/bin/login | grep pam
</span></span><span class=line><span class=cl>libpam.so.0 =&gt; /lib64/libpam.so.0 (0x00007fc79c03e000)
</span></span><span class=line><span class=cl>libpam_misc.so.0 =&gt; /lib64/libpam_misc.so.0 (0x00007fc79be3a000)
</span></span></code></pre></div><p>默认程序名与相关的 PAM 配置文件是相同的，当然，也允许通过配置文件进行配置，指定不同的配置文件名称。</p><p>验证时会按照顺序检查，也就是所谓的流程栈 (Stack) ，是认证时执行步骤、规则的堆叠，体现了自上而下的执行顺序，而且可以被引用。</p><a class=anchor id=配置文件></a><h1>配置文件 <a href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-hidden=true>#</a></h1><p>对于配置文件来说，如上所述，有两种方式，一种是全局的配置文件，也就是 <code>/etc/pam.conf</code>，其内容如下，第一个表示服务的名称。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ftpd auth required pam_unix.so nullok
</span></span></code></pre></div><p>还有一种是将相关服务的配置保存在 <code>/etc/pam.d/</code> 目录下，文件名就对应了应用名，例如 login、sshd 等。在配置文件中包含了四列，与上述的后四列相同，分别为：1) 模块类型；2) 控制模式；3) 模块名称；4) 模块参数。</p><a class=anchor id=配置详解></a><h2>配置详解 <a href=#%e9%85%8d%e7%bd%ae%e8%af%a6%e8%a7%a3 aria-hidden=true>#</a></h2><p>PAM 会根据配置中的模块名称从 <code>/usr/lib64/security</code> 目录下查找，所以通常直接使用文件名称即可；而不同的插件其参数也有所区别，所以，这里主要介绍前两个配置项。</p><a class=anchor id=1-模块类型></a><h3>1. 模块类型 <a href=#1-%e6%a8%a1%e5%9d%97%e7%b1%bb%e5%9e%8b aria-hidden=true>#</a></h3><p>PAM 有四种模块类型，代表不同的任务，一个类型可能有多行，按顺序依次由 PAM 模块调用：</p><ul><li>认证管理，auth<br>用来对用户的身份进行识别，如提示用户输入密码、判断用户是否为 root 等。</li><li>账号管理，account<br>对帐号的各项属性进行检查，如是否允许登录、是否达到最大用户数、root 用户是否允许在这个终端登录等。</li><li>会话管理，session<br>定义用户登录前的及用户退出后所要进行的操作，如登录连接信息、用户数据的打开与关闭、挂载文件系统等。</li><li>密码管理，password<br>使用用户信息来更新，如修改用户密码。</li></ul><p>如果在模块类型的开头有个短横线 <code>-</code> ，意味着，如果找不到这个模块导致无法加载，这一事件不会被记录在日志中，适用于哪些非必须的验证功能。</p><a class=anchor id=2-控制标记></a><h3>2. 控制标记 <a href=#2-%e6%8e%a7%e5%88%b6%e6%a0%87%e8%ae%b0 aria-hidden=true>#</a></h3><p>通过控制标记来处理和判断各个模块的返回值。</p><ul><li>required<br>即使某个模块对用户的验证失败，也要等所有的模块都执行完毕后才返回错误信息。</li><li>requisite<br>如果某个模块返回失败，则立刻返回失败，不再进行同类型后面的操作。</li><li>sufficient<br>如果验证通过，则立即返回验证成功消息，无论前面模块是否有失败，而且也不再执行后面模块。如果验证失败，sufficient 的作用和 optional 相同 。</li><li>optional<br>即使指定的模块验证失败，也允许用户接受应用程序提供的服务，一般返回 PAM_IGNORE 。</li><li>include<br>包含一个新的配置文件进行验证。</li><li>substack<br>与 include 类似，区别是，include 调用文件执行时有 die 或者 bad 则立即返回调用处，而 substack 则等待文件执行完。</li></ul><a class=anchor id=常用模块></a><h2>常用模块 <a href=#%e5%b8%b8%e7%94%a8%e6%a8%a1%e5%9d%97 aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pam_unix.so
</span></span><span class=line><span class=cl>  auth       提示用户输入密码，并与/etc/shadow文件相比对，匹配返回0。
</span></span><span class=line><span class=cl>  account    检查用户的账号信息(如是否过期)，帐号可用时返回0。
</span></span><span class=line><span class=cl>  password   修改用户的密码，将用户输入的密码，作为用户的新密码更新shadow文件。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pam_shells.so
</span></span><span class=line><span class=cl>  auth account 如果用户想登录系统，那么它的shell必须是在/etc/shells中。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pam_deny.so
</span></span><span class=line><span class=cl>  auth account password session 用来拒绝访问。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pam_permit.so
</span></span><span class=line><span class=cl>  auth account password session 任何时候都返回成功。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pam_cracklib.so
</span></span><span class=line><span class=cl>  password 提示用户输入密码，并与系统中的字典进行比对，检查密码的强度。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pam_securetty.so
</span></span><span class=line><span class=cl>  auth 用户要以root登录时，则登录的tty必须在/etc/securetty中。
</span></span></code></pre></div><a class=anchor id=示例程序></a><h1>示例程序 <a href=#%e7%a4%ba%e4%be%8b%e7%a8%8b%e5%ba%8f aria-hidden=true>#</a></h1><p>如下程序从命令行接收一个用户名作为参数，然后对这个用户名进行 auth 和 account 验证。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;security/pam_appl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;security/pam_misc.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;security/pam_modules.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>pam_handle_t</span> <span class=o>*</span><span class=n>pamh</span><span class=o>=</span><span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>retval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>user</span><span class=o>=</span><span class=s>&#34;nobody&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>pam_conv</span> <span class=n>conv</span> <span class=o>=</span> <span class=p>{</span> <span class=n>misc_conv</span><span class=p>,</span> <span class=nb>NULL</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>argc</span> <span class=o>==</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span> <span class=o>=</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>argc</span> <span class=o>&gt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;Usage: %s [username]</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;user: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>retval</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>retval</span> <span class=o>=</span> <span class=nf>pam_start</span><span class=p>(</span><span class=s>&#34;pamtest&#34;</span><span class=p>,</span> <span class=n>user</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>conv</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>pamh</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>retval</span> <span class=o>==</span> <span class=n>PAM_SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>retval</span> <span class=o>=</span> <span class=nf>pam_authenticate</span><span class=p>(</span><span class=n>pamh</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 进行auth类型认证
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span> <span class=c1>// 认证出错，则输出错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pam_authenticate(): %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>retval</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>pam_strerror</span><span class=p>(</span><span class=n>pamh</span><span class=p>,</span> <span class=n>retval</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>retval</span> <span class=o>==</span> <span class=n>PAM_SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>retval</span> <span class=o>=</span> <span class=nf>pam_acct_mgmt</span><span class=p>(</span><span class=n>pamh</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>    <span class=c1>// 进行account类型认证
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;pam_acct_mgmt() : %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>retval</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>pam_strerror</span><span class=p>(</span> <span class=n>pamh</span><span class=p>,</span> <span class=n>retval</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>retval</span> <span class=o>==</span> <span class=n>PAM_SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=s>&#34;Authenticated</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=s>&#34;Not Authenticated</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>pam_end</span><span class=p>(</span><span class=n>pamh</span><span class=p>,</span><span class=n>retval</span><span class=p>)</span> <span class=o>!=</span> <span class=n>PAM_SUCCESS</span><span class=p>)</span> <span class=p>{</span>     <span class=cm>/* close Linux-PAM */</span>
</span></span><span class=line><span class=cl>        <span class=n>pamh</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;pamtest0: failed to release authenticator</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span> <span class=n>retval</span> <span class=o>==</span> <span class=n>PAM_SUCCESS</span> <span class=o>?</span> <span class=mi>0</span><span class=o>:</span><span class=mi>1</span> <span class=p>);</span>       <span class=cm>/* indicate success */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>添加如下的配置文件，并同时通过如下命令编译执行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># cat &lt;&lt; EOF &gt; /etc/pam.d/pamtest
</span></span><span class=line><span class=cl># 提示用户输入密码
</span></span><span class=line><span class=cl>auth     required   pam_unix.so
</span></span><span class=line><span class=cl># 验证用户账号是否可用
</span></span><span class=line><span class=cl>account  required   pam_unix.so
</span></span><span class=line><span class=cl># 向系统日志输出一条信息
</span></span><span class=line><span class=cl>account  required   pam_warn.so
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ gcc -o pamtest pamtest.c -lpam -lpam_misc -Wall
</span></span></code></pre></div><a class=anchor id=参考></a><h1>参考 <a href=#%e5%8f%82%e8%80%83 aria-hidden=true>#</a></h1><ul><li>官方的相关文档 <a href=http://www.linux-pam.org/>www.linux-pam.org</a>、<a href=http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html>The Linux-PAM System Administrators&rsquo; Guide</a>、<a href=http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_ADG.html>The Linux-PAM Application Developers&rsquo; Guide</a>、<a href=http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_MWG.html>The Linux-PAM Module Writers&rsquo; Guide</a>。</li><li>一个 Solaris 的开发指南，可以供参考 <a href=http://docs.oracle.com/cd/E19253-01/819-7056/6n91eac3n/index.html>编写 PAM 应用程序和服务</a> 。</li></ul></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#运行机制>运行机制</a></li><li><a href=#相关文件>相关文件</a></li></ul></li><li><a href=#配置文件>配置文件</a><ul><li><a href=#配置详解>配置详解</a></li><li><a href=#常用模块>常用模块</a></li></ul></li><li><a href=#示例程序>示例程序</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>