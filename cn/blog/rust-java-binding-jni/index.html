<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Rust Java JNI 调用简介 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="JNI 是 Java 提供的一套与其它语言相互调用的标准，主要是 C 语言，所以，从理论上只要支持 C ABI 的语言都可以和 Java 语言相互调用，而 Rust 就是其中之一。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>Rust Java JNI 调用简介</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2024-01-26</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/language/ role=button>language</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/rust/ role=button>rust</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/java/ role=button>java</a></div></div><hr><div class=content><p>JNI 是 Java 提供的一套与其它语言相互调用的标准，主要是 C 语言，所以，从理论上只要支持 C ABI 的语言都可以和 Java 语言相互调用，而 Rust 就是其中之一。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p>通过 Rust 调用 Java 语言时，可以使用原始的 JNI 接口，也就是自己声明 JNI 的 C 函数原型，然后在 Rust 中按照 C 的方式去调用，不过这样操作起来比较繁琐，而且都是 <code>unsafe</code> 类型，社区的 <code>jni</code> 包已经封装了原始 JNI 接口，可以直接使用。</p><a class=anchor id=类型描述符></a><h2>类型描述符 <a href=#%e7%b1%bb%e5%9e%8b%e6%8f%8f%e8%bf%b0%e7%ac%a6 aria-hidden=true>#</a></h2><p>在 JVM 虚拟机中，数据类型的名称通过描述符保存，而非习惯的 <code>int</code> <code>float</code> 等类型名，基础类型包括了：<code>int(I)</code>、<code>long(J)</code>、<code>byte(B)</code>、<code>short(S)</code>、<code>char(C)</code>、<code>float(F)</code>、<code>double(D)</code>、<code>boolean(Z)</code>、<code>void(V)</code>，其它的如引用类型 <code>L+类全名+;</code>、数组 <code>[]</code>、方法 <code>(参数)返回值</code> 等。</p><p>如下是简单示例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Java: java.lang.String
</span></span><span class=line><span class=cl> JNI: Ljava/lang/String;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Java: String[]
</span></span><span class=line><span class=cl> JNI: [Ljava/lang/String;
</span></span><span class=line><span class=cl>Java: int[][]
</span></span><span class=line><span class=cl> JNI: [[I
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Java: long hello(int n, String s, int[] array);
</span></span><span class=line><span class=cl> JNI: (ILjava/lang/String;[I)J
</span></span><span class=line><span class=cl>Java: void hello();
</span></span><span class=line><span class=cl> JNI: ()V
</span></span></code></pre></div><p>在类似 <code>env.get_field()</code>、<code>env.call_method()</code> 等方法中会使用。</p><a class=anchor id=类型转换></a><h2>类型转换 <a href=#%e7%b1%bb%e5%9e%8b%e8%bd%ac%e6%8d%a2 aria-hidden=true>#</a></h2><p>在 <code>jni::sys</code> 中声明了各种基础类型，与对应的 Java 类型一一对应，例如 <code>jboolean</code> <code>jbyte</code> <code>jchar</code> <code>jshort</code> <code>jint</code> <code>jlong</code> <code>jfloat</code> <code>jdouble</code> 等等，都可以直接使用，这些都是原始类型 (Primitive Type)。</p><p>而 <code>jni::objects</code> 中的 <code>JObject</code> <code>JString</code> 是对 <code>jobject</code> <code>jstring</code> 的简单封装，可以通过 <code>JString::from(obj)</code> <code>obj.into()</code> 进行转换，如果不确定对象的类型，那么在转换前可以通过 <code>JNIEnv::is_instance_of()</code> 检查。</p><p>当通过 <code>env.get_field()</code> <code>env.call_method()</code> 获取到某个对象后，接着可以通过类似 <code>l()</code> <code>i()</code> 等方法转换，然后再通过 <code>env.get_string()</code> 类似方法转换为 Rust 对象，可以参考如下访问 Java 对象的示例。</p><a class=anchor id=项目初始化></a><h2>项目初始化 <a href=#%e9%a1%b9%e7%9b%ae%e5%88%9d%e5%a7%8b%e5%8c%96 aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 创建 Rust 项目，支持动态库，同时将 main.rs 修改为 lib.rs
</span></span><span class=line><span class=cl>$ cargo new demo
</span></span><span class=line><span class=cl>$ cargo add jni
</span></span><span class=line><span class=cl>$ cat Cargo.toml
</span></span><span class=line><span class=cl>... ...
</span></span><span class=line><span class=cl>[lib]
</span></span><span class=line><span class=cl>crate-type = [&#39;cdylib&#39;]
</span></span><span class=line><span class=cl>... ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 创建 Java 相关的项目，会在 example 目录下生成
</span></span><span class=line><span class=cl>$ mvn archetype:generate -DgroupId=com.foobar.demo -DartifactId=example -Dversion=1.0 \
</span></span><span class=line><span class=cl>    -DarchetypeArtifactId=maven-archetype-quickstart
</span></span><span class=line><span class=cl>----- 打包并运行，还可以是 mvn compile、mvn test 以及 mvn clean 等
</span></span><span class=line><span class=cl>$ mvn package
</span></span><span class=line><span class=cl>$ java -cp target/example-1.0.jar com.foobar.demo.App
</span></span><span class=line><span class=cl>----- 也可以编译运行
</span></span><span class=line><span class=cl>$ mvn compile
</span></span><span class=line><span class=cl>$ java -classpath target/classes com.foobar.demo.App
</span></span></code></pre></div><p>此时会在同一目录下存在 <code>demo(Rust)</code> 和 <code>example(Java)</code> 两个子目录。如下以此为基础，介绍常用的示例，还可以参考 <a href=https://github.com/jni-rs/jni-rs>github</a> 中的示例，有很多不错的使用技巧，包括新建对象、结构体、异步调用等。</p><a class=anchor id=java-调用-rust></a><h1>Java 调用 Rust <a href=#java-%e8%b0%83%e7%94%a8-rust aria-hidden=true>#</a></h1><p>修改 <code>src/lib.rs</code> 文件，然后通过 <code>cargo build</code> 编译，会生成 <code>target/debug/libdemo.so</code> 文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>objects</span>::<span class=n>JClass</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>JNIEnv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;system&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>Java_com_foobar_demo_App_hello</span><span class=p>(</span><span class=n>_env</span>: <span class=nc>JNIEnv</span><span class=p>,</span><span class=w> </span><span class=n>_class</span>: <span class=nc>JClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello Java!!!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后修改 <code>Java</code> 项目中的 <code>src/main/java/com/foobar/demo/App.java</code> 文件，通过 <code>mvn compile</code> 编译。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.foobar.demo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>App</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>loadLibrary</span><span class=o>(</span><span class=s>&#34;demo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>native</span> <span class=kt>void</span> <span class=nf>hello</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>hello</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>最后通过如下命令运行代码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>java -Djava.library.path=demo/target/debug -classpath example/target/classes com.foobar.demo.App
</span></span></code></pre></div><p>此时，在终端会打印 <code>Hello Java!!!</code> 信息。</p><p>在 Rust 中通过 <code>Java_&lt;类完整路径>_&lt;方法名></code> 将函数暴露出来，然后在对应 Java 类中声明对应的方法。在 Rust 代码中，第一个 <code>JNIEnv</code> 是 <code>JVM</code> 运行环境变量，很多操作需要；第二个是类对象 (静态方法 <code>JClass</code>)或者 <code>this</code> 对象(实例方法 <code>JObject</code>)。</p><a class=anchor id=基础类型参数></a><h2>基础类型参数 <a href=#%e5%9f%ba%e7%a1%80%e7%b1%bb%e5%9e%8b%e5%8f%82%e6%95%b0 aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>objects</span>::<span class=n>JClass</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>sys</span>::<span class=n>jint</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>JNIEnv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;system&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>Java_com_foobar_demo_App_sum</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_env</span>: <span class=nc>JNIEnv</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_class</span>: <span class=nc>JClass</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>a</span>: <span class=nc>jint</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>b</span>: <span class=nc>jint</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>jint</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.foobar.demo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>App</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>loadLibrary</span><span class=o>(</span><span class=s>&#34;demo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>native</span> <span class=kt>int</span> <span class=nf>sum</span><span class=o>(</span><span class=kt>int</span> <span class=n>a</span><span class=o>,</span> <span class=kt>int</span> <span class=n>b</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Sum(1, 2)=&#34;</span> <span class=o>+</span> <span class=n>sum</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=mi>2</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>关于 <code>String</code> 类型的使用，可以参考下面关于本地全局引用的讨论。</p><a class=anchor id=访问-java></a><h2>访问 Java <a href=#%e8%ae%bf%e9%97%ae-java aria-hidden=true>#</a></h2><p>包括了访问 Java 中的成员变量以及调用成员函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>objects</span>::<span class=p>{</span><span class=n>JObject</span><span class=p>,</span><span class=w> </span><span class=n>JValue</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>sys</span>::<span class=n>jstring</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>JNIEnv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;system&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>Java_com_foobar_demo_App_hello</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=n>env</span>: <span class=nc>JNIEnv</span><span class=p>,</span><span class=w> </span><span class=n>obj</span>: <span class=nc>JObject</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>jstring</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>get_field</span><span class=p>(</span><span class=o>&amp;</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Ljava/lang/String;&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t get name field&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>l</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t convert to object&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>env</span><span class=p>.</span><span class=n>call_method</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=n>obj</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;hey&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;(Ljava/lang/String;)V&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=p>[</span><span class=n>JValue</span>::<span class=n>from</span><span class=p>(</span><span class=o>&amp;</span><span class=n>result</span><span class=p>)],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Call hey method failed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>get_string</span><span class=p>(</span><span class=o>&amp;</span><span class=n>result</span><span class=p>.</span><span class=n>into</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t convert to rust string&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>into</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>new_string</span><span class=p>(</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;Hello </span><span class=si>{}</span><span class=s>!!!&#34;</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t create java string&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>output</span><span class=p>.</span><span class=n>into_raw</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.foobar.demo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>App</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>loadLibrary</span><span class=o>(</span><span class=s>&#34;demo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>hey</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Hey &#34;</span> <span class=o>+</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>name</span> <span class=o>=</span> <span class=s>&#34;Andy&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>native</span> <span class=n>String</span> <span class=nf>hello</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>App</span><span class=o>().</span><span class=na>hello</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>其它常用的方法还有，创建对象 <code>new_object()</code> <code>new_string()</code>、调用方法 <code>call_method()</code> <code>call_static_method()</code>、获取字段 <code>get_field()</code> <code>get_static_field()</code>、修改字段 <code>set_field()</code> <code>set_static_field()</code> 等。</p><a class=anchor id=抛出异常></a><h2>抛出异常 <a href=#%e6%8a%9b%e5%87%ba%e5%bc%82%e5%b8%b8 aria-hidden=true>#</a></h2><p>上述的代码都是通过 <code>expect()</code> 或者 <code>unwrap()</code> 方式处理异常，适用于示例代码，不适合线上。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>errors</span>::<span class=nb>Result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>objects</span>::<span class=n>JObject</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>sys</span>::<span class=n>jstring</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>JNIEnv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>do_hello</span><span class=p>(</span><span class=n>env</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>JNIEnv</span><span class=p>,</span><span class=w> </span><span class=n>obj</span>: <span class=kp>&amp;</span><span class=nc>JObject</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>jstring</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=p>.</span><span class=n>get_field</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Ljava/lang/String;&#34;</span><span class=p>)</span><span class=o>?</span><span class=p>.</span><span class=n>l</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span><span class=p>.</span><span class=n>get_string</span><span class=p>(</span><span class=o>&amp;</span><span class=n>result</span><span class=p>.</span><span class=n>into</span><span class=p>())</span><span class=o>?</span><span class=p>.</span><span class=n>into</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=p>.</span><span class=n>new_string</span><span class=p>(</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;Hello </span><span class=si>{}</span><span class=s>!!!&#34;</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>))</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>output</span><span class=p>.</span><span class=n>into_raw</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;system&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>Java_com_foobar_demo_App_hello</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=n>env</span>: <span class=nc>JNIEnv</span><span class=p>,</span><span class=w> </span><span class=n>obj</span>: <span class=nc>JObject</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>jstring</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>do_hello</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>obj</span><span class=p>).</span><span class=n>unwrap_or_else</span><span class=p>(</span><span class=o>|</span><span class=n>_</span><span class=o>|</span><span class=w> </span><span class=n>JObject</span>::<span class=n>null</span><span class=p>().</span><span class=n>into_raw</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>注意，在 Rust 代码中并没有显示调用 <code>env.throw()</code> <code>env.throw_new()</code> 等函数，暂不确定是否是因为不同版本中有优化。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.foobar.demo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>App</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>loadLibrary</span><span class=o>(</span><span class=s>&#34;demo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>iname</span> <span class=o>=</span> <span class=s>&#34;Andy&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>native</span> <span class=n>String</span> <span class=nf>hello</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=k>new</span> <span class=n>App</span><span class=o>().</span><span class=na>hello</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>注意几个调整，使用单独函数处理业务逻辑，这样方便处理 Rust 中的 Result 结果；在函数传参过程中，其中 <code>JNIEnv</code> 是可变引用。</p><a class=anchor id=常用技巧></a><h1>常用技巧 <a href=#%e5%b8%b8%e7%94%a8%e6%8a%80%e5%b7%a7 aria-hidden=true>#</a></h1><a class=anchor id=local-vs-global></a><h2>Local VS. Global <a href=#local-vs-global aria-hidden=true>#</a></h2><p>JNI 中存在 Local Reference 和 Global Reference 两类，当从 Java 切换到 Native 时会创建一个本地引用表，用于维护在 Native 中使用的对象，最大 512 个，当返回到 Java 环境时，该引用表会被删除。</p><p>在 Rust 中，可以通过 <code>&lt;'local></code> 告知编译器返回的是本地引用，可以确保不被销毁，如下是常用示例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span> <span class=nn>com.foobar.demo</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>App</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>loadLibrary</span><span class=o>(</span><span class=s>&#34;demo&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=kd>native</span> <span class=n>String</span> <span class=nf>hello</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>hello</span><span class=o>(</span><span class=s>&#34;Andy&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>如下的两个版本是都允许的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>objects</span>::<span class=p>{</span><span class=n>JClass</span><span class=p>,</span><span class=w> </span><span class=n>JString</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>sys</span>::<span class=n>jstring</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>jni</span>::<span class=n>JNIEnv</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;system&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>Java_com_foobar_demo_App_helloV0</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>mut</span><span class=w> </span><span class=n>env</span>: <span class=nc>JNIEnv</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_class</span>: <span class=nc>JClass</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span>: <span class=nc>JString</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>jstring</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>input</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>get_string</span><span class=p>(</span><span class=o>&amp;</span><span class=n>name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t get java name&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>into</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>new_string</span><span class=p>(</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;Hello </span><span class=si>{}</span><span class=s>!!!&#34;</span><span class=p>,</span><span class=w> </span><span class=n>input</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t create java string&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>output</span><span class=p>.</span><span class=n>into_raw</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;system&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>Java_com_foobar_demo_App_hello</span><span class=o>&lt;</span><span class=na>&#39;local</span><span class=o>&gt;</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>mut</span><span class=w> </span><span class=n>env</span>: <span class=nc>JNIEnv</span><span class=o>&lt;</span><span class=na>&#39;local</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_class</span>: <span class=nc>JClass</span><span class=o>&lt;</span><span class=na>&#39;local</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span>: <span class=nc>JString</span><span class=o>&lt;</span><span class=na>&#39;local</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>JString</span><span class=o>&lt;</span><span class=na>&#39;local</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>input</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>get_string</span><span class=p>(</span><span class=o>&amp;</span><span class=n>name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t get java name&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>into</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>env</span><span class=p>.</span><span class=n>new_string</span><span class=p>(</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;Hello </span><span class=si>{}</span><span class=s>!!!&#34;</span><span class=p>,</span><span class=w> </span><span class=n>input</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t create java string&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>按照谁使用谁管理的原则，对于像 <code>jstring</code> 这类需要动态申请内存的，要么完全在 Native 中管理，要么通过 <code>env.new_string()</code> 类似的函数创建。</p></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#类型描述符>类型描述符</a></li><li><a href=#类型转换>类型转换</a></li><li><a href=#项目初始化>项目初始化</a></li></ul></li><li><a href=#java-调用-rust>Java 调用 Rust</a><ul><li><a href=#基础类型参数>基础类型参数</a></li><li><a href=#访问-java>访问 Java</a></li><li><a href=#抛出异常>抛出异常</a></li></ul></li><li><a href=#常用技巧>常用技巧</a><ul><li><a href=#local-vs-global>Local VS. Global</a></li></ul></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>