<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Linux 用户管理 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="Linux 是一个多用户多任务的分时操作系统，可以允许多个用户同时登陆，通过账户管理，可以方便系统管理员对用户进行跟踪，控制系统资源的访问，也可以帮助用户组织文件，并为用户提供安全性保护。
对于普通用户来说，每个账号都拥有一个惟一的用户名以及口令，只有在输入正确之后才可以进入系统以及主目录。
这里详细介绍与用户管理相关的内容。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>Linux 用户管理</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2022-08-26</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/linux/ role=button>linux</a></div></div><hr><div class=content><p>Linux 是一个多用户多任务的分时操作系统，可以允许多个用户同时登陆，通过账户管理，可以方便系统管理员对用户进行跟踪，控制系统资源的访问，也可以帮助用户组织文件，并为用户提供安全性保护。</p><p>对于普通用户来说，每个账号都拥有一个惟一的用户名以及口令，只有在输入正确之后才可以进入系统以及主目录。</p><p>这里详细介绍与用户管理相关的内容。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p>任何使用操作系统的用户，都需要通过一个账号登陆，登陆之后，文件的权限、运行进程等，都是和该用户相关的，管理员可以以此来控制用户的权限范围。</p><p>在 Linux 中可以将用户分成三类：</p><ul><li>管理员账号，有最高权限，几乎可以为所欲为，一般为 <code>root</code> ；</li><li>系统账号，一般是应用程序使用的账号，无法通过终端或者界面进行登陆；</li><li>普通账号，用来登陆系统，也是最常用的账号类型。</li></ul><p>需要注意的是，在 Linux 系统内部，并不是通过账户名进行判断的，而是根据 <code>User ID, UID</code> 来判断，只要 <code>ID</code> 是 <code>0</code>，那么就是管理员，哪怕有多个 <code>ID</code> 为 <code>0</code> 的账号。</p><p>另外，为了方便账户的管理，提供了组的概念，一个账户可以划分到多个组中；而且与账号类似，系统内部同样使用的是 <code>Group ID, GID</code> 进行判断。</p><p>创建账号时，默认会根据账号类型自动分配递增的 UID/GID ，当然，也可通过参数指定，不过最好要保证 UID 与 GID 唯一，否则可能会出现非预期的行为，除非明确之后后果。</p><p>注意，再强调一遍，Linux 系统中使用的 UID/GID 数字，主要当需要人查看时，才会将 ID 信息转换为可读的用户名称。</p><a class=anchor id=用户组></a><h2>用户组 <a href=#%e7%94%a8%e6%88%b7%e7%bb%84 aria-hidden=true>#</a></h2><p>相同用户组内的用户可以共享文件，可以简化管理员权限管理，如果不通过参数指定，默认的 UID 和 GID 会递增，所以，通常来说是相同的，如果中间有通过参数指定了用户组，那么可能会导致两者不同。</p><p>可以通过 <code>groupadd -g &lt;GID> &lt;GroupName></code> 命令指定用户组 ID ，然后在创建用户时通过 <code>useradd -g &lt;GroupName> &lt;UserName></code> 命令显示指定用户所属的用户组。</p><a class=anchor id=主要用户组-vs-次要用户组></a><h3>主要用户组 VS. 次要用户组 <a href=#%e4%b8%bb%e8%a6%81%e7%94%a8%e6%88%b7%e7%bb%84-vs-%e6%ac%a1%e8%a6%81%e7%94%a8%e6%88%b7%e7%bb%84 aria-hidden=true>#</a></h3><p>用户组会分成两种：A) 主要用户组 Primary Group；B) 次要用户组 Secondary Group ，每个用户都有一个主要用户组，并可以成为任意多个次要用户组的成员，如果要与其它组共享文件，那么只需要设置文件的组权限，并将相关用户以次要用户组的方式与文件属组关联即可。</p><p>其中主用户组信息保存在 <code>/etc/passwd</code> 文件中，附加用户组则会在 <code>/etc/group</code> 中添加。另外，创建的文件是属于主用户组的，权限管理的时候需要注意。</p><p>可以通过 <code>id -n -g &lt;UserName></code> 查看用户的主用户组信息，通过 <code>id -n -G &lt;UserName></code> 查看用户组信息。</p><a class=anchor id=使用示例></a><h2>使用示例 <a href=#%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b aria-hidden=true>#</a></h2><p>账号的管理需要使用管理员，这里以在 CentOS 中创建一个 <code>foobar</code> 用户为例，命令通用，只是不同发行版本略有区别。</p><a class=anchor id=创建账号></a><h3>创建账号 <a href=#%e5%88%9b%e5%bb%ba%e8%b4%a6%e5%8f%b7 aria-hidden=true>#</a></h3><p>最简单的是通过 <code>useradd foobar</code> 命令创建用户，此时会直接使用系统的默认参数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ grep foobar /etc/passwd
</span></span><span class=line><span class=cl>foobar:x:1002:1002::/home/foobar:/bin/bash
</span></span></code></pre></div><p>对于 CentOS 来说，普通用户的 UID 会从 <code>1000</code> 开始递增。</p><a class=anchor id=设置密码></a><h3>设置密码 <a href=#%e8%ae%be%e7%bd%ae%e5%af%86%e7%a0%81 aria-hidden=true>#</a></h3><p>上面的命令只是添加了一个用户，但是没有设置密码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ grep foobar /etc/shadow
</span></span><span class=line><span class=cl>foobar:!!:18549:0:99999:7:::
</span></span></code></pre></div><p>这也就意味着，目前只能从 <code>root</code> 切换到 <code>foobar</code> ，无法登陆、无法从普通用户切换到 <code>foobar</code> ，可以使用管理员用户通过 <code>passwd foobar</code> 命令设置密码。</p><a class=anchor id=相关配置文件></a><h1>相关配置文件 <a href=#%e7%9b%b8%e5%85%b3%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-hidden=true>#</a></h1><p>所有的用户以及用户组信息都是保存在文件中的，其中与账号相关的文件以及目录有：</p><ul><li><code>/etc/passwd</code> 保存了用户信息，包括了用户名、UID、GID、主目录、Shell 等信息。</li><li><code>/etc/shadow</code> 保存用户的密码信息，包括了用户名、加密后的密钥、过期时间、最近修改时间等等。</li><li><code>/etc/group</code> 用户组配置文件，包括了组名称、组密码、GID、附加组信息等。</li><li><code>/etc/gshadow</code> 保存了组密码信息，与 <code>/etc/shadow</code> 文件类似。</li></ul><p>另外，还有一些服务的配置文件/目录。</p><ul><li><code>/etc/skel/</code> 存放新用户默认配置文件的目录，在新建用户时会将该目录复制到新建的用户目录下。</li><li><code>/etc/default/useradd</code></li><li><code>/etc/login.defs</code></li></ul><a class=anchor id=etcpasswd></a><h2>/etc/passwd <a href=#etcpasswd aria-hidden=true>#</a></h2><p>保存了用户的基本信息，每行为一个用户信息，一般权限为 <code>644</code> ，也就是所有用户都可以读取，但只有管理员可以修改。如下是 CentOS 中的部分文件内容，其中包括了管理员用户、系统用户以及普通用户。</p><p>该文件的部分内容摘抄如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root:x:0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>bin:x:1:1:bin:/bin:/sbin/nologin
</span></span><span class=line><span class=cl>daemon:x:2:2:daemon:/sbin:/sbin/nologin
</span></span><span class=line><span class=cl>nobody:x:65534:65534:Kernel Overflow User:/:/sbin/nologin
</span></span><span class=line><span class=cl>... ...
</span></span><span class=line><span class=cl>foobar:x:1002:1002::/home/foobar:/bin/bash
</span></span></code></pre></div><p>通过冒号 <code>:</code> 将每行分割，总共有 7 个字段：</p><ol><li>用户名，很多系统限制长度为 8 个字符，由大小写字母和数字组成，考虑到兼容性，不建议使用特殊字符。与 Windows 不同，Linux 中是区分大小写的，也就是说 <code>Foobar</code> 和 <code>foobar</code> 是两个不同的用户。</li><li>加密口令，老版本会将密码加密后保存在该字段，新版本通常保存在 <code>/etc/shadow</code> 文件中，这个字段只作为占位符，通常用字符 <code>x</code> 或者 <code>*</code> 表示。</li><li>UID 一个整数，通常与用户名一一对应，如果两个用户相同，那么系统内部实际会视为同一个用户，但是它们可以有不同的口令、主目录、登录 Shell 等。</li><li>GID 也是整数，记录了用户所属的用户组，对应了 <code>/etc/group</code> 文件中的一条记录。</li><li>注释信息，可以记录真实姓名、电话、地址等，Linux 对该字段没有明确的约束，很多发布版本中是一段注释性的文字。</li><li>主目录，也就是所谓的 <code>HOME</code> 目录，通常登陆后会直接切换到该目录，一般是在 <code>/home/&lt;USERNAME></code> 目录下，通常用户对自己的主目录有所有的权限，对其它用户无法访问。</li><li>Shell 程序，可以指定用户登陆时默认的 Shell 命令绝对路径，一般有 <code>/bin/bash</code> <code>/bin/sh</code> 等，系统用户一般不允许登陆，通常会被设置为 <code>/sbin/nologin</code>。</li></ol><p>其中 UID 的范围为 <code>[0, 65535]</code> ，其中 <code>0</code> 为管理员用户，所有的发布版本一致；但是，不同发布版本对系统用户与普通用户的边界定义不同，例如 CentOS 的普通用户是从 <code>1000</code> 开始，对应 <code>[1, 999]</code> 是系统用户。</p><p>而且一般会内置很多系统用户，例如 <code>bin</code> <code>nobody</code> 等等。</p><a class=anchor id=etcshadow></a><h2>/etc/shadow <a href=#etcshadow aria-hidden=true>#</a></h2><p>用来保存 Linux 中用户的密码信息，该文件权限为 <code>000</code> ，也就意味着只有 root 用户才可以访问，从而可以在一定程度上保证密码的安全性。</p><p>该文件的部分内容摘抄如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root:$6$PfRTCuHS50Bsv3EK$W3bohSpKMOMBBiiEwok7rqX8Lu74N4HO4LAxZRiDNahlTRSbuy3T3WRU5lDtAoLUD3pdCAb0jGWmyL2O16eft0::0:99999:7:::
</span></span><span class=line><span class=cl>bin:*:18078:0:99999:7:::
</span></span><span class=line><span class=cl>daemon:*:18078:0:99999:7:::
</span></span><span class=line><span class=cl>dbus:!!:18167::::::
</span></span></code></pre></div><p>与 <code>/etc/passwd</code> 文件一样，每行代表一个用户，而且使用冒号 <code>:</code> 作为分割符，总共分成了 9 个字段：</p><ol><li>用户名，与 <code>/etc/passwd</code> 文件中保持一致。</li><li>加密密码，这里保存的是真正加密后的密码信息，详细的加密方式可以参考 <a href=/cn/blog/linux-user-manage-c-api/>详解 Linux 用户密码管理</a> 中的介绍。</li><li>最近一次修改时间，使用的是从 1970.1.1 以来的总天数。</li><li>密码修改的最小时间间隔，单位是天，也就是据上次修改多久不能修改密码，防止用户频繁修改，如果是 0 ，则表示随时可以修改。</li><li>密码有效期，单位是天，同样是通过距离上次修改时间判断，强制用户定期修改密码，默认是 99999 天，可以认为是永久生效。</li><li>密码修改前警告天数，当账号的密码快过期时，提前进行提示。</li><li>密码过期后的宽限天数，过期后，如果用户还未修改密码，在宽限天数内仍可以登陆，过期后完全禁用，其中 0 表示过期后立即失效，-1 表示永不失效。</li><li>账号失效时间，同第三字段一样，使用从 1970.1.1 以来的总天数作为账户的失效时间，账号在此字段规定的时间之外，不论密码是否过期，都将无法使用。</li><li>保留，暂未使用。</li></ol><p>注意，对于第二个字段，所有的系统用户是 <code>!!</code> 或者 <code>*</code> 表示没有密码无法登陆，如果是新建的用户，一般是 <code>!!</code> 表示没有密码不能登陆。第三个字段可以通过 <code>date -d "1970-01-01 NNN days"</code> 转换为习惯阅读的日期。</p><a class=anchor id=ectgroup></a><h2>/ect/group <a href=#ectgroup aria-hidden=true>#</a></h2><p>保存了与用户组相关的信息，对应了 <code>/etc/passwd</code> 中的第四个字段，</p><p>该文件的部分内容摘抄如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>root:x:0:
</span></span><span class=line><span class=cl>bin:x:1:
</span></span><span class=line><span class=cl>... ...
</span></span><span class=line><span class=cl>foobar:x:1002:
</span></span></code></pre></div><p>同样每行代表一个用户组，通过冒号 <code>:</code> 将每行分成四个字段，每个字段对应的含义为：</p><ol><li>组名称，与用户名类似，只在对用户显示时使用。</li><li>组密码，与 <code>/etc/passwd</code> 一样，通过 <code>x</code> 标识密码，实际保存在 <code>/etc/gshadow</code> 文件中。</li><li>GID，与 UID 类似，系统通过 GID 区分用户，组名称只在对用户显示时使用。</li><li>组中的用户，会列出该组中包含的所有附加用户。</li></ol><p>用户组密码用来指定组管理员，随着系统中账号增加，系统管理员可能没有足够时间管理，这样就可以通过组管理员代替系统管理员进行管理，只是该功能现在使用的很少。</p><a class=anchor id=etcskel></a><h2>/etc/skel/ <a href=#etcskel aria-hidden=true>#</a></h2><p>这个目录用来定义创建用户时的默认环境，新建用户时该目录下所有的文件都会复制到新创建用户的 <code>HOME</code> 目录下，一般都是隐藏的文件，通过修改该目录下的文件，可以提供统一、标准化的用户初始环境。</p><p>例如在 CentOS 桌面版的内容如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ls /etc/skel/ -alh
</span></span><span class=line><span class=cl>total 24K
</span></span><span class=line><span class=cl>drwxr-xr-x.   3 root root   78 Sep 28  2019 .
</span></span><span class=line><span class=cl>drwxr-xr-x. 147 root root 8.0K Oct 14 23:14 ..
</span></span><span class=line><span class=cl>-rw-r--r--.   1 root root   18 Nov  9  2019 .bash_logout
</span></span><span class=line><span class=cl>-rw-r--r--.   1 root root  141 Nov  9  2019 .bash_profile
</span></span><span class=line><span class=cl>-rw-r--r--.   1 root root  312 Nov  9  2019 .bashrc
</span></span><span class=line><span class=cl>drwxr-xr-x.   4 root root   39 Sep 28  2019 .mozilla
</span></span></code></pre></div><p>一般默认就是一些 Bash 相关的配置文件。</p><a class=anchor id=用户管理></a><h1>用户管理 <a href=#%e7%94%a8%e6%88%b7%e7%ae%a1%e7%90%86 aria-hidden=true>#</a></h1><p>所谓的用户管理就是添加、删除用户，管理用户的密码过期时间等，如下所有的示例都是对 foobar 账号进行操作。</p><p>常用的命令有：</p><ul><li><code>useradd</code> 与 <code>adduser</code> 命令相同，用来添加用户；</li><li><code>userdel</code> 删除用户及相关用户的配置文件；</li><li><code>usermod</code> 修改用户配置，例如家目录、默认 Shell 等；</li><li><code>passwd</code> 为用户设置、修改密码；</li><li><code>id</code> 查看用户的 UID/GID 等信息；</li><li><code>su</code> 切换用户；</li></ul><p>在 CentOS 中，<code>useradd</code> 与 <code>adduser</code> 命令相同，其中 <code>adduser</code> 是一个符号链接，指向了 <code>useradd</code> 命令。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ls -alh  /usr/sbin/useradd
</span></span><span class=line><span class=cl>-rwxr-xr-x 1 root root 237K Nov  9  2019 /usr/sbin/useradd
</span></span><span class=line><span class=cl>$ ls -alh /usr/sbin/adduser
</span></span><span class=line><span class=cl>lrwxrwxrwx 1 root root 7 Nov  9  2019 /usr/sbin/adduser -&gt; useradd
</span></span></code></pre></div><a class=anchor id=查看用户></a><h2>查看用户 <a href=#%e6%9f%a5%e7%9c%8b%e7%94%a8%e6%88%b7 aria-hidden=true>#</a></h2><p>通过 <code>id user</code> 命令查看用户。</p><a class=anchor id=创建用户></a><h2>创建用户 <a href=#%e5%88%9b%e5%bb%ba%e7%94%a8%e6%88%b7 aria-hidden=true>#</a></h2><p>可以通过 <code>useradd</code> 命令创建用户，会有一个大致的创建流程，但是可以通过 <code>/etc/login.defs</code> 配置文件进行定制，该文件定义了部分在创建用户时的默认配置选项。</p><p>不同的发行版本会略有区别，不过大致的操作步骤为：</p><ol><li>帐号信息添加到 <code>/etc/passwd</code>、<code>/etc/shadow</code>、<code>/etc/group</code>、<code>/etc/gshadow</code> 文件中。</li><li>创建 <code>/home/&lt;USERNAME></code> 目录。</li><li>将 <code>/etc/skel</code> 目录下的内容复制到 <code>/home/&lt;USERNAME></code> 目录下，很多是隐藏文件。</li><li>在 <code>/var/mail</code> 目录下创建邮箱帐号。</li></ol><p>其中第一步基本上所有的发行版本都会执行，而剩余的不同的发行版本会有不同的操作。最后还需要通过 <code>passwd USERNAME</code> 命令设置用户的密码，CentOS 在没有设置密码时无法登陆。</p><a class=anchor id=删除用户></a><h2>删除用户 <a href=#%e5%88%a0%e9%99%a4%e7%94%a8%e6%88%b7 aria-hidden=true>#</a></h2><p>在通过 <code>userdel USERNAME</code> 删除用户时，会删除 <code>/etc/passwd</code>、<code>/etc/group</code> 中的内容，但是不会删除 <code>/home/&lt;USERNAME></code> 目录以及 <code>/var/mail</code> 目录下文件，可以使用 <code>-r</code> 删除这两项。</p><a class=anchor id=修改用户></a><h2>修改用户 <a href=#%e4%bf%ae%e6%94%b9%e7%94%a8%e6%88%b7 aria-hidden=true>#</a></h2><a class=anchor id=用户组调整></a><h3>用户组调整 <a href=#%e7%94%a8%e6%88%b7%e7%bb%84%e8%b0%83%e6%95%b4 aria-hidden=true>#</a></h3><p>新建用户，并添加到已知的附加用户组里，如果用户组不存在则需要手动创建，也可以通过逗号分隔指定多个用户组。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># useradd -G admins,ftp,www,developers foobar
</span></span></code></pre></div><p>注意，如上的方法会同时创建一个主用户组。</p><p>也可以通过 <code>-g</code> 参数将新增加的用户初始化为指定为登录组，也就是主要用户组。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># useradd -g developers foobar
</span></span></code></pre></div><p>其它常见操作可以参考如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 修改主要用户组为apache
</span></span><span class=line><span class=cl># usermod -g apache foobar
</span></span><span class=line><span class=cl>----- 将已经存在的用户添加到一个组里面，此时会在/etc/group的apache分组最后一列增加
</span></span><span class=line><span class=cl># usermod -a -G apache foobar
</span></span></code></pre></div><p>其中 <code>-g</code> 表示 <code>initial login group</code>，<code>-G</code> 表示 <code>supplementary groups</code>。</p><a class=anchor id=用户提权></a><h1>用户提权 <a href=#%e7%94%a8%e6%88%b7%e6%8f%90%e6%9d%83 aria-hidden=true>#</a></h1><p>普通用户通常有需求需要系统管理员用户执行，通常有几种方式：A) 粘滞位，执行命令时该命令会有 root 权限；B) sudoer 可以设置如何切换用户；C) capabilities 机制，允许普通用户执行部分 root 的权限。</p><a class=anchor id=粘滞位></a><h2>粘滞位 <a href=#%e7%b2%98%e6%bb%9e%e4%bd%8d aria-hidden=true>#</a></h2><p>其中一个解决方案是，类似于 passwd ，对一个 owner 为 root 的可执行文件可以增加粘滞位 (Set User ID on execution, SUID)，也就是 <code>chmod +s</code> 。</p><p>这样在运行的时候使用的就是 root 权限，带来的问题就是会导致其运行的权限过高，在某种程度上增大了安全攻击面，有些平台上 ping 也是采用上述的粘滞位机制。</p><a class=anchor id=sudoer></a><h2>sudoer <a href=#sudoer aria-hidden=true>#</a></h2><p>有些时候，系统管理员需要将部分权限分配给用户，或者说，允许部分普通用户有能力切换到系统管理员，这就是所谓的 sudoer 的能力。</p><p>简单来说，需要修改 <code>/etc/sudoer</code> 配置文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>用户 登录的主机=(可以变换的身份) 可以执行的命令
</span></span><span class=line><span class=cl>monitor ALL=(root) NOPASSWD: /usr/sbin/groupadd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>其中 ALL 也可以通过 Host_Alias 指定具体的主机信息，包括了主机名、IP地址、网络掩码等
</span></span><span class=line><span class=cl>Host_Alias HT01=localhost,etc01,10.0.0.4,255.255.255.0,192.168.1.0/24
</span></span></code></pre></div><a class=anchor id=sudo-vs-su></a><h2>sudo VS. su <a href=#sudo-vs-su aria-hidden=true>#</a></h2><p>在切换时实际上是两种策略：1) su 切换到相应的用户，所以需要切换用户的密码；2) sudo 不知道 root 密码的时候执行一些 root 的命令，需要在 suders 中配置+自己用户密码。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ sudo su root                        ← 需要用户的密码+sudoers配置
</span></span><span class=line><span class=cl>$ su root                             ← 需要root用户密码
</span></span></code></pre></div><p>注意，之所以使用 <code>sudo su root</code> 这种方式，可能是 btmp 等类似的文件，只有 root 可以写入，否则会报 Permission Denied，此时可以通过 strace 查看报错的文件。</p><a class=anchor id=审计></a><h1>审计 <a href=#%e5%ae%a1%e8%ae%a1 aria-hidden=true>#</a></h1><p>CentOS 系统上，用户登录历史存储在以下这些文件中：</p><ul><li><code>/var/run/utmp</code> 记录当前打开的会话，会被 who 和 w 记录当前有谁登录以及他们正在做什么。</li><li><code>/var/log/wtmp</code> 存储系统连接历史记录，被 last 工具用来记录最后登录的用户的列表。</li><li><code>/var/log/btmp</code> 失败的登录尝试，被 lastb 工具用来记录最后失败的登录尝试的列表。</li></ul><p>实际上，可以直接通过 <code>utmpdump</code> 将上述文件中保存的数据 dump 出来，另外，默认的登陆日志保存在 <code>/var/log/secure</code> 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 当前当登录的用户的信息
</span></span><span class=line><span class=cl># who
</span></span><span class=line><span class=cl>huey     pts/1        2015-05-11 18:29 (192.168.1.105)
</span></span><span class=line><span class=cl>sugar    pts/2        2015-05-11 18:29 (192.168.1.105)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 登录的用户及其当前执行的任务
</span></span><span class=line><span class=cl># w
</span></span><span class=line><span class=cl>18:30:51 up 3 min,  2 users,  load average: 0.10, 0.14, 0.06
</span></span><span class=line><span class=cl>USER     TTY      FROM              LOGIN@   IDLE   JCPU   PCPU WHAT
</span></span><span class=line><span class=cl>huey     pts/1    192.168.1.105    18:29    3.00s  0.52s  0.00s w
</span></span><span class=line><span class=cl>sugar    pts/2    192.168.1.105    18:29    1:07   0.47s  0.47s -bash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-----  当前当登录的用户的用户名
</span></span><span class=line><span class=cl># users
</span></span><span class=line><span class=cl>huey sugar
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-----  当前与过去登录系统的用户的信息
</span></span><span class=line><span class=cl># last
</span></span><span class=line><span class=cl>root     pts/3        192.168.1.105    Mon May 11 18:33 - 18:33  (00:00)
</span></span><span class=line><span class=cl>sugar    pts/2        192.168.1.105    Mon May 11 18:32   still logged in
</span></span><span class=line><span class=cl>sugar    pts/2        192.168.1.105    Mon May 11 18:29 - 18:32  (00:02)
</span></span><span class=line><span class=cl>huey     pts/1        192.168.1.105    Mon May 11 18:29   still logged in
</span></span><span class=line><span class=cl>reboot   system boot  3.5.0-43-generic Mon May 11 18:27 - 18:33  (00:05)
</span></span><span class=line><span class=cl>huey     pts/1        192.168.1.105    Sat May  9 10:57 - 17:31  (06:33)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 所有登录系统失败的用户的信息
</span></span><span class=line><span class=cl># lastb
</span></span><span class=line><span class=cl>btmp begins Sat May  9 09:48:59 2015
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 用户最后一次登录的信息
</span></span><span class=line><span class=cl># lastlog
</span></span><span class=line><span class=cl>root             pts/3    192.168.1.105    一  5月 11 18:36:43 +0800 2015
</span></span><span class=line><span class=cl>huey             pts/1    192.168.1.105    一  5月 11 18:29:40 +0800 2015
</span></span><span class=line><span class=cl>mysql                                      **从未登录过**
</span></span><span class=line><span class=cl>sshd                                       **从未登录过**
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 用户连接时间的统计数据
</span></span><span class=line><span class=cl>-----   1. 每天的总的连接时间
</span></span><span class=line><span class=cl># ac -d
</span></span><span class=line><span class=cl>May  9  total        6.55
</span></span><span class=line><span class=cl>Today   total        0.54
</span></span><span class=line><span class=cl>----- 2. 每个用户的总的连接时间
</span></span><span class=line><span class=cl># ac -p
</span></span><span class=line><span class=cl>    huey                                 6.78
</span></span><span class=line><span class=cl>    sugar                                0.23
</span></span><span class=line><span class=cl>    root                                 0.12
</span></span><span class=line><span class=cl>    total        7.13
</span></span></code></pre></div><a class=anchor id=杂项></a><h1>杂项 <a href=#%e6%9d%82%e9%a1%b9 aria-hidden=true>#</a></h1><p>简单记录常用的使用技巧。</p><a class=anchor id=wheel></a><h2>wheel <a href=#wheel aria-hidden=true>#</a></h2><p>wheel 组是一特殊用户组，被一些 Unix 系统用来控制能否通过 su 命令来切换到 root 用户。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ grep &#39;wheel&#39; /etc/group
</span></span><span class=line><span class=cl>wheel:x:10:foo,bar,foobar
</span></span></code></pre></div><p>可以配置成非 wheel 组的用户不能通过 su 命令切换到 root 用户。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ grep &#39;pam_wheel&#39; /etc/pam.d/su
</span></span><span class=line><span class=cl>auth            required        pam_wheel.so use_uid
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ grep &#39;WHEEL&#39; /etc/login.defs
</span></span><span class=line><span class=cl>SU_WHEEL_ONLY yes
</span></span></code></pre></div><p>这时非 wheel 组的成员用 su 命令切换到 root 时提示权限不够，而用 wheel 组的成员切换没任何问题。</p><a class=anchor id=忘记密码></a><h2>忘记密码 <a href=#%e5%bf%98%e8%ae%b0%e5%af%86%e7%a0%81 aria-hidden=true>#</a></h2><p>如果是普通用户的密码丢失，主要 root 用户可以登陆，那么就可以直接 root 用户登陆，通过 <code>passwd &lt;UserName></code> 重新配置对应用户的密码即可。</p><p>对于 root 用户来说比较麻烦些，需要重启进入 grub 界面中，通过 <code>e</code> 进入编辑方式，添加 single 参数 (也就是进入单用户模式)，登陆之后，通过 <code>passwd</code> 命令修改密码即可。</p><p>也可以通过 U 盘启动一个小的 Linux 操作系统，例如 Puppy ，然后将原系统的根目录挂载，直接修改 <code>/etc/shadow</code> 文件，将 root 对应的记录删除，这样无需密码就可以通过 root 登陆，然后再通过 <code>passwd</code> 命令修改密码。</p><a class=anchor id=登陆提示信息></a><h2>登陆提示信息 <a href=#%e7%99%bb%e9%99%86%e6%8f%90%e7%a4%ba%e4%bf%a1%e6%81%af aria-hidden=true>#</a></h2><p>通过终端登陆时 (一般是服务器) ，可以自己定义一些欢迎界面，这样可以针对环境、运行的产品等进行定制，方便用户识别当前登陆的机器。</p><p>涉及的有两个配置文件 <code>/etc/issue</code> 以及 <code>/etc/motd</code>，其中前者为登陆前的提示，后者为登陆后的提示信息。对于 CentOS 来说，可以通过 <code>Ctrl+Alt+F5</code> 切换到终端登陆。</p><p>如下为 CentOS 8 的默认设置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 提示信息为
</span></span><span class=line><span class=cl>CentOS Linux 8 (Core)
</span></span><span class=line><span class=cl>Kernel 4.18.0-193.14.2.el8_2.x86_64 on an X86_64
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 其中/etc/issue配置为
</span></span><span class=line><span class=cl>\S
</span></span><span class=line><span class=cl>Kernel \r on an \m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 配置文件中各个选项的含义为：
</span></span><span class=line><span class=cl>    \d 本地端时间的日期；
</span></span><span class=line><span class=cl>    \l 显示第几个终端机接口；
</span></span><span class=line><span class=cl>    \m 显示硬件的等级 (i386/i486/i586/i686)；
</span></span><span class=line><span class=cl>    \n 显示主机的网络名称；
</span></span><span class=line><span class=cl>    \o 显示 domain name；
</span></span><span class=line><span class=cl>    \r 操作系统的版本 (相当于 uname -r)
</span></span><span class=line><span class=cl>    \t 显示本地端时间的时间；
</span></span><span class=line><span class=cl>    \s 操作系统的名称；
</span></span><span class=line><span class=cl>    \v 操作系统的版本
</span></span></code></pre></div><p>其中 motd 为 <code>Message Of ToDay</code> 的简称，也就是布告栏信息，每次用户登陆的时候都会将该信息显示在终端，可以添加些维护信息之类的。不过缺点是，如果是图形界面，会看不到这些信息。</p><p>一个对于 ROOT 用户常见的提示如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>We trust you have received the usual lecture from the local System Administrator.
</span></span><span class=line><span class=cl>It usually boils down to these three things:
</span></span><span class=line><span class=cl>	#1) Respect the privacy of others.
</span></span><span class=line><span class=cl>	#2) Think before you type.
</span></span><span class=line><span class=cl>	#3) With great power comes great responsibility.
</span></span></code></pre></div><a class=anchor id=系统用户使用></a><h2>系统用户使用 <a href=#%e7%b3%bb%e7%bb%9f%e7%94%a8%e6%88%b7%e4%bd%bf%e7%94%a8 aria-hidden=true>#</a></h2><p>当排查系统用户是否有访问权限时，可以通过如下方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 如果有次要用户组，会切换所有次要用户组
</span></span><span class=line><span class=cl># su - monitor -s /bin/bash -c &#39;cat /your/file/path&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 即使有多个次要用户组，也只会切换到指定用户组
</span></span><span class=line><span class=cl># su - monitor -g monitor -s /bin/bash -c &#39;cat /tmp/mysql.test&#39;
</span></span></code></pre></div><a class=anchor id=过期设置></a><h2>过期设置 <a href=#%e8%bf%87%e6%9c%9f%e8%ae%be%e7%bd%ae aria-hidden=true>#</a></h2><p>通过如下方法设置过期条件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># useradd USER -e 01/28/12               # 创建用户时指定过期条件
</span></span><span class=line><span class=cl># grep EXPIRE /etc/default/useradd       # 或者修改模板对应的默认参数
</span></span><span class=line><span class=cl># useradd -D -e 01/19/12                 # 修改默认新建帐户过期时间
</span></span><span class=line><span class=cl># useradd -D | grep EXPIR                # 查看
</span></span><span class=line><span class=cl># chage -l USER                          # 查看用户的过期时间
</span></span><span class=line><span class=cl># usermod -e 01/28/12 USER               # 修改用户属性
</span></span><span class=line><span class=cl># chage -E 01/28/12 USER                 # 调整账户过期时间
</span></span></code></pre></div><a class=anchor id=锁用户></a><h2>锁用户 <a href=#%e9%94%81%e7%94%a8%e6%88%b7 aria-hidden=true>#</a></h2><p>可以手动锁用户。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 锁用户，两者功能相同
</span></span><span class=line><span class=cl>passwd -l username
</span></span><span class=line><span class=cl>usermod -L username
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 解锁用户
</span></span><span class=line><span class=cl>passwd -u username
</span></span><span class=line><span class=cl>usermod -U username
</span></span></code></pre></div><a class=anchor id=密码过期></a><h2>密码过期 <a href=#%e5%af%86%e7%a0%81%e8%bf%87%e6%9c%9f aria-hidden=true>#</a></h2><p>当密码过期之后，会按照上述的 PAM 配置重新设置，如果想保持源密码不变，可以先通过 <code>>/etc/security/opasswd</code> 清空之前的记录。</p></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#用户组>用户组</a></li><li><a href=#使用示例>使用示例</a></li></ul></li><li><a href=#相关配置文件>相关配置文件</a><ul><li><a href=#etcpasswd>/etc/passwd</a></li><li><a href=#etcshadow>/etc/shadow</a></li><li><a href=#ectgroup>/ect/group</a></li><li><a href=#etcskel>/etc/skel/</a></li></ul></li><li><a href=#用户管理>用户管理</a><ul><li><a href=#查看用户>查看用户</a></li><li><a href=#创建用户>创建用户</a></li><li><a href=#删除用户>删除用户</a></li><li><a href=#修改用户>修改用户</a></li></ul></li><li><a href=#用户提权>用户提权</a><ul><li><a href=#粘滞位>粘滞位</a></li><li><a href=#sudoer>sudoer</a></li><li><a href=#sudo-vs-su>sudo VS. su</a></li></ul></li><li><a href=#审计>审计</a></li><li><a href=#杂项>杂项</a><ul><li><a href=#wheel>wheel</a></li><li><a href=#忘记密码>忘记密码</a></li><li><a href=#登陆提示信息>登陆提示信息</a></li><li><a href=#系统用户使用>系统用户使用</a></li><li><a href=#过期设置>过期设置</a></li><li><a href=#锁用户>锁用户</a></li><li><a href=#密码过期>密码过期</a></li></ul></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>