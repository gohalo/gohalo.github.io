<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Rust 与不同语言调用 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="简单介绍 Rust 和 C 之间的相互代码调用。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>Rust 与不同语言调用</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2021-09-18</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/language/ role=button>language</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/rust/ role=button>rust</a></div></div><hr><div class=content><p>简单介绍 Rust 和 C 之间的相互代码调用。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p>首先简单介绍如何通过动态库、静态库进行相互调用，除了单独使用之外，还可以通过 Rust 的 <code>build.rs</code> 管理编译过程。</p><a class=anchor id=自动编译></a><h1>自动编译 <a href=#%e8%87%aa%e5%8a%a8%e7%bc%96%e8%af%91 aria-hidden=true>#</a></h1><p><code>Cargo</code> 提供了 <code>build.rs</code> 机制，工程目录下存在 <code>build.rs</code> 文件时，则先编译并执行 <code>build.rs</code>，并将其输出的作为 <code>rustc</code> 编译参数，然后再编译 <code>Rust</code> 工程，这样就可以先编译 C 代码，并将相关参数传递给 <code>rustc</code> 编译。</p><p>简单示例可以使用 <code>Makefile</code>，复杂工程建议使用 <code>CMake</code> 类似管理，如下以 <code>CMake</code> 为例进行介绍。</p><a class=anchor id=cmake></a><h2>CMake <a href=#cmake aria-hidden=true>#</a></h2><p>对应的 <code>CMakeLists.txt</code> 文件为。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>CMAKE_MINIMUM_REQUIRED</span><span class=p>(</span><span class=s>VERSION</span> <span class=s>3.9</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>PROJECT</span><span class=p>(</span><span class=s>sysx</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>SRC_LIST</span> <span class=s>src/math.c</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>LIB_STATIC_NAME</span> <span class=o>${</span><span class=nv>PROJECT_NAME</span><span class=o>}</span><span class=s>-static</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET</span><span class=p>(</span><span class=s>LIB_SHARED_NAME</span> <span class=o>${</span><span class=nv>PROJECT_NAME</span><span class=o>}</span><span class=s>-shared</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>ADD_LIBRARY</span><span class=p>(</span><span class=o>${</span><span class=nv>LIB_STATIC_NAME</span><span class=o>}</span> <span class=s>STATIC</span> <span class=o>${</span><span class=nv>SRC_LIST</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET_TARGET_PROPERTIES</span><span class=p>(</span><span class=o>${</span><span class=nv>LIB_STATIC_NAME</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>OUTPUT_NAME</span> <span class=o>${</span><span class=nv>PROJECT_NAME</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>ADD_LIBRARY</span><span class=p>(</span><span class=o>${</span><span class=nv>LIB_SHARED_NAME</span><span class=o>}</span> <span class=s>SHARED</span> <span class=o>${</span><span class=nv>SRC_LIST</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>SET_TARGET_PROPERTIES</span><span class=p>(</span><span class=o>${</span><span class=nv>LIB_SHARED_NAME</span><span class=o>}</span> <span class=s>PROPERTIES</span> <span class=s>OUTPUT_NAME</span> <span class=o>${</span><span class=nv>PROJECT_NAME</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>INSTALL</span><span class=p>(</span><span class=s>TARGETS</span> <span class=o>${</span><span class=nv>LIB_STATIC_NAME</span><span class=o>}</span> <span class=s>DESTINATION</span> <span class=s>.</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>INSTALL</span><span class=p>(</span><span class=s>TARGETS</span> <span class=o>${</span><span class=nv>LIB_SHARED_NAME</span><span class=o>}</span> <span class=s>DESTINATION</span> <span class=s>.</span><span class=p>)</span><span class=err>
</span></span></span></code></pre></div><p>项目会依赖 <code>cmake-rs</code> 三方库，可以通过 <code>cargo add --build cmake</code> 添加，同时需要确保在 <code>CMakeLists.txt</code> 文件中包含 <code>install</code> 目标，对应的 <code>build.rs</code> 代码如下，此时会在 <code>target/debug</code> 目录下生成对应二进制文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 通过 CMake 生成对应的库，可以时动态或者静态库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>cmake</span>::<span class=n>Config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>dst</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Config</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;ansic&#34;</span><span class=p>).</span><span class=n>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 若 build.rs 有任何修改，则重新编译
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;cargo:rerun-if-changed=build.rs&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 搜索生成的函数库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;cargo:rustc-link-search=native=</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>dst</span><span class=p>.</span><span class=n>display</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 链接生成的函数库，可以是动态或者静态库，这里选择静态库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;cargo:rustc-link-lib=static=sysx&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//println!(&#34;cargo:rustc-link-lib=dylib=sysx&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>如果不想引入依赖，那么就可以通过命令编译，对应的 <code>build.rs</code> 示例如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>process</span>::<span class=n>Command</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>libs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;libsysx&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>target</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;target/libsysx&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>std</span>::<span class=n>fs</span>::<span class=n>create_dir</span><span class=p>(</span><span class=n>target</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Command</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;cmake&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>args</span><span class=p>(</span><span class=o>&amp;</span><span class=p>[</span><span class=s>&#34;-S&#34;</span><span class=p>,</span><span class=w> </span><span class=n>libs</span><span class=p>,</span><span class=w> </span><span class=s>&#34;-B&#34;</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>status</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Command</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;cmake&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>args</span><span class=p>(</span><span class=o>&amp;</span><span class=p>[</span><span class=s>&#34;--build&#34;</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>status</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;cargo:rerun-if-changed=build.rs&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;cargo:rustc-link-search=native=</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;cargo:rustc-link-lib=static=sysx&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>注意，当前两种方式并不会检查 <code>C</code> 库的修改，所以，修改后需要先 <code>cargo clean</code> 然后再编译。</p><a class=anchor id=类型使用></a><h1>类型使用 <a href=#%e7%b1%bb%e5%9e%8b%e4%bd%bf%e7%94%a8 aria-hidden=true>#</a></h1><p>大部分的基础类型都在 <code>std::os::raw</code> 中定义，其有很多是与 <code>libc</code> 包重叠的，如何选择详见如下的介绍，结构体调用则需要添加 <code>#[repr(C)]</code> 注解。</p><p>如果在结构体中定义了动态数组，也就是包含一个 <code>num</code> 确定数组大小，同时包含指针指向数组，其中指针的初始化可以通过 <code>std::ptr::null()</code> 或者 <code>std::ptr::mut_null()</code> 实现。</p><a class=anchor id=enum></a><h2>enum <a href=#enum aria-hidden=true>#</a></h2><p>在 C 语言中，对应的 <code>enum</code> 相当于整形，但是规范上有如下的描述。</p><blockquote><p>Each enumerated type shall be compatible with char, a signed integer type, or an unsigned integer type. The choice of type is implementation-defined, but shall be capable of representing the values of all the members of the enumeration.</p></blockquote><p>也就是说，根据不同编译器实现有所区别，而且编译时还可以通过 <code>-fshort-enum</code> 参数调整。</p><p>而在 Rust 中，在内存上来说，其开头还存在了 <code>tag</code> 信息，所以，有些场景下可以修改为如下的常量方式，例如作为数组的索引，可定义为 <code>const F_IDX: usize = 0</code> 这种方式。</p><a class=anchor id=常量></a><h2>常量 <a href=#%e5%b8%b8%e9%87%8f aria-hidden=true>#</a></h2><p>在 C 中可能会通过 <code>#define F_ALL (1 &lt;&lt; 1)</code> 方式定义标志位常量，同样在 Rust 中可以修改为 <code>const F_ALL: u32 = (1 &lt;&lt; 1)</code> 类似参数。</p><a class=anchor id=注意事项></a><h2>注意事项 <a href=#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9 aria-hidden=true>#</a></h2><a class=anchor id=不要使用-bool></a><h3>不要使用 bool <a href=#%e4%b8%8d%e8%a6%81%e4%bd%bf%e7%94%a8-bool aria-hidden=true>#</a></h3><p>在 <code>stdbool.h</code> 头文件中包含了定义，在 <code>clang-16</code> 内容如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define bool _Bool
</span></span></span><span class=line><span class=cl><span class=cp>#define true 1
</span></span></span><span class=line><span class=cl><span class=cp>#define false 0
</span></span></span></code></pre></div><p>而 <code>_Bool</code> 是 C99 引入的 <a href=https://en.cppreference.com/w/c/keyword/_Bool>关键字</a>，但是，Rust 中的 <code>std::os::raw</code> 只定义了常规的类型，包含了如下类型。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=fm>alias_core_ffi!</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c_char</span><span class=w> </span><span class=n>c_schar</span><span class=w> </span><span class=n>c_uchar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c_short</span><span class=w> </span><span class=n>c_ushort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c_int</span><span class=w> </span><span class=n>c_uint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c_long</span><span class=w> </span><span class=n>c_ulong</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c_longlong</span><span class=w> </span><span class=n>c_ulonglong</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c_float</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c_double</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>c_void</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><a class=anchor id=调用实践></a><h1>调用实践 <a href=#%e8%b0%83%e7%94%a8%e5%ae%9e%e8%b7%b5 aria-hidden=true>#</a></h1><p>常见的一些场景就是参数传递、内存管理。</p><a class=anchor id=特征调用></a><h2>特征调用 <a href=#%e7%89%b9%e5%be%81%e8%b0%83%e7%94%a8 aria-hidden=true>#</a></h2><p>Rust 中的 <code>trait object</code> 采用的是胖指针，一般会在 Rust 中定义对应的特征，通过 C 实现对应的函数，如果需要，可以用 Rust 实现相关的结构对函数进行封装，例如 <a href=/cn/blog/rust-advanced-syntax-trait/>Rust Trait</a> 中的示例。</p><p>另外，还有一种场景，在 Rust 中提供了函数，不过其入参是 <code>dyn</code> 类型，例如 Log 的实现，此时需要通过 Rust 的回调函数调用，这里就以此为例介绍如何处理。</p><a class=anchor id=异步调用></a><h1>异步调用 <a href=#%e5%bc%82%e6%ad%a5%e8%b0%83%e7%94%a8 aria-hidden=true>#</a></h1><p>这一部分会比较复杂，单独拆出来，通过 <code>python3 -m http.server 9090</code> 命令，在本地启动一个静态文件服务器，如下是通过 <code>tokio</code> 和 <code>reqwest</code> 简单读取某个文件内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>reqwest</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reqwest</span>::<span class=n>Client</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=s>&#34;http://127.0.0.1:9090/test.md&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>send</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>text</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>body</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>如下是简单实现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>once_cell</span>::<span class=n>sync</span>::<span class=n>Lazy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ffi</span>::<span class=p>{</span><span class=n>CStr</span><span class=p>,</span><span class=w> </span><span class=n>CString</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>os</span>::<span class=n>raw</span>::<span class=n>c_char</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ptr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>sync</span>::<span class=p>{</span><span class=n>Arc</span><span class=p>,</span><span class=w> </span><span class=n>Mutex</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tokio</span>::<span class=n>runtime</span>::<span class=n>Runtime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>static</span><span class=w> </span><span class=no>RUNTIME</span>: <span class=nc>Lazy</span><span class=o>&lt;</span><span class=n>Runtime</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Lazy</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=n>Runtime</span>::<span class=n>new</span><span class=p>().</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>ReqContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>complete</span>: <span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>response</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>request_send</span><span class=p>(</span><span class=n>ptr</span>: <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>c_char</span><span class=p>)</span><span class=w> </span>-&gt; <span class=o>*</span><span class=k>mut</span><span class=w> </span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>ReqContext</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>url</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>CStr</span>::<span class=n>from_ptr</span><span class=p>(</span><span class=n>ptr</span><span class=p>).</span><span class=n>to_str</span><span class=p>().</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;bad encoding&#34;</span><span class=p>)</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>req_ctx_raw</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arc</span>::<span class=n>new</span><span class=p>(</span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=n>ReqContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>complete</span>: <span class=nc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>response</span>: <span class=nb>None</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Rust handle send for </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>req_ctx_clone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req_ctx_raw</span><span class=p>.</span><span class=n>clone</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>move</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>reqwest</span>::<span class=n>Client</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>send</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>text</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Rust </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>body</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req_ctx_raw</span><span class=p>.</span><span class=n>lock</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>res</span><span class=p>.</span><span class=n>complete</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>res</span><span class=p>.</span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>body</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>RUNTIME</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=n>future</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Box</span>::<span class=n>into_raw</span><span class=p>(</span><span class=nb>Box</span>::<span class=n>new</span><span class=p>(</span><span class=n>req_ctx_clone</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>request_is_complete</span><span class=p>(</span><span class=n>ptr</span>: <span class=o>*</span><span class=k>mut</span><span class=w> </span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>ReqContext</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kt>bool</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>ctx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>assert!</span><span class=p>(</span><span class=o>!</span><span class=n>ptr</span><span class=p>.</span><span class=n>is_null</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;*</span><span class=n>ptr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=n>try_lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>res</span><span class=p>.</span><span class=n>is_ok</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>res</span><span class=p>.</span><span class=n>unwrap</span><span class=p>().</span><span class=n>complete</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>request_get_result</span><span class=p>(</span><span class=n>ptr</span>: <span class=o>*</span><span class=k>mut</span><span class=w> </span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>ReqContext</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=o>*</span><span class=k>const</span><span class=w> </span><span class=n>c_char</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>ctx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>assert!</span><span class=p>(</span><span class=o>!</span><span class=n>ptr</span><span class=p>.</span><span class=n>is_null</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;*</span><span class=n>ptr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=n>try_lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>res</span><span class=p>.</span><span class=n>is_ok</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>body</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>res</span><span class=p>.</span><span class=n>unwrap</span><span class=p>().</span><span class=n>response</span><span class=p>.</span><span class=n>as_ref</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>CString</span>::<span class=n>new</span><span class=p>(</span><span class=n>body</span><span class=p>.</span><span class=n>as_str</span><span class=p>()).</span><span class=n>unwrap</span><span class=p>().</span><span class=n>into_raw</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ptr</span>::<span class=n>null</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>request_free_body</span><span class=p>(</span><span class=n>ptr</span>: <span class=o>*</span><span class=k>mut</span><span class=w> </span><span class=n>c_char</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>ptr</span><span class=p>.</span><span class=n>is_null</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nb>drop</span><span class=p>(</span><span class=n>CString</span>::<span class=n>from_raw</span><span class=p>(</span><span class=n>ptr</span><span class=p>))</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[no_mangle]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>extern</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w> </span><span class=k>fn</span> <span class=nf>request_free</span><span class=p>(</span><span class=n>ptr</span>: <span class=nb>Box</span><span class=o>&lt;</span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>ReqContext</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>drop</span><span class=p>(</span><span class=n>ptr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>reqwest</span> <span class=o>*</span><span class=nf>request_send</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>request_is_complete</span><span class=p>(</span><span class=k>struct</span> <span class=n>reqwest</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=nf>request_get_result</span><span class=p>(</span><span class=k>struct</span> <span class=n>reqwest</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>request_free_body</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>request_free</span><span class=p>(</span><span class=k>struct</span> <span class=n>reqwest</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>reqwest</span> <span class=o>*</span><span class=n>req</span> <span class=o>=</span> <span class=nf>request_send</span><span class=p>(</span><span class=s>&#34;http://127.0.0.1:9090/data.txt&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=nf>request_is_complete</span><span class=p>(</span><span class=n>req</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Waiting for fetching data.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>body</span> <span class=o>=</span> <span class=nf>request_get_result</span><span class=p>(</span><span class=n>req</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>body</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Got data: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>body</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>request_free_body</span><span class=p>(</span><span class=n>body</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Got empty data</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>request_free</span><span class=p>(</span><span class=n>req</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>编译过程中建议使用静态库，同时添加 OpenSSL 的依赖 <code>-lssl -lcrypto -lm</code> 库。</p><a class=anchor id=其它></a><h1>其它 <a href=#%e5%85%b6%e5%ae%83 aria-hidden=true>#</a></h1><a class=anchor id=libc></a><h2>libc <a href=#libc aria-hidden=true>#</a></h2><p><a href=https://github.com/rust-lang/libc>libc</a> 是对各个平台库的原始 FFI 绑定，用于与最基础的 C 库交互，支持 <code>std/no-std</code> 场景，提供了 C 相关的类型、常量、函数、宏等内容，使用时需要通过 <code>unsafe</code> 方式调用，</p><p>在使用 <code>FFI</code> 时，在 <code>std::os::*::raw</code> 中也提供了很多类似的类型定义等，可以用于一些简单的 C 代码交互，只要不涉及底层 API 的调用就不需要 <code>libc</code> 库。另外，类似 <code>std::os::unix::raw</code> 模块已经 <code>Deprecated</code> 了，使用时需要注意。</p><a class=anchor id=rust-封装库></a><h2>Rust 封装库 <a href=#rust-%e5%b0%81%e8%a3%85%e5%ba%93 aria-hidden=true>#</a></h2><p>因为历史原因，有很多优秀的 C 库实现，可以参考 <a href=https://github.com/meilisearch/heed>LMDB-RS</a> 的实现，因为 LMDB 存在 <code>mdb.master</code> 和 <code>mdb.master3</code> 两个主干分支，所以存在两个系统库的目录。</p><a class=anchor id=总结></a><h1>总结 <a href=#%e6%80%bb%e7%bb%93 aria-hidden=true>#</a></h1><p>内存谁申请谁释放。不要假设使用何种内存分配器，可能是 <code>tcmalloc</code> <code>jemalloc</code> 等，所以，不要将 <code>malloc</code> 申请的转换为 <code>Box</code> 然后 <code>drop</code> 掉，反之，通过 <code>Box::into_raw()</code> 获取的指针也不要通过 <code>free</code> 释放。</p><p>所有权管理，常见的 <code>Box</code> <code>Arc</code> <code>CStr</code> <code>CString</code> 类型提供了 <code>as_ptr()</code> <code>into_raw()</code> <code>from_raw()</code> 几种与原始指针相关的函数，前者仍然持有对象，会按照 Rust 的规则执行 Drop 操作，而后者，则将所有权进行了转移。</p><a class=anchor id=参考></a><h1>参考 <a href=#%e5%8f%82%e8%80%83 aria-hidden=true>#</a></h1><ul><li><a href=https://doc.rust-lang.org/nomicon/ffi.html>Foreign Function Interface</a> Rust 死灵书中的相关介绍。</li><li><a href=https://github.com/cloudflare/quiche/>Quiche</a> 一个 QUIC/HTTP3 协议库，同时提供了 C 接口，不过均采用同步调用，没有异步接口实现。</li></ul></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#自动编译>自动编译</a><ul><li><a href=#cmake>CMake</a></li></ul></li><li><a href=#类型使用>类型使用</a><ul><li><a href=#enum>enum</a></li><li><a href=#常量>常量</a></li><li><a href=#注意事项>注意事项</a></li></ul></li><li><a href=#调用实践>调用实践</a><ul><li><a href=#特征调用>特征调用</a></li></ul></li><li><a href=#异步调用>异步调用</a></li><li><a href=#其它>其它</a><ul><li><a href=#libc>libc</a></li><li><a href=#rust-封装库>Rust 封装库</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>