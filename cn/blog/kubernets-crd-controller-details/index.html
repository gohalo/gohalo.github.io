<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>K8S Controller 常用命令 | GoHalo</title><link rel=stylesheet href=/static/syntax.css><link rel=stylesheet href=https://gohalo.github.io/main.c459e32cfef70be8c28586c3b8bc93e2.css integrity="md5-xFnjLP73C+jChYbDuLyT4g==" crossorigin=anonymous><style type=text/css>.content-body p{text-indent:2em}.content-body li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="简介 # 在构建自定义的 Operator 时会涉及到如下几种组件：
client-go 底层用于与 K8S API 进行交互，支持资源的 CRUD 操作，包含了 ClientSet、DynamicClient、RESTClient 三种。 controller-runtime 封装了控制器的处理框架，底层会调用 client-go 库。 kubebuilder 可以很方便渲染出 Controller 整个框架，该框架使用的就是 controller-runtime 模块。 operator-sdk 同样基于 controller-runtime 实现，而且同时使用了 kubebuilder 来构建 Go 项目。 简单来说，当前 Controller 的编写包含了 OperatorSDK、Kubebuilder、ClientGo 三种方式，前两者提供了更加实用的封装，而 ClientGo 相对来说要简单很多，这里简单介绍 Kubebuilder 的使用方式。
Kubebuilder # Kubebuilder 由 K8S Special Interest Group, SIG API Machinery 拥有和维护，用于帮助开发者创建 CRD 并生成 Controller 脚手架，包含了如下的组件：
Client 封装了对资源的操作，修改会直接访问 APIServer ，而查询则会访问本地 Cache 信息。 Cache 负责生成 SharedInformer，会监听 GVK 下的 GVR 变化，然后触发 Controller 的 Reconcile 逻辑。 Manager 管理协调多个 Controller，提供共有依赖以及基础服务(例如保活)，负责初始化 Controller、Cache、Client 的工作。 Finzlizers 用于处理资源的预删除逻辑，保障资源被删除后能够从 Cache 中读取到，清理相关的其它资源。 Builder 构造器，提供了一系列配置接口，可以通过链式条用进行组装，最终为 Reconciler 生成相应的 Controller 对象。 示例 # 可以直接从 GitHub Release 上下载对应的二进制文件。"><link rel=canonical href=https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://gohalo.github.io/#/schema/person/1","name":"","url":"https://gohalo.github.io/","sameAs":[],"image":{"@type":"ImageObject","@id":"https://gohalo.github.io/#/schema/image/1","url":"https://gohalo.github.io/\u003cnil\u003e","width":null,"height":null,"caption":""}},{"@type":"WebSite","@id":"https://gohalo.github.io/#/schema/website/1","url":"https://gohalo.github.io/","name":"GoHalo","description":"","publisher":{"@id":"https://gohalo.github.io/#/schema/person/1"}},{"@type":"WebPage","@id":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/","url":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/","name":"K8S Controller 常用命令","description":"","isPartOf":{"@id":"https://gohalo.github.io/#/schema/website/1"},"about":{"@id":"https://gohalo.github.io/#/schema/person/1"},"datePublished":"2023-03-28T21:33:42CET","dateModified":"2023-03-28T21:33:42CET","breadcrumb":{"@id":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/#/schema/image/2"},"inLanguage":"","potentialAction":[{"@type":"ReadAction","target":["https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/"]}]},{"@type":"BreadcrumbList","@id":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://gohalo.github.io/","url":"https://gohalo.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://gohalo.github.io/cn/","url":"https://gohalo.github.io/cn/","name":"Cn"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://gohalo.github.io/cn/blog/","url":"https://gohalo.github.io/cn/blog/","name":"Blog"}},{"@type":"ListItem","position":4,"item":{"@id":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://gohalo.github.io/#/schema/article/1","headline":"K8S Controller 常用命令","description":"","isPartOf":{"@id":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/"},"mainEntityOfPage":{"@id":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/"},"datePublished":"2023-03-28T21:33:42CET","dateModified":"2023-03-28T21:33:42CET","author":{"@id":"https://gohalo.github.io/#/schema/person/2"},"publisher":{"@id":"https://gohalo.github.io/#/schema/person/1"},"image":{"@id":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://gohalo.github.io/#/schema/person/2","name":null,"sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://gohalo.github.io/cn/blog/kubernets-crd-controller-details/#/schema/image/2","url":null,"contentUrl":null,"caption":"K8S Controller 常用命令"}]}]}</script><meta name=theme-color content><link rel=icon href=https://gohalo.github.io/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://gohalo.github.io/logo.svg><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/site.webmanifest></head><body class="blog single"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/cn/>GoHalo</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>项目
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class=dropdown-item href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/cn/blog/>博客</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><article><div class="row justify-content-center"><nav class="toc d-none d-xl-block col-xl-3"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>页面目录</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#kubebuilder>Kubebuilder</a></li></ul></li><li><a href=#示例>示例</a><ul><li><a href=#增加业务逻辑>增加业务逻辑</a></li></ul></li><li><a href=#其它>其它</a><ul><li><a href=#健康检查>健康检查</a></li><li><a href=#监控指标>监控指标</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#kubebuilder>Kubebuilder</a></li></ul></li><li><a href=#示例>示例</a><ul><li><a href=#增加业务逻辑>增加业务逻辑</a></li></ul></li><li><a href=#其它>其它</a><ul><li><a href=#健康检查>健康检查</a></li><li><a href=#监控指标>监控指标</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></nav><div class="blog-wrapper col-md-12 col-xl-9"><div class=blog-header><h1>K8S Controller 常用命令</h1><div class="blog-meta mb-3"><span class=ms-2><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-calendar-check" viewBox="0 0 16 16"><path d="M10.854 7.146a.5.5.0 010 .708l-3 3a.5.5.0 01-.708.0l-1.5-1.5a.5.5.0 11.708-.708L7.5 9.793l2.646-2.647a.5.5.0 01.708.0z"/><path d="M3.5.0a.5.5.0 01.5.5V1h8V.5a.5.5.0 011 0V1h1a2 2 0 012 2v11a2 2 0 01-2 2H2a2 2 0 01-2-2V3a2 2 0 012-2h1V.5a.5.5.0 01.5-.5zM1 4v10a1 1 0 001 1h12a1 1 0 001-1V4H1z"/></svg></span><span class=mx-2>2023-03-28</span>
<span class=mx-2><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-tags" viewBox="0 0 16 16"><path d="M3 2v4.586l7 7L14.586 9l-7-7H3zM2 2a1 1 0 011-1h4.586a1 1 0 01.707.293l7 7a1 1 0 010 1.414l-4.586 4.586a1 1 0 01-1.414.0l-7-7A1 1 0 012 6.586V2z"/><path d="M5.5 5a.5.5.0 110-1 .5.5.0 010 1zm0 1a1.5 1.5.0 100-3 1.5 1.5.0 000 3zM1 7.086a1 1 0 00.293.707L8.75 15.25l-.043.043a1 1 0 01-1.414.0l-7-7A1 1 0 010 7.586V3a1 1 0 011-1v5.086z"/></svg></span><a class="btn btn-light" href=https://gohalo.github.io/tags/container/ role=button>container</a>
<a class="btn btn-light" href=https://gohalo.github.io/tags/k8s/ role=button>k8s</a>
<a class="btn btn-light" href=https://gohalo.github.io/tags/cheatsheet/ role=button>cheatsheet</a></div></div><hr><div class=content-body><h1 id=简介>简介 <a href=#%e7%ae%80%e4%bb%8b class=anchor aria-hidden=true>#</a></h1><p>在构建自定义的 Operator 时会涉及到如下几种组件：</p><ul><li><code>client-go</code> 底层用于与 K8S API 进行交互，支持资源的 CRUD 操作，包含了 ClientSet、DynamicClient、RESTClient 三种。</li><li><code>controller-runtime</code> 封装了控制器的处理框架，底层会调用 <code>client-go</code> 库。</li><li><code>kubebuilder</code> 可以很方便渲染出 Controller 整个框架，该框架使用的就是 <code>controller-runtime</code> 模块。</li><li><code>operator-sdk</code> 同样基于 <code>controller-runtime</code> 实现，而且同时使用了 <code>kubebuilder</code> 来构建 Go 项目。</li></ul><p>简单来说，当前 Controller 的编写包含了 OperatorSDK、Kubebuilder、ClientGo 三种方式，前两者提供了更加实用的封装，而 ClientGo 相对来说要简单很多，这里简单介绍 Kubebuilder 的使用方式。</p><h2 id=kubebuilder>Kubebuilder <a href=#kubebuilder class=anchor aria-hidden=true>#</a></h2><p>Kubebuilder 由 K8S Special Interest Group, SIG API Machinery 拥有和维护，用于帮助开发者创建 CRD 并生成 Controller 脚手架，包含了如下的组件：</p><ul><li>Client 封装了对资源的操作，修改会直接访问 APIServer ，而查询则会访问本地 Cache 信息。</li><li>Cache 负责生成 SharedInformer，会监听 GVK 下的 GVR 变化，然后触发 Controller 的 Reconcile 逻辑。</li><li>Manager 管理协调多个 Controller，提供共有依赖以及基础服务(例如保活)，负责初始化 Controller、Cache、Client 的工作。</li><li>Finzlizers 用于处理资源的预删除逻辑，保障资源被删除后能够从 Cache 中读取到，清理相关的其它资源。</li><li>Builder 构造器，提供了一系列配置接口，可以通过链式条用进行组装，最终为 Reconciler 生成相应的 Controller 对象。</li></ul><h1 id=示例>示例 <a href=#%e7%a4%ba%e4%be%8b class=anchor aria-hidden=true>#</a></h1><p>可以直接从 <a href=https://github.com/kubernetes-sigs/kubebuilder/releases>GitHub Release</a> 上下载对应的二进制文件。</p><pre tabindex=0><code>----- 切换到默认的工作目录
$ cd $GOPATH/src/example.io/hello
----- 初始化项目，会同时下载依赖
$ go mod init example.io/hello
$ kubebuilder init --domain example.io

----- 创建API，会自动生成资源、Controller的定义
$ kubebuilder create api --group batch --version v1 --kind Hello
$ ls api/v1/hello_types.go
$ ls internal/controller/hello_controller.go

----- 安装CRD资源
$ make install
$ kubectl get crd | grep example.io
$ kubectl api-versions | grep example.io
$ kubectl api-resources --namespaced=true | grep example.io

----- 直接本地运行，下面介绍如何部署到K8S中
$ make run

----- 启动CustomResource，初始化项目时已经生成了示例
$ kubectl apply -f config/samples/batch_v1_hello.yaml
$ kubectl get hello
$ kubectl get hellos.batch.example.io hello-sample
$ kubectl delete hellos.batch.example.io hello-sample
</code></pre><p>也可以将 Controller 以 Deployment 的方式部署到 K8S 集群上。</p><pre tabindex=0><code>----- 构建镜像并Push到DockerHub上，然后部署到K8S集群
make docker-build docker-push IMG=YourRepo/kubebuilder-example:latest
make deploy IMG=YourRepo/kubebuilder-example:latest
----- 在初始化项目时会自动创建一个Namespace配置
$ kubectl get deployment -n kubebuilder-example-system
$ kubectl get pod -n kubebuilder-example-system
</code></pre><h2 id=增加业务逻辑>增加业务逻辑 <a href=#%e5%a2%9e%e5%8a%a0%e4%b8%9a%e5%8a%a1%e9%80%bb%e8%be%91 class=anchor aria-hidden=true>#</a></h2><p>这里简单通过 Spec 将信息传递给资源，然后打印与 CRD 相关的信息，修改 <code>api/v1/hello_types.go</code> 文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>HelloSpec</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Message</span> <span class=kt>string</span> <span class=s>`json:&#34;message,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>HelloStatus</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Status</span> <span class=kt>string</span> <span class=s>`json:&#34;status&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>以及 <code>internal/controller/hello_controller.go</code> 文件，关键是 <code>Reconcile</code> 函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>HelloReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span> <span class=o>:=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>FromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>obj</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>batchv1</span><span class=p>.</span><span class=nx>Hello</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>,</span> <span class=nx>obj</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Unable to fetch object&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Geeting from Kubebuilder&#34;</span><span class=p>,</span> <span class=s>&#34;message&#34;</span><span class=p>,</span> <span class=nx>obj</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>obj</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Status</span> <span class=p>=</span> <span class=s>&#34;Running&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Status</span><span class=p>().</span><span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>obj</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Unable to update status&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>修改完后类似如上的方式编译运行。</p><pre tabindex=0><code>----- 本地运行
$ make run
----- 修改CR文件，增加参数
$ vim config/samples/batch_v1_hello.yaml
apiVersion: batch.example.io/v1
kind: Hello
metadata:
  name: hello-sample
spec:
  message: HelloWorld
----- 应用到K8S
$ kubectl apply -f config/samples/batch_v1_hello.yaml
</code></pre><h1 id=其它>其它 <a href=#%e5%85%b6%e5%ae%83 class=anchor aria-hidden=true>#</a></h1><h2 id=健康检查>健康检查 <a href=#%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5 class=anchor aria-hidden=true>#</a></h2><p>内部集成了健康检查功能，可以通过 <code>Manager.AddHealthzCheck()</code> 和 <code>Manager.AddReadyzCheck()</code> 注册监控检查逻辑，其端口和路径可以在如下的 <code>Options</code> 中配置，然后通过 <code>Manager.Start()</code> 启动时会同时包含一个 HTTP Server 提供监控检查的返回结果。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Options</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// HealthProbeBindAddress is the TCP address that the controller should bind to
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// for serving health probes
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>HealthProbeBindAddress</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Readiness probe endpoint name, defaults to &#34;readyz&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ReadinessEndpointName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Liveness probe endpoint name, defaults to &#34;healthz&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>LivenessEndpointName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=监控指标>监控指标 <a href=#%e7%9b%91%e6%8e%a7%e6%8c%87%e6%a0%87 class=anchor aria-hidden=true>#</a></h2><p>在 <code>pkg/metrics</code> 和 <code>pkg/internal/controller/metrics</code> 中内置了很多模块的监控指标，同样可以在 <code>Options.MetricsBindAddress</code> 中配置，包括通过 <code>pkg/metrics</code> 中的 Registry 自定义监控指标。</p><h1 id=参考>参考 <a href=#%e5%8f%82%e8%80%83 class=anchor aria-hidden=true>#</a></h1><ul><li><a href=https://book.kubebuilder.io/introduction>Book Kubebuilder</a> 官方的介绍。</li><li><a href=https://github.com/docker-library/memcached>GitHub Memcache Docker</a> 包含了官方的 Dockerfile 制作文件，通常在 <a href=https://github.com/docker-library/official-images/>Docker Library</a> 中维护，文档信息可以查看 <a href=https://github.com/docker-library/docs>Docs</a> 。</li></ul></div></div></div></article><div class=related-posts><hr><div class="row justify-content-center"><div class=col><h2 class=section-title>相关阅读</h2></div></div><ul><li><a class=text-body href=/cn/blog/kubernets-commands-usage/>K8S 常用命令</a></li><li><a class=text-body href=/cn/blog/kubernets-crd-sample/>CRD 使用详解</a></li><li><a class=text-body href=/cn/blog/kubernets-minimal-kind-cluster/>K8S 本地集群 Kind 使用介绍</a></li></ul></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="order-first order-lg-last text-center"><ul class=list-inline><li class=list-inline-item><a href=/privacy-policy/>隐私声明</a></li></ul></div></div><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2024 GoHalo. All Rights Reserved.</div></div></div></footer></body></html>