<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>ZeroMQ 简介 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="ZMQ (Zero Message Queue) 是一个 C++ 编写的高性能分布式消息队列，是一个非常简单好用的传输层，使得 Socket 编程更加简单、简洁和性能更高效。
目前比较常用的消息中间件产品包括了 RabbitMQ、ZeroMQ、ActiveMQ，三者分别通过　Erlang、C++、Java 实现，相比而言，ZMQ 是一个简单的库，而非单独的中间件产品。
接下来简单介绍一下 ZMQ 的相关内容。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>ZeroMQ 简介</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2016-06-10</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/linux/ role=button>linux</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/language/ role=button>language</a></div></div><hr><div class=content><p>ZMQ (Zero Message Queue) 是一个 C++ 编写的高性能分布式消息队列，是一个非常简单好用的传输层，使得 Socket 编程更加简单、简洁和性能更高效。</p><p>目前比较常用的消息中间件产品包括了 RabbitMQ、ZeroMQ、ActiveMQ，三者分别通过　Erlang、C++、Java 实现，相比而言，ZMQ 是一个简单的库，而非单独的中间件产品。</p><p>接下来简单介绍一下 ZMQ 的相关内容。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p><a href=http://zeromq.org/>ZMQ (Zero Message Queue)</a> 的资料非常全，相关的资料基本都保存在 <a href=http://zeromq.org/community>zeromq.org - community</a> 中，例如一些经常使用的链接包括了示例 <a href=http://zguide.zeromq.org/page:all>ZMQ - The Guide</a>、相关的设计文档 <a href=http://zeromq.org/area:whitepapers>Interesting Whitepapers</a>、及各种语言的示例程序 <a href=https://github.com/imatix/zguide/tree/master/examples/>Github Zguide Examples</a> 。</p><p>ZMQ 的作者是 Martin Sustrik，其中的绝大多数的代码是由他来维护的，可以看下源码中的 MAINTAINERS 文件。另外，他还维护了：<a href=http://nanomsg.org>nanomsg</a> 封装了网络编程中常见的模型、<a href=http://libmill.org>libmill</a> 基于 C 的类 Go 库，据说可以支持 2KW 个协程，每秒 5KW 次上下文切换 (没有给出硬件配置，不过如果属实，性能确实有点恐怖)。</p><a class=anchor id=advanced-message-queuing-protocol></a><h2>Advanced Message Queuing Protocol <a href=#advanced-message-queuing-protocol aria-hidden=true>#</a></h2><p><a href=http://www.amqp.org/>AMQP</a>，高级消息队列协议，一个应用层的开放标准协议，为面向消息的中间件而设计，主要用于各个组件之间的解耦，基于该协议的客户端与消息中间件可以自由传递消息，消息的发送者无需知道消息使用者的存在，反之亦然。</p><p>AMQP 协议的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全，是一种二进制协议，提供客户端应用与消息中间件之间异步、安全、高效地交互。目前，AMQP 1.0 已经成了国际标准，可以直接从官网下载相关的文档。</p><p>RabbitMQ 是一个开源的 AMQP 实现，服务器端使用 Erlang 语言编写，支持多种客户端，例如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等。</p><p>不过 ZMQ 并非基于 AMQP 协议的实现，两者的区别可以参考 <a href=http://zeromq.org/docs:welcome-from-amqp>Welcome from AMQP</a> 。</p><a class=anchor id=zmq-安装></a><h2>ZMQ 安装 <a href=#zmq-%e5%ae%89%e8%a3%85 aria-hidden=true>#</a></h2><p>在 CentOS7 中可以直接通过如下命令安装，依赖 EPEL；另外 czmq 是对 ZMQ 的封装。目前 ZMQ 已经到了 Version 4，可以不指定版本号直接安装最新的，或者安装指定的版本。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 安装最新的V4版本
</span></span><span class=line><span class=cl># yum --enablerepo=epel install zeromq zeromq-devel czmq
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 安装V3版本
</span></span><span class=line><span class=cl># yum --enablerepo=epel install zeromq3 zeromq3-devel czmq
</span></span></code></pre></div><p>当然可以通过源码进行编译安装，ZMQ 依赖一个加密库 libsodium ，可以直接通过 yum 进行安装。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># yum --enablerepo=epel install libsodium-devel
</span></span></code></pre></div><p>源码可以直接从 <a href=https://github.com/zeromq>Github ZeroMQ</a> 上下载，包括了 libzmq 在内的各种源码。编译也非常简单，直接通过如下方式编译即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 最简单的编译方法，默认安装在/usr/local目录下
</span></span><span class=line><span class=cl>$ ./configure &amp;&amp; make
</span></span><span class=line><span class=cl># make install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 也可以指定不依赖于sodium库
</span></span><span class=line><span class=cl>$ ./configure --prefix=/usr --without-libsodium &amp;&amp; make
</span></span><span class=line><span class=cl># make install
</span></span></code></pre></div><p>ZMQ 提供了三个基本的通信模型，分别是 &ldquo;Request-Reply&rdquo;、&ldquo;Publisher-Subscriber&rdquo;、&ldquo;Parallel Pipeline&rdquo;，接下来通过示例看看应该如何使用 ZMQ 。</p><a class=anchor id=示例></a><h1>示例 <a href=#%e7%a4%ba%e4%be%8b aria-hidden=true>#</a></h1><p>相关的文档可以直接参考 <a href=http://zguide.zeromq.org/page:all>ZMQ - The Guide</a>，而示例程序保存在 <a href=https://github.com/imatix/zguide/tree/master/examples/>Github Zguide Examples</a>，在此我们将使用 C/C++ 为例，主要以 C++ 为例。</p><p>对于 C++ 程序，从 ZMQ-3.2 后，zmq.hpp 被移到了 <a href=https://github.com/zeromq/cppzmq>cppzmq github</a> 中，可以直接下载 zmq.hpp 文件，然后保存到 /usr/include 目录下即可，或者通过 yum 安装。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># yum --enablerepo=epel install cppzmq-devel
</span></span></code></pre></div><p>而对于 C 程序，会依赖于 <a href=https://github.com/zeromq/czmq>czmq github</a>，在 CentOS 中可以直接通过如下命令安装。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># yum --enablerepo=epel install czmq czmq-devel
</span></span></code></pre></div><p>然后可以直接在 zguide 目录下通过如下方式编译。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 调转到示例目录下
</span></span><span class=line><span class=cl>$ cd examples/C++
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 编译单个示例程序hwclient
</span></span><span class=line><span class=cl>$ ./build hwclient
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 编译所有的示例程序
</span></span><span class=line><span class=cl>$ ./build all
</span></span></code></pre></div><p>接下来看看一些示例。</p><a class=anchor id=request-reply></a><h2>Request-Reply <a href=#request-reply aria-hidden=true>#</a></h2><p>一个非常简单的 Hello World 程序，服务端接收客户端请求 &ldquo;Hello&rdquo; 字符串，并将 &ldquo;World&rdquo; 字符串返回给客户端。</p><p><img alt="ZeroMQ Examples Request Reply Mode" src=images/zmq-examples-request-reply.svg class="mx-auto d-block"></p><p>服务端程序 hwserver.cpp 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;zmq.hpp&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span> <span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//  Prepare our context and socket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>zmq</span><span class=o>::</span><span class=n>context_t</span> <span class=n>context</span> <span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>zmq</span><span class=o>::</span><span class=n>socket_t</span> <span class=n>socket</span> <span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>ZMQ_REP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>socket</span><span class=p>.</span><span class=n>bind</span> <span class=p>(</span><span class=s>&#34;tcp://*:5555&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>zmq</span><span class=o>::</span><span class=n>message_t</span> <span class=n>request</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//  Wait for next request from client
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>socket</span><span class=p>.</span><span class=n>recv</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Received Hello&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//  Do some &#39;work&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//  Send reply back to client
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>zmq</span><span class=o>::</span><span class=n>message_t</span> <span class=n>reply</span> <span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>memcpy</span> <span class=p>(</span><span class=n>reply</span><span class=p>.</span><span class=n>data</span> <span class=p>(),</span> <span class=s>&#34;World&#34;</span><span class=p>,</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>socket</span><span class=p>.</span><span class=n>send</span> <span class=p>(</span><span class=n>reply</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>客户端程序 hwclient.cpp 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;zmq.hpp&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span> <span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//  Prepare our context and socket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>zmq</span><span class=o>::</span><span class=n>context_t</span> <span class=n>context</span> <span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>zmq</span><span class=o>::</span><span class=n>socket_t</span> <span class=n>socket</span> <span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>ZMQ_REQ</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Connecting to hello world server...&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>socket</span><span class=p>.</span><span class=n>connect</span> <span class=p>(</span><span class=s>&#34;tcp://localhost:5555&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Do 10 requests, waiting each time for a response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>request_nbr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>request_nbr</span> <span class=o>!=</span> <span class=mi>10</span><span class=p>;</span> <span class=n>request_nbr</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>zmq</span><span class=o>::</span><span class=n>message_t</span> <span class=n>request</span> <span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>memcpy</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=n>data</span> <span class=p>(),</span> <span class=s>&#34;Hello&#34;</span><span class=p>,</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Sending Hello &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>request_nbr</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;...&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>socket</span><span class=p>.</span><span class=n>send</span> <span class=p>(</span><span class=n>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//  Get the reply.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>zmq</span><span class=o>::</span><span class=n>message_t</span> <span class=n>reply</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>socket</span><span class=p>.</span><span class=n>recv</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>reply</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Received World &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>request_nbr</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在这里可以先启动 client，然后再启动 server，效果是相同的，这与传统的 socket 编程不同。不过如果中途 server 宕掉了，重新启动 server 后 client 是不会自动恢复的，对于这种场景处理会比较麻烦，后面再讨论。</p><p>另外，ZMQ 通信单元是消息，而且它只知道消息的 bytes 大小，并不关心消息格式，所以，可以自由选择消息格式，例如 XML、Thrift、Msgpack 等。</p><a class=anchor id=publish-subscribe></a><h2>Publish-Subscribe <a href=#publish-subscribe aria-hidden=true>#</a></h2><p>在此采用的是一个天气预报的订阅模式，由一个节点提供信息源，由其他的节点，接受信息源的信息。</p><p><img alt="ZeroMQ Examples Publish Subscribe Mode" src=images/zmq-examples-publish-subscribe.svg class="mx-auto d-block"></p><p>如下是服务端的代码 wuserver.cpp 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;zmq.hpp&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define within(num) (int) ((float) num * random () / (RAND_MAX + 1.0))
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span> <span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//  Prepare our context and publisher
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>zmq</span><span class=o>::</span><span class=n>context_t</span> <span class=n>context</span> <span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>zmq</span><span class=o>::</span><span class=n>socket_t</span> <span class=n>publisher</span> <span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>ZMQ_PUB</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>publisher</span><span class=p>.</span><span class=n>bind</span><span class=p>(</span><span class=s>&#34;tcp://*:5556&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>publisher</span><span class=p>.</span><span class=n>bind</span><span class=p>(</span><span class=s>&#34;ipc://weather.ipc&#34;</span><span class=p>);</span>             <span class=c1>// Not usable on Windows.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>//  Initialize random number generator
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>srandom</span> <span class=p>((</span><span class=kt>unsigned</span><span class=p>)</span> <span class=n>time</span> <span class=p>(</span><span class=nb>NULL</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>zipcode</span><span class=p>,</span> <span class=n>temperature</span><span class=p>,</span> <span class=n>relhumidity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//  Get values that will fool the boss
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>zipcode</span>     <span class=o>=</span> <span class=n>within</span> <span class=p>(</span><span class=mi>100000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>temperature</span> <span class=o>=</span> <span class=n>within</span> <span class=p>(</span><span class=mi>215</span><span class=p>)</span> <span class=o>-</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>relhumidity</span> <span class=o>=</span> <span class=n>within</span> <span class=p>(</span><span class=mi>50</span><span class=p>)</span> <span class=o>+</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//  Send message to all subscribers
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>zmq</span><span class=o>::</span><span class=n>message_t</span> <span class=n>message</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>snprintf</span> <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>message</span><span class=p>.</span><span class=n>data</span><span class=p>(),</span> <span class=mi>20</span><span class=p>,</span> <span class=s>&#34;%05d %d %d&#34;</span><span class=p>,</span> <span class=n>zipcode</span><span class=p>,</span> <span class=n>temperature</span><span class=p>,</span> <span class=n>relhumidity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>publisher</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>以及客户端 wuclient.cpp 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;zmq.hpp&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sstream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span> <span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>zmq</span><span class=o>::</span><span class=n>context_t</span> <span class=n>context</span> <span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Socket to talk to server
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Collecting updates from weather server...</span><span class=se>\n</span><span class=s>&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zmq</span><span class=o>::</span><span class=n>socket_t</span> <span class=n>subscriber</span> <span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>ZMQ_SUB</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>subscriber</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=s>&#34;tcp://localhost:5556&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Subscribe to zipcode, default is NYC, 10001
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filter</span> <span class=o>=</span> <span class=p>(</span><span class=n>argc</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span><span class=o>?</span> <span class=n>argv</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>:</span> <span class=s>&#34;10001 &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>subscriber</span><span class=p>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>ZMQ_SUBSCRIBE</span><span class=p>,</span> <span class=n>filter</span><span class=p>,</span> <span class=n>strlen</span> <span class=p>(</span><span class=n>filter</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Process 100 updates
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>update_nbr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>total_temp</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>update_nbr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>update_nbr</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=n>update_nbr</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>zmq</span><span class=o>::</span><span class=n>message_t</span> <span class=n>update</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>zipcode</span><span class=p>,</span> <span class=n>temperature</span><span class=p>,</span> <span class=n>relhumidity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>subscriber</span><span class=p>.</span><span class=n>recv</span><span class=p>(</span><span class=o>&amp;</span><span class=n>update</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>istringstream</span> <span class=n>iss</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>char</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>update</span><span class=p>.</span><span class=n>data</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>iss</span> <span class=o>&gt;&gt;</span> <span class=n>zipcode</span> <span class=o>&gt;&gt;</span> <span class=n>temperature</span> <span class=o>&gt;&gt;</span> <span class=n>relhumidity</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>total_temp</span> <span class=o>+=</span> <span class=n>temperature</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Average temperature for zipcode &#39;&#34;</span><span class=o>&lt;&lt;</span> <span class=n>filter</span>
</span></span><span class=line><span class=cl>              <span class=o>&lt;&lt;</span><span class=s>&#34;&#39; was &#34;</span><span class=o>&lt;&lt;</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>total_temp</span> <span class=o>/</span> <span class=n>update_nbr</span><span class=p>)</span> <span class=o>&lt;&lt;</span><span class=s>&#34;F&#34;</span>
</span></span><span class=line><span class=cl>              <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>简单来说，这里的代码会在服务器端生成随机的 zipcode、temperature、relhumidity，分别代表城市代码、温度值和湿度值，该值服务端会不断的广播消息。客户端会设置过滤参数，只接受特定城市代码的信息，当收集完了以后，也就是 100 个，那么会做一个平均值，并输出。</p><p>需要注意的是，这里必须通过 zmq_setsockopt() 设置 ZMQ_SUBSCRIBE，也就是设置一个过滤值，相当于设定一个订阅频道，否则收不到任何消息。</p><p>服务端一直在不断的广播，如果中途有 Subscriber 退出，并不会影响服务端的广播，如果 Subscriber 再连接上来时，收到的就是服务端后来发送的信息了。也就是说，对于比较晚加入的，或者是中途离开的订阅者，必然会丢失掉一部分信息，这是这个模式的一个问题。对于 Slow Joiner 的问题，稍后会解决。</p><p>如果 Publisher 中途离开，所有的 Subscriber 会 hold 住，待 Publisher 再上线时，会继续接收信息。</p><a class=anchor id=parallel-pipeline></a><h2>Parallel Pipeline <a href=#parallel-pipeline aria-hidden=true>#</a></h2><p>这一模型通常用在类似于 Map-Reduce 的场景，通常有三部分组成，包括了一个生成可并行处理任务的节点 (ventilator)、多个对任务进行并行处理的节点 (worker)、一个收集处理结果的节点 (sink) 。</p><p><img alt="ZeroMQ Examples Parallel Pipeline Mode" src=images/zmq-examples-parallel-pipeline.svg class="mx-auto d-block"></p><p>例如，需要统计各个机器的日志，我们可以将统计任务分发到多个节点，最后收集统计结果，做个汇总。</p><p>在如下的示例中，taskvent 生成了 100 个任务，然后启动各个 work 之后由各个 work 进行处理，最后由 tasksink 作统计。其中，work 就是接收任务，然后 sleep 一段时间。</p><p>生成多个任务 taskvent.cpp 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;zmq.hpp&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define within(num) (int) ((float) num * random () / (RAND_MAX + 1.0))
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span> <span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>zmq</span><span class=o>::</span><span class=n>context_t</span> <span class=n>context</span> <span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Socket to send messages on
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>zmq</span><span class=o>::</span><span class=n>socket_t</span>  <span class=n>sender</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>ZMQ_PUSH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>sender</span><span class=p>.</span><span class=n>bind</span><span class=p>(</span><span class=s>&#34;tcp://*:5557&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Press Enter when the workers are ready: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>getchar</span> <span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Sending tasks to workers...</span><span class=se>\n</span><span class=s>&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  The first message is &#34;0&#34; and signals start of batch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>zmq</span><span class=o>::</span><span class=n>socket_t</span> <span class=n>sink</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>ZMQ_PUSH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>sink</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=s>&#34;tcp://localhost:5558&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>zmq</span><span class=o>::</span><span class=n>message_t</span> <span class=n>message</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>memcpy</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=n>data</span><span class=p>(),</span> <span class=s>&#34;0&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>sink</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Initialize random number generator
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>srandom</span> <span class=p>((</span><span class=kt>unsigned</span><span class=p>)</span> <span class=n>time</span> <span class=p>(</span><span class=nb>NULL</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Send 100 tasks
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>task_nbr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>total_msec</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>     <span class=c1>//  Total expected cost in msecs
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>task_nbr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>task_nbr</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=n>task_nbr</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>workload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>//  Random workload from 1 to 100msecs
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>workload</span> <span class=o>=</span> <span class=n>within</span> <span class=p>(</span><span class=mi>100</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>total_msec</span> <span class=o>+=</span> <span class=n>workload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>message</span><span class=p>.</span><span class=n>rebuild</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>memset</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=n>data</span><span class=p>(),</span> <span class=sc>&#39;\0&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sprintf</span> <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>message</span><span class=p>.</span><span class=n>data</span><span class=p>(),</span> <span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=n>workload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sender</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;Total expected cost: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>total_msec</span> <span class=o>&lt;&lt;</span> <span class=s>&#34; msec&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sleep</span> <span class=p>(</span><span class=mi>1</span><span class=p>);</span>              <span class=c1>//  Give 0MQ time to deliver
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>任务处理程序 taskwork.cpp 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;zhelpers.hpp&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span> <span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>zmq</span><span class=o>::</span><span class=n>context_t</span> <span class=n>context</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Socket to receive messages on
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>zmq</span><span class=o>::</span><span class=n>socket_t</span> <span class=n>receiver</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>ZMQ_PULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>receiver</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=s>&#34;tcp://localhost:5557&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Socket to send messages to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>zmq</span><span class=o>::</span><span class=n>socket_t</span> <span class=n>sender</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>ZMQ_PUSH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>sender</span><span class=p>.</span><span class=n>connect</span><span class=p>(</span><span class=s>&#34;tcp://localhost:5558&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Process tasks forever
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>zmq</span><span class=o>::</span><span class=n>message_t</span> <span class=n>message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>workload</span><span class=p>;</span>           <span class=c1>//  Workload in msecs
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>receiver</span><span class=p>.</span><span class=n>recv</span><span class=p>(</span><span class=o>&amp;</span><span class=n>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>smessage</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>char</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=n>data</span><span class=p>()),</span> <span class=n>message</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>istringstream</span> <span class=n>iss</span><span class=p>(</span><span class=n>smessage</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>iss</span> <span class=o>&gt;&gt;</span> <span class=n>workload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//  Do the work
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>s_sleep</span><span class=p>(</span><span class=n>workload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//  Send results to sink
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>message</span><span class=p>.</span><span class=n>rebuild</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>sender</span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>//  Simple progress indicator for the viewer
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>flush</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>处理结果 tasksink.cpp 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;zmq.hpp&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span> <span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//  Prepare our context and socket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>zmq</span><span class=o>::</span><span class=n>context_t</span> <span class=n>context</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>zmq</span><span class=o>::</span><span class=n>socket_t</span> <span class=n>receiver</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=n>ZMQ_PULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>receiver</span><span class=p>.</span><span class=n>bind</span><span class=p>(</span><span class=s>&#34;tcp://*:5558&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Wait for start of batch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>zmq</span><span class=o>::</span><span class=n>message_t</span> <span class=n>message</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>receiver</span><span class=p>.</span><span class=n>recv</span><span class=p>(</span><span class=o>&amp;</span><span class=n>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Start our clock now
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=nc>timeval</span> <span class=n>tstart</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>gettimeofday</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>tstart</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//  Process 100 confirmations
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>task_nbr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>total_msec</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>     <span class=c1>//  Total calculated cost in msecs
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>task_nbr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>task_nbr</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>;</span> <span class=n>task_nbr</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>receiver</span><span class=p>.</span><span class=n>recv</span><span class=p>(</span><span class=o>&amp;</span><span class=n>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>task_nbr</span> <span class=o>/</span> <span class=mi>10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>10</span> <span class=o>==</span> <span class=n>task_nbr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;:&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>flush</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>flush</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//  Calculate and report duration of batch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=nc>timeval</span> <span class=n>tend</span><span class=p>,</span> <span class=n>tdiff</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>gettimeofday</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>tend</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tend</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>&lt;</span> <span class=n>tstart</span><span class=p>.</span><span class=n>tv_usec</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>tdiff</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>=</span> <span class=n>tend</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>-</span> <span class=n>tstart</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>tdiff</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>=</span> <span class=mi>1000000</span> <span class=o>+</span> <span class=n>tend</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>-</span> <span class=n>tstart</span><span class=p>.</span><span class=n>tv_usec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>tdiff</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>=</span> <span class=n>tend</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>-</span> <span class=n>tstart</span><span class=p>.</span><span class=n>tv_sec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>tdiff</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>=</span> <span class=n>tend</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>-</span> <span class=n>tstart</span><span class=p>.</span><span class=n>tv_usec</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>total_msec</span> <span class=o>=</span> <span class=n>tdiff</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>*</span> <span class=mi>1000</span> <span class=o>+</span> <span class=n>tdiff</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>/</span> <span class=mi>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;</span><span class=se>\n</span><span class=s>Total elapsed time: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>total_msec</span> <span class=o>&lt;&lt;</span> <span class=s>&#34; msec</span><span class=se>\n</span><span class=s>&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如上，ventilator 使用的是 SOCKET_PUSH，将任务分发到 Worker；而 Worker 使用 SOCKET_PULL 从上游接受任务，并使用 SOCKET_PUSH 将结果汇集到 Sink。需要注意的是，任务分发时同样有一个负载均衡的路由功能，worker 可以随时自由加入，ventilator 可以均衡将任务分发出去。</p><a class=anchor id=其它></a><h1>其它 <a href=#%e5%85%b6%e5%ae%83 aria-hidden=true>#</a></h1><p>PGM 是一个可靠且可伸缩的多播协议，通过该协议，接收方可以检测丢失、请求重新传输丢失的数据或者通知应用程序无法恢复的丢失情形；OpenPGM 是一个基于 PGM 协议的实现。</p></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#advanced-message-queuing-protocol>Advanced Message Queuing Protocol</a></li><li><a href=#zmq-安装>ZMQ 安装</a></li></ul></li><li><a href=#示例>示例</a><ul><li><a href=#request-reply>Request-Reply</a></li><li><a href=#publish-subscribe>Publish-Subscribe</a></li><li><a href=#parallel-pipeline>Parallel Pipeline</a></li></ul></li><li><a href=#其它>其它</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>