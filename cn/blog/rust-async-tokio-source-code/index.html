<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Tokio 源码解析 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="Runtime # 在使用时需要提供异步运行时环境，创建的任务会在这个环境里运行，可以选择单线程或者多线程，而且可以同时存在。对于 IO 类型任务建议使用多线程，但是多线程间的通信会变的复杂，从而加重了线程间切换的开销，可能导致某些场景下性能可能降低。
用户态的协程实现是基于协作时的调度策略，详细可以参考 Making the Tokio scheduler 10x faster 中的介绍。
在代码内部，会通过 scheduler::Handle::current() 获取当前 Handle 实现，相关代码调用逻辑如下。
// runtime/scheduler/mod.rs use crate::runtime::context; impl Handle { pub(crate) fn current() -&amp;gt; Handle { match context::with_current(Clone::clone) { Ok(handle) =&amp;gt; handle, Err(e) =&amp;gt; panic!(&amp;#34;{}&amp;#34;, e), } } } // runtime/context/current.rs pub(crate) fn with_current&amp;lt;F, R&amp;gt;(f: F) -&amp;gt; Result&amp;lt;R, TryCurrentError&amp;gt; where F: FnOnce(&amp;amp;scheduler::Handle) -&amp;gt; R, { match CONTEXT.try_with(|ctx| ctx.current.handle.borrow().as_ref().map(f)) { Ok(Some(ret)) =&amp;gt; Ok(ret), Ok(None) =&amp;gt; Err(TryCurrentError::new_no_context()), Err(_access_error) =&amp;gt; Err(TryCurrentError::new_thread_local_destroyed()), } } 其中 CONTEXT 是一个 TLS 变量，会在 runtime."><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>Tokio 源码解析</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2022-12-10</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/rust/ role=button>rust</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/language/ role=button>language</a></div></div><hr><div class=content><a class=anchor id=runtime></a><h1>Runtime <a href=#runtime aria-hidden=true>#</a></h1><p>在使用时需要提供异步运行时环境，创建的任务会在这个环境里运行，可以选择单线程或者多线程，而且可以同时存在。对于 IO 类型任务建议使用多线程，但是多线程间的通信会变的复杂，从而加重了线程间切换的开销，可能导致某些场景下性能可能降低。</p><p>用户态的协程实现是基于协作时的调度策略，详细可以参考 <a href=https://tokio.rs/blog/2019-10-scheduler>Making the Tokio scheduler 10x faster</a> 中的介绍。</p><p>在代码内部，会通过 <code>scheduler::Handle::current()</code> 获取当前 <code>Handle</code> 实现，相关代码调用逻辑如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// runtime/scheduler/mod.rs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>runtime</span>::<span class=n>context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>current</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>Handle</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>context</span>::<span class=n>with_current</span><span class=p>(</span><span class=nb>Clone</span>::<span class=n>clone</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(</span><span class=n>handle</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>handle</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// runtime/context/current.rs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>with_current</span><span class=o>&lt;</span><span class=n>F</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=p>(</span><span class=n>f</span>: <span class=nc>F</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>R</span><span class=p>,</span><span class=w> </span><span class=n>TryCurrentError</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>F</span>: <span class=nb>FnOnce</span><span class=p>(</span><span class=o>&amp;</span><span class=n>scheduler</span>::<span class=n>Handle</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>R</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=no>CONTEXT</span><span class=p>.</span><span class=n>try_with</span><span class=p>(</span><span class=o>|</span><span class=n>ctx</span><span class=o>|</span><span class=w> </span><span class=n>ctx</span><span class=p>.</span><span class=n>current</span><span class=p>.</span><span class=n>handle</span><span class=p>.</span><span class=n>borrow</span><span class=p>().</span><span class=n>as_ref</span><span class=p>().</span><span class=n>map</span><span class=p>(</span><span class=n>f</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=nb>Some</span><span class=p>(</span><span class=n>ret</span><span class=p>))</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>ret</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=nb>None</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>TryCurrentError</span>::<span class=n>new_no_context</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>_access_error</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>TryCurrentError</span>::<span class=n>new_thread_local_destroyed</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>其中 CONTEXT 是一个 TLS 变量，会在 <code>runtime.enter()[runtime/handle.rs]</code> 中通过 <code>context::try_set_current()</code> 设置指定的运行时，包括了如下几种：</p><ul><li><code>CurrentThread</code> 只在当前线程执行。</li><li><code>MultiThread</code> 允许在多个线程中执行，不过是空结构体，只作为标识。</li></ul><p>如下以 <code>MultiThread</code> 为例，从 <code>Builder</code> 开始，其构建过程的部分代码梳理如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// runtime/builder.rs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>impl</span><span class=w> </span><span class=n>Builder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>new_multi_thread</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>Builder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Builder</span>::<span class=n>new</span><span class=p>(</span><span class=n>Kind</span>::<span class=n>MultiThread</span><span class=p>,</span><span class=w> </span><span class=mi>61</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>enable_all</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=bp>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>enable_io</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>enable_time</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=bp>self</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>build</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=n>Runtime</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>kind</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Kind</span>::<span class=n>CurrentThread</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>build_current_thread_runtime</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=cp>#[cfg(all(feature = </span><span class=s>&#34;rt-multi-thread&#34;</span><span class=cp>, not(target_os = </span><span class=s>&#34;wasi&#34;</span><span class=cp>)))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Kind</span>::<span class=n>MultiThread</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>build_threaded_runtime</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=cp>#[cfg(all(tokio_unstable, feature = </span><span class=s>&#34;rt-multi-thread&#34;</span><span class=cp>, not(target_os = </span><span class=s>&#34;wasi&#34;</span><span class=cp>)))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Kind</span>::<span class=n>MultiThreadAlt</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>build_alt_threaded_runtime</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// runtime/runtime.rs 在 build_threaded_runtime()[runtime/builder.rs] 中创建 
</span></span><span class=line><span class=cl>pub struct Runtime {
</span></span><span class=line><span class=cl>    scheduler: Scheduler,  // 在 build_threaded_runtime() 中通过 enum Scheduler[runtime/runtime.rs] 进行了简单封装，用于区分不同的运行态
</span></span><span class=line><span class=cl>    handle: Handle,  // 在 build_threaded_runtime() 中对 MultiThread::new()[multi/mod.rs] 创建对象进行封装
</span></span><span class=line><span class=cl>    blocking_pool: BlockingPool,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>pub(super) enum Scheduler {
</span></span><span class=line><span class=cl>    CurrentThread(CurrentThread),
</span></span><span class=line><span class=cl>    MultiThread(MultiThread),  // 内部封装内容在 build_threaded_runtime() 中通过 MultiThread::new()[multi/mod.rs] 创建
</span></span><span class=line><span class=cl>    MultiThreadAlt(MultiThreadAlt),
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>// runtime/handle.rs
</span></span><span class=line><span class=cl>pub struct Handle {
</span></span><span class=line><span class=cl>    pub(crate) inner: scheduler::Handle,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>// runtime/scheduler/mod.rs
</span></span><span class=line><span class=cl>pub(crate) enum Handle {
</span></span><span class=line><span class=cl>    CurrentThread(Arc&lt;current_thread::Handle&gt;),
</span></span><span class=line><span class=cl>    MultiThread(Arc&lt;multi_thread::Handle&gt;),
</span></span><span class=line><span class=cl>    MultiThreadAlt(Arc&lt;multi_thread_alt::Handle&gt;),
</span></span><span class=line><span class=cl>    Disabled,
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>如上，Runtime 实际上经过了几次封装，最终才到了 MultiThread 的实现。</p><p>调用流程如下，在 build_threaded_runtime() 里有个 enter() + launch() 操作，这里会启动线程开始执行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Builder::build_threaded_runtime()[runtime/builder.rs]
</span></span><span class=line><span class=cl> |-driver::Driver::new()[runtime/driver.rs]
</span></span><span class=line><span class=cl> |-blocking::create_blocking_pool()[runtime/blocking/mod.rs]
</span></span><span class=line><span class=cl> | |-BlockingPool::new()[runtime/blocking/pool.rs]
</span></span><span class=line><span class=cl> |-MultiThread::new()[runtime/scheduler/multi_thread/mod.rs]
</span></span><span class=line><span class=cl> | |-Parker::new()[runtime/scheduler/multi_thread/park.rs]
</span></span><span class=line><span class=cl> | |-worker::create()[runtime/scheduler/multi_thread/worker.rs] 这里会新建Core数量线程并启动
</span></span><span class=line><span class=cl> |   |-queue::local()[runtime/scheduler/multi_thread/queue.rs] 创建本地队列
</span></span><span class=line><span class=cl> |   |-OwnedTasks::new()
</span></span><span class=line><span class=cl> |-scheduler::Handle::MultiThread()[runtime/scheduler/multi_thread/mod.rs] 这里会新建一个Handle对象
</span></span><span class=line><span class=cl> |-Handle::enter()[runtime/handle.rs]
</span></span><span class=line><span class=cl> | |-try_set_current()[runtime/context/current.rs] 设置运行上下文
</span></span><span class=line><span class=cl> |-Launch::launch()
</span></span><span class=line><span class=cl> | |-runtime::spawn_blocking() 这里会遍历 drain 所有的 workers 执行该函数，
</span></span><span class=line><span class=cl> |-Runtime::from_parts()[runtime/runtime.rs] 这里会通过Scheduler
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OwnedTasks/LocalOwnedTasks::bind()[runtime/task/list.rs]
</span></span><span class=line><span class=cl>new_task()[runtime/task/mod.rs] 这里会对 RawTask 进行封装，生成 Task、Notified、JoinHandle 几个变量
</span></span><span class=line><span class=cl> |-RawTask::new()[runtime/task/raw.rs]
</span></span><span class=line><span class=cl> | |-Cell::new()[runtime/task/core.rs] 在 Cell 中会包含 Header、Core、Trailer 三个核心部分，同样包含了 poll() 的实现
</span></span><span class=line><span class=cl> |-JoinHandle::new()[runtime/task/join.rs]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>这里的 Core::poll() 会执行 Future 的 poll 操作，
</span></span><span class=line><span class=cl>修改状态时通过 Harness Lifecycle 进行加锁。
</span></span><span class=line><span class=cl>Core.poll() runtime/task/core.rs
</span></span><span class=line><span class=cl>pub(super) fn poll(&amp;self, mut cx: Context&lt;&#39;_&gt;) -&gt; Poll&lt;T::Output&gt; {
</span></span></code></pre></div><p>如上，对于 <code>MultiThread</code> 来说，通过 <code>scheduler::Handle::current()</code> 返回的就是 <code>runtime/scheduler/multi_thread/handle.rs</code> 中的 <code>Handle</code> 实现了，一般会再调用 <code>handle.driver().io() handle.driver().signal()</code> 等函数实现，这样又会返回到 <code>runtime/driver.rs</code> 中的 <code>Handle</code> 实现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// src/runtime/scheduler/mod.rs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#[derive(Debug, Clone)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>enum</span> <span class=nc>Handle</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[cfg(feature = </span><span class=s>&#34;rt&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CurrentThread</span><span class=p>(</span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>current_thread</span>::<span class=n>Handle</span><span class=o>&gt;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[cfg(all(feature = </span><span class=s>&#34;rt-multi-thread&#34;</span><span class=cp>, not(target_os = </span><span class=s>&#34;wasi&#34;</span><span class=cp>)))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MultiThread</span><span class=p>(</span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>multi_thread</span>::<span class=n>Handle</span><span class=o>&gt;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[cfg(all(tokio_unstable, feature = </span><span class=s>&#34;rt-multi-thread&#34;</span><span class=cp>, not(target_os = </span><span class=s>&#34;wasi&#34;</span><span class=cp>)))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MultiThreadAlt</span><span class=p>(</span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>multi_thread_alt</span>::<span class=n>Handle</span><span class=o>&gt;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[cfg(not(feature = </span><span class=s>&#34;rt&#34;</span><span class=cp>))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[allow(dead_code)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Disabled</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// src/runtime/drivers.rs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>struct</span> <span class=nc>Handle</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// IO driver handle
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>io</span>: <span class=nc>IoHandle</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Signal driver handle
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=cp>#[cfg_attr(any(not(unix), loom), allow(dead_code))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>signal</span>: <span class=nc>SignalHandle</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Time driver handle
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>time</span>: <span class=nc>TimeHandle</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Source of `Instant::now()`
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=cp>#[cfg_attr(not(all(feature = </span><span class=s>&#34;time&#34;</span><span class=cp>, feature = </span><span class=s>&#34;test-util&#34;</span><span class=cp>)), allow(dead_code))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=n>clock</span>: <span class=nc>Clock</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这里的 MultiThread 是一个空结构体，不占用任何内存空间，通常作为标识、占位使用。</p><p>内核退出则是通过 <code>Drop Runtime</code> 来实现的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Runtime::drop()[runtime/runtime.rs]
</span></span><span class=line><span class=cl> |-MultiThread::shutdown()[runtime/scheduler/multi_thread/mod.rs] 会根据Scheduler分别进行调度
</span></span><span class=line><span class=cl>   |-Handle::shutdown()[runtime/scheduler/multi_thread/handle.rs]
</span></span><span class=line><span class=cl>     |-Handle::close()[runtime/scheduler/multi_thread/worker.rs]
</span></span><span class=line><span class=cl>       |-Shared::close()[runtime/scheduler/inject/shared.rs] 会将队列设置为 closed
</span></span><span class=line><span class=cl>       |-Handle::notify_all()[runtime/scheduler/multi_thread/worker.rs] 通过调用 remotes 执行 unpark 参数
</span></span></code></pre></div><p>关闭实际上是就是 runtime 已经不在对应生命周期内，会自动调用 drop() 接口，</p><a class=anchor id=spawn></a><h2>Spawn <a href=#spawn aria-hidden=true>#</a></h2><p>如上有两种 <code>spawn()</code> 方式创建任务，分别通过 <code>tokio</code> 以及 <code>Runtime</code> 库，其中前者在 <code>tokio/src/lib.rs</code> 中有如下配置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pub mod task;
</span></span><span class=line><span class=cl>cfg_rt! {
</span></span><span class=line><span class=cl>    pub use task::spawn;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>也就是实际实现在 <code>src/task/spawn.rs</code> 代码中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>task::spawn()[task/spawn.rs] 这里会包含真正的 Future 实现
</span></span><span class=line><span class=cl> |-task::spawn_inner()
</span></span><span class=line><span class=cl>   |-Handle::spawn() 这里会在 Context 上下文中执行
</span></span></code></pre></div><p>后者的实现如下，最后殊途同归，这里以 MultiThread 为例。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>runtime/task/list.rs
</span></span><span class=line><span class=cl>pub(crate) struct OwnedTasks&lt;S: &#39;static&gt; {
</span></span><span class=line><span class=cl>    list: List&lt;S&gt;,
</span></span><span class=line><span class=cl>    pub(crate) id: NonZeroU64,
</span></span><span class=line><span class=cl>    closed: AtomicBool,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>type List&lt;S&gt; = sharded_list::ShardedList&lt;Task&lt;S&gt;, &lt;Task&lt;S&gt; as Link&gt;::Target&gt;;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>util/sharded_list.rs
</span></span><span class=line><span class=cl>pub(crate) struct ShardedList&lt;L, T&gt; {
</span></span><span class=line><span class=cl>    lists: Box&lt;[Mutex&lt;LinkedList&lt;L, T&gt;&gt;]&gt;,  这里是根据Core创建的数组，数组中是List
</span></span><span class=line><span class=cl>    count: AtomicUsize,
</span></span><span class=line><span class=cl>    shard_mask: usize,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>pub(crate) struct ShardGuard&lt;&#39;a, L, T&gt; {
</span></span><span class=line><span class=cl>    lock: MutexGuard&lt;&#39;a, LinkedList&lt;L, T&gt;&gt;,
</span></span><span class=line><span class=cl>    count: &amp;&#39;a AtomicUsize,
</span></span><span class=line><span class=cl>    id: usize,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MultiThread::Handle::spawn()[multi/handle.rs]
</span></span><span class=line><span class=cl> |-MultiThread::Handle::bind_new_task() 这里会返回 JoinHandle
</span></span><span class=line><span class=cl>   |-OwnedTasks::bind()[runtime/task/list.rs] 会通过 me.shared.owned.bind() 函数调用
</span></span><span class=line><span class=cl>   | |-super::new_task()[runtime/task/mod.rs] 这里就是真正创建任务的过程了，返回的是 Notified 创建的对象
</span></span><span class=line><span class=cl>   | | |-RawTask::new() runtime/task/raw.rs
</span></span><span class=line><span class=cl>   | |-OwnedTasks::bind_inner()[runtime/task/list.rs] 会检查是否已经关闭
</span></span><span class=line><span class=cl>   |   |-ShardedList::lock_shard()[util/sharded_list.rs] 这里会返回 ShardGuard 实现
</span></span><span class=line><span class=cl>   |   |-ShardGuard::push()
</span></span><span class=line><span class=cl>   |-MultiThread::Handle::schedule_option_task_without_yield()[runtime/task/list.rs] 这里对任务进行调度
</span></span><span class=line><span class=cl>     |-MulitThread::Handle::schedule_task()[multi/worker.rs] 这里会在 with_current 中获取 Context 进行调度
</span></span><span class=line><span class=cl>       |-Handle::schedule_task()[multi/worker.rs] 这里会在 with_current 中获取 Context 进行调度
</span></span><span class=line><span class=cl>       |-Handle::schedule_local() 在本线程内创建
</span></span><span class=line><span class=cl>       |-Handle::push_remote_task() 否则添加到全局任务队列中
</span></span><span class=line><span class=cl>       |-Handle::notify_parked_remote()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Handle::spawn_thread()[runtime/handle.rs] 这里应该是多线程创建运行线程的实现
</span></span></code></pre></div><a class=anchor id=parkunpark></a><h2>Park/Unpark <a href=#parkunpark aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>struct</span> <span class=nc>ParkThread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>inner</span>: <span class=nc>Arc</span><span class=o>&lt;</span><span class=n>Inner</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Unblocks a thread that was blocked by `ParkThread`.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[derive(Clone, Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>struct</span> <span class=nc>UnparkThread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>inner</span>: <span class=nc>Arc</span><span class=o>&lt;</span><span class=n>Inner</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Inner</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>state</span>: <span class=nc>AtomicUsize</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mutex</span>: <span class=nc>Mutex</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>condvar</span>: <span class=nc>Condvar</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>struct</span> <span class=nc>CachedParkThread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_anchor</span>: <span class=nc>PhantomData</span><span class=o>&lt;</span><span class=n>Rc</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>实际上就是封装了一个 <code>Condvar</code> 实现内核级别的阻塞、唤醒。</p><a class=anchor id=future></a><h1>Future <a href=#future aria-hidden=true>#</a></h1><p>之前已经介绍过，在类似 <code>Tokio</code> 这种的运行态中，需要实现对应的 <code>LeafFuture</code> 才行，如下是一个及其简单的 <code>Future</code> 实现，可以在 <code>Tokio</code> 中运行的简单实现，当超过指定时间之后输出 <code>Hello World</code> 信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>Future</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>task</span>::<span class=p>{</span><span class=n>Context</span><span class=p>,</span><span class=w> </span><span class=n>Poll</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>time</span>::<span class=p>{</span><span class=n>Duration</span><span class=p>,</span><span class=w> </span><span class=n>Instant</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Delay</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>when</span>: <span class=nc>Instant</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Delay</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=nb>&#39;static</span><span class=w> </span><span class=kt>str</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>poll</span><span class=p>(</span><span class=bp>self</span>: <span class=nc>Pin</span><span class=o>&lt;&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>cx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Context</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Poll</span><span class=o>&lt;&amp;</span><span class=nb>&#39;static</span><span class=w> </span><span class=kt>str</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>Instant</span>::<span class=n>now</span><span class=p>()</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>when</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello World!!!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Poll</span>::<span class=n>Ready</span><span class=p>(</span><span class=s>&#34;done&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Ignore this line for now.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=n>cx</span><span class=p>.</span><span class=n>waker</span><span class=p>().</span><span class=n>wake_by_ref</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Poll</span>::<span class=n>Pending</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>when</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Instant</span>::<span class=n>now</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Duration</span>::<span class=n>from_millis</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Delay</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>when</span><span class=w> </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>future</span><span class=p>.</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=s>&#34;done&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>注意，此时会跑满单个 CPU 资源。</p><a class=anchor id=leaffuture></a><h2>LeafFuture <a href=#leaffuture aria-hidden=true>#</a></h2><p>当在代码中调用 <code>let mut stream = TcpStream::connect(&amp;addr).await?;</code> 时，最终会生成类似如下的实现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>future</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TcpStream</span>::<span class=n>connect</span><span class=p>(</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>future</span><span class=p>.</span><span class=n>poll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Async</span>::<span class=n>Ready</span><span class=p>(</span><span class=n>e</span><span class=p>))</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>e</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Async</span>::<span class=n>NotReady</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=kr>yield</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>这里的 <code>TcpStream</code> 就是 Tokio 需要实现的底层 Future 代码。</p><a class=anchor id=io></a><h2>IO <a href=#io aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=c1>// src/net/tcp/stream.rs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>TcpStream</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>io</span>: <span class=nc>PollEvented</span><span class=o>&lt;</span><span class=n>mio</span>::<span class=n>net</span>::<span class=n>TcpStream</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>connect</span><span class=o>&lt;</span><span class=n>A</span>: <span class=nc>ToSocketAddrs</span><span class=o>&gt;</span><span class=p>(</span><span class=n>addr</span>: <span class=nc>A</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=n>TcpStream</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// src/io/poll_evented.rs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>struct</span> <span class=nc>PollEvented</span><span class=o>&lt;</span><span class=n>E</span>: <span class=nc>Source</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>io</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registration</span>: <span class=nc>Registration</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在创建 IO 时，如 TcpListener accept 到一个 fd，那么这个 fd 会被包装为 TcpStream。TcpStream 内其实是一个 PollEvented 结构，很多面向用户的结构（如 UnixStream 等）都只是 PollEvented 的包装。</p><p>PollEvented 创建时即会做 fd 和 interest 的注册，drop 时会解注册。IO 的就绪状态和等待者是在一个统一的 Slab 中管理的（对应 Registration 这个概念）。PollEvented 内部包含 io 和 注册信息 两部分；注册信息 又持有了 Driver Handle 和 Ref。</p><p>在 PollEvented 创建时，会从 TLS 拿到当前 Driver 的 Handle，并将自己的 Interest 注册上去。注册的时候 Driver 内部会在 slab 中分配一块空间存放其状态信息（即 ScheduledIo），并在返回的注册信息中记录该状态在 slab 中的 index。</p><a class=anchor id=sleep></a><h2>Sleep <a href=#sleep aria-hidden=true>#</a></h2><p>以 MultiThread 为例，就可以看到其中 Handle 的具体实现，其中实现相关的代码可以查看 <code>src/time</code> 以及 <code>src/runtime/time</code> 中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>tokio::time::sleep_until() src/time/sleep.rs
</span></span><span class=line><span class=cl> |-Sleep::new_timeout()
</span></span><span class=line><span class=cl>   |-TimerEntry::new() 这里会返回 Sleep 对象
</span></span></code></pre></div><p>而 <code>Sleep</code> 实现了 <code>Future</code> 接口。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Sleep</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>inner</span>: <span class=nc>Inner</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[pin]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>entry</span>: <span class=nc>TimerEntry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Sleep</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>poll</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span>: <span class=nc>Pin</span><span class=o>&lt;&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>Self</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>cx</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>task</span>::<span class=n>Context</span><span class=o>&lt;</span><span class=nb>&#39;_</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Poll</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Output</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=fm>ready!</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>as_mut</span><span class=p>().</span><span class=n>poll_elapsed</span><span class=p>(</span><span class=n>cx</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(())</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Poll</span>::<span class=n>Ready</span><span class=p>(()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;timer error: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>详细调用逻辑如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Sleep::poll()
</span></span><span class=line><span class=cl> |-Sleep::poll_elapsed()
</span></span><span class=line><span class=cl>   |-TimerEntry::poll_elapsed()
</span></span><span class=line><span class=cl>     |-TimerEntry::reset()
</span></span><span class=line><span class=cl>       |-TimerShared::extend_expiration()
</span></span><span class=line><span class=cl>       |-Handle::register()  src/runtime/time/mod.rs
</span></span><span class=line><span class=cl>create_time_driver
</span></span></code></pre></div><a class=anchor id=调用队列></a><h1>调用队列 <a href=#%e8%b0%83%e7%94%a8%e9%98%9f%e5%88%97 aria-hidden=true>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 本地队列实现
</span></span><span class=line><span class=cl>runtime/scheduler/multi_thread/queue.rs
</span></span><span class=line><span class=cl>/// Producer handle. May only be used from a single thread.
</span></span><span class=line><span class=cl>pub(crate) struct Local&lt;T: &#39;static&gt; {
</span></span><span class=line><span class=cl>    inner: Arc&lt;Inner&lt;T&gt;&gt;,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>/// Consumer handle. May be used from many threads.
</span></span><span class=line><span class=cl>pub(crate) struct Steal&lt;T: &#39;static&gt;(Arc&lt;Inner&lt;T&gt;&gt;);
</span></span><span class=line><span class=cl>pub(crate) struct Inner&lt;T: &#39;static&gt; {
</span></span><span class=line><span class=cl>    head: AtomicUnsignedLong,
</span></span><span class=line><span class=cl>    tail: AtomicUnsignedShort,
</span></span><span class=line><span class=cl>    buffer: Box&lt;[UnsafeCell&lt;MaybeUninit&lt;task::Notified&lt;T&gt;&gt;&gt;; LOCAL_QUEUE_CAPACITY]&gt;,
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>对于 Local 有对应的 <code>push_back()</code> 等函数的实现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Handle::schedule_task()[runtime/scheduler/multi_thread/worker.rs]
</span></span><span class=line><span class=cl> |-Handle::schedule_local()
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Context::run()[runtime/scheduler/multi_thread/worker.rs] 开始在死循环中运行
</span></span><span class=line><span class=cl> |-Core::tick() 增加 tick 计数
</span></span><span class=line><span class=cl> |-Context.maintenance() 处理一些维护任务
</span></span><span class=line><span class=cl> |-Core::next_task()[runtime/scheduler/multi_thread/worker.rs] 获取下一个需要执行的任务，会先尝试本地Worker获取
</span></span><span class=line><span class=cl> |-Context::run_task() 获取然后真正开始执行任务
</span></span><span class=line><span class=cl> | |-Local::push_back_or_overflow()[runtime/scheduler/multi_thread/queue.rs]
</span></span><span class=line><span class=cl> |   |-Local::push_overflow()
</span></span><span class=line><span class=cl> |-Core::steal_work() 本地无任务，尝试从其它线程获取，否则从全局获取
</span></span><span class=line><span class=cl> | |-Steal::steal_into() 开始窃取
</span></span><span class=line><span class=cl> | |-Handle::next_remote_task()[runtime/scheduler/multi_thread/worker.rs] 不行从全局获取，这里会加锁的
</span></span><span class=line><span class=cl> |   |-Shared::pop()[runtime/scheduler/inject/shared.rs]
</span></span><span class=line><span class=cl> |     |-Shared::pop_n() 会获取N个任务，这里就是1了，会封装为Pop
</span></span><span class=line><span class=cl> |     |-Pop::next()[runtime/scheduler/inject/pop.rs]
</span></span><span class=line><span class=cl> |-Context::run_task() 获取后同样会运行
</span></span><span class=line><span class=cl> |-Context.park() 没有任务开始等待
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// runtime/task/raw.rs
</span></span><span class=line><span class=cl>/// Raw task handle
</span></span><span class=line><span class=cl>#[derive(Clone)]
</span></span><span class=line><span class=cl>pub(crate) struct RawTask {
</span></span><span class=line><span class=cl>    ptr: NonNull&lt;Header&gt;,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 真正保存全局任务队列的实现
</span></span><span class=line><span class=cl>// runtime/scheduler/inject/synced.rs
</span></span><span class=line><span class=cl>pub(crate) struct Synced {
</span></span><span class=line><span class=cl>    /// True if the queue is closed.
</span></span><span class=line><span class=cl>    pub(super) is_closed: bool,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /// Linked-list head.
</span></span><span class=line><span class=cl>    pub(super) head: Option&lt;task::RawTask&gt;,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /// Linked-list tail.
</span></span><span class=line><span class=cl>    pub(super) tail: Option&lt;task::RawTask&gt;,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// runtime/scheduler/inject/shared.rs
</span></span><span class=line><span class=cl>pub(crate) struct Shared&lt;T: &#39;static&gt; {
</span></span><span class=line><span class=cl>    /// Number of pending tasks in the queue. This helps prevent unnecessary
</span></span><span class=line><span class=cl>    /// locking in the hot path.
</span></span><span class=line><span class=cl>    pub(super) len: AtomicUsize,
</span></span><span class=line><span class=cl>    _p: PhantomData&lt;T&gt;,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 所有Worker的共享信息，包含全局队列实现
</span></span><span class=line><span class=cl>// runtime/scheduler/multi_thread/worker.rs
</span></span><span class=line><span class=cl>pub(crate) struct Shared {
</span></span><span class=line><span class=cl>    /// Per-worker remote state. All other workers have access to this and is
</span></span><span class=line><span class=cl>    /// how they communicate between each other.
</span></span><span class=line><span class=cl>    remotes: Box&lt;[Remote]&gt;,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /// Global task queue used for:
</span></span><span class=line><span class=cl>    ///  1. Submit work to the scheduler while **not** currently on a worker thread.
</span></span><span class=line><span class=cl>    ///  2. Submit work to the scheduler when a worker run queue is saturated
</span></span><span class=line><span class=cl>    pub(super) inject: inject::Shared&lt;Arc&lt;Handle&gt;&gt;,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /// Data synchronized by the scheduler mutex
</span></span><span class=line><span class=cl>    pub(super) synced: Mutex&lt;Synced&gt;,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// runtime/scheduler/multi_thread/handle.rs
</span></span><span class=line><span class=cl>pub(crate) struct Handle {
</span></span><span class=line><span class=cl>    /// Task spawner
</span></span><span class=line><span class=cl>    pub(super) shared: worker::Shared,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /// Resource driver handles
</span></span><span class=line><span class=cl>    pub(crate) driver: driver::Handle,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /// Blocking pool spawner
</span></span><span class=line><span class=cl>    pub(crate) blocking_spawner: blocking::Spawner,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /// Current random number generator seed
</span></span><span class=line><span class=cl>    pub(crate) seed_generator: RngSeedGenerator,
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 注意，如下 Pop 时会同时传入 Synced 实现
</span></span><span class=line><span class=cl>fn next_remote_task(&amp;self) -&gt; Option&lt;Notified&gt; {
</span></span><span class=line><span class=cl>    if self.shared.inject.is_empty() {
</span></span><span class=line><span class=cl>        return None;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    let mut synced = self.shared.synced.lock();
</span></span><span class=line><span class=cl>    // safety: passing in correct `idle::Synced`
</span></span><span class=line><span class=cl>    unsafe { self.shared.inject.pop(&amp;mut synced.inject) }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>另外，会通过 <code>runtime/coop.rs</code> 处理协作式的调度。</p><a class=anchor id=源码解析></a><h1>源码解析 <a href=#%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90 aria-hidden=true>#</a></h1><p>简单来说，这也是一个通过 async 修饰的 Future 实现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>TcpStream::connect() net/tcp/stream.rs 这是一个 async 函数
</span></span><span class=line><span class=cl> |-to_socket_addrs() 这里应该是做DNS解析，每个解析后的地址会调用如下函数
</span></span><span class=line><span class=cl> |-TcpStream::connect_addr() 建立链接
</span></span><span class=line><span class=cl>   |-TcpStream::connect_mio()
</span></span><span class=line><span class=cl>     |-TcpStream::new()
</span></span><span class=line><span class=cl>     | |-PollEvented::new()
</span></span><span class=line><span class=cl>     |   |-PollEvented::new_with_interest()
</span></span><span class=line><span class=cl>     |     |-PollEvented::new_with_interest_and_handle()
</span></span><span class=line><span class=cl>     |       |-Registration::new_with_interest_and_handle() 注意这里的第三个参数是 scheduler::Handle::current() 获取，也就是 scheduler.Handle，实际调用的是 handle.driver().io().add_source(io, interest)
</span></span><span class=line><span class=cl>     |         |-Handle::driver() 这里会根据类型选择 MultiThread、CurrentThread 等实现
</span></span><span class=line><span class=cl>     |-poll_fn() 这里会调用 poll_fn() 简单封装一个 Future 实现，详见future/poll_fn.rs，暂不清楚为什么
</span></span><span class=line><span class=cl>       |-poll_read_ready() 这里有很多
</span></span></code></pre></div><a class=anchor id=task></a><h2>Task <a href=#task aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=o>//</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>task</span><span class=o>/</span><span class=n>core</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Header</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>state</span><span class=p>:</span><span class=w> </span><span class=n>State</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>queue_next</span><span class=p>:</span><span class=w> </span><span class=n>UnsafeCell</span><span class=o>&lt;</span><span class=k>Option</span><span class=o>&lt;</span><span class=n>NonNull</span><span class=o>&lt;</span><span class=n>Header</span><span class=o>&gt;&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>vtable</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=s1>&#39;static Vtable,
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) owner_id: UnsafeCell&lt;Option&lt;NonZeroU64&gt;&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) tracing_id: Option&lt;tracing::Id&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>pub(super) struct CoreStage&lt;T: Future&gt; {
</span></span></span><span class=line><span class=cl><span class=s1>    stage: UnsafeCell&lt;Stage&lt;T&gt;&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>pub(super) struct Core&lt;T: Future, S&gt; {
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) scheduler: S,
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) task_id: Id,
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) stage: CoreStage&lt;T&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>pub(super) struct Cell&lt;T: Future, S&gt; {
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) header: Header,
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) core: Core&lt;T, S&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) trailer: Trailer,
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>// runtime/task/raw.rs
</span></span></span><span class=line><span class=cl><span class=s1>pub(crate) struct RawTask {
</span></span></span><span class=line><span class=cl><span class=s1>    ptr: NonNull&lt;Header&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>// runtime/task/mod.rs
</span></span></span><span class=line><span class=cl><span class=s1>pub(crate) struct Task&lt;S: &#39;</span><span class=n>static</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>raw</span><span class=p>:</span><span class=w> </span><span class=n>RawTask</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_p</span><span class=p>:</span><span class=w> </span><span class=n>PhantomData</span><span class=o>&lt;</span><span class=n>S</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Notified</span><span class=o>&lt;</span><span class=n>S</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;static&gt;(Task&lt;S&gt;);
</span></span></span><span class=line><span class=cl><span class=s1>pub(crate) struct LocalNotified&lt;S: &#39;</span><span class=n>static</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>task</span><span class=p>:</span><span class=w> </span><span class=n>Task</span><span class=o>&lt;</span><span class=n>S</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_not_send</span><span class=p>:</span><span class=w> </span><span class=n>PhantomData</span><span class=o>&lt;*</span><span class=nf>const</span><span class=w> </span><span class=p>()</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>UnownedTask</span><span class=o>&lt;</span><span class=n>S</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;static&gt; {
</span></span></span><span class=line><span class=cl><span class=s1>    raw: RawTask,
</span></span></span><span class=line><span class=cl><span class=s1>    _p: PhantomData&lt;S&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1># LocalSet
</span></span></span><span class=line><span class=cl><span class=s1>对于多线程 runtime 来说，任务可能会在不同的线程上执行，对于某些任务如果只能在固定线程运行，那么可以使用 LocalSet 功能。
</span></span></span><span class=line><span class=cl><span class=s1>https://rust-book.junmajinlong.com/ch100/02_understand_tokio_task.html
</span></span></span><span class=line><span class=cl><span class=s1>https://www.cnblogs.com/SantiagoZhang/p/16505647.html
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1># 源码解析
</span></span></span><span class=line><span class=cl><span class=s1>## 任务创建
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>Runtime.block_on() 这里会封装一个入口，实际调用通过 Scheduler 设置，包括 CurrentThread、MultiThread 等
</span></span></span><span class=line><span class=cl><span class=s1> |-MultiThread.block_on()
</span></span></span><span class=line><span class=cl><span class=s1>   |-runtime::context::enter_runtime() 这里的调用逻辑实在是有点复杂，没有搞懂 src/runtime/context/runtime.rs ，猜测应该是调用如下函数
</span></span></span><span class=line><span class=cl><span class=s1>     |-BlockingRegionGuard::block_on()
</span></span></span><span class=line><span class=cl><span class=s1>       |-CachedParkThread::block_on() 对应的 Future 会传递到这里，这里会构造 Waker 等，有死循环
</span></span></span><span class=line><span class=cl><span class=s1>         |-CachedParkThread::waker()
</span></span></span><span class=line><span class=cl><span class=s1>fn block_on&lt;F: Future&gt;(&amp;self, future: F) -&gt; F::Output
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>// 定义了虚拟表 runtime/task/waker.rs
</span></span></span><span class=line><span class=cl><span class=s1>static WAKER_VTABLE: RawWakerVTable =
</span></span></span><span class=line><span class=cl><span class=s1>    RawWakerVTable::new(clone_waker, wake_by_val, wake_by_ref, drop_waker);
</span></span></span><span class=line><span class=cl><span class=s1>fn raw_waker(header: NonNull&lt;Header&gt;) -&gt; RawWaker {
</span></span></span><span class=line><span class=cl><span class=s1>    let ptr = header.as_ptr() as *const ();
</span></span></span><span class=line><span class=cl><span class=s1>    RawWaker::new(ptr, &amp;WAKER_VTABLE)
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>src/runtime/task/mod.rs
</span></span></span><span class=line><span class=cl><span class=s1>#[repr(transparent)]
</span></span></span><span class=line><span class=cl><span class=s1>pub(crate) struct Task&lt;S: &#39;</span><span class=n>static</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>raw</span><span class=p>:</span><span class=w> </span><span class=n>RawTask</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_p</span><span class=p>:</span><span class=w> </span><span class=n>PhantomData</span><span class=o>&lt;</span><span class=n>S</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RawTask</span><span class=p>.</span><span class=nf>wake_by_val</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=w> </span><span class=err>实现了</span><span class=w> </span><span class=n>Send</span><span class=w> </span><span class=err>和</span><span class=w> </span><span class=n>Sync</span><span class=w> </span><span class=err>这两个</span><span class=w> </span><span class=n>Trait</span><span class=err>，因此可以将</span><span class=w> </span><span class=n>runtime</span><span class=w> </span><span class=err>包在</span><span class=w> </span><span class=n>Arc</span><span class=w> </span><span class=err>里，然后跨线程使用相同的</span><span class=w> </span><span class=n>runtime</span><span class=w> </span><span class=err>实现。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MultiThread</span><span class=p>::</span><span class=nf>block_on</span><span class=p>()</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=k>mod</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>runtime</span><span class=p>::</span><span class=n>context</span><span class=p>::</span><span class=nf>enter_runtime</span><span class=p>()</span><span class=w> </span><span class=err>调用时会传入一个匿名函数，最终调用如下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>BlockingRegionGuard</span><span class=p>::</span><span class=nf>block_on</span><span class=p>()</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>context</span><span class=o>/</span><span class=n>blocking</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|-</span><span class=n>CachedParkThread</span><span class=p>::</span><span class=nf>block_on</span><span class=p>()</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>park</span><span class=p>.</span><span class=n>rs</span><span class=w> </span><span class=err>这里会阻塞循环调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>fn</span><span class=w> </span><span class=n>block_on</span><span class=o>&lt;</span><span class=n>F</span><span class=p>:</span><span class=w> </span><span class=n>Future</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mut</span><span class=w> </span><span class=n>self</span><span class=p>,</span><span class=w> </span><span class=n>f</span><span class=p>:</span><span class=w> </span><span class=n>F</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>F</span><span class=p>::</span><span class=n>Output</span><span class=p>,</span><span class=w> </span><span class=n>AccessError</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span><span class=p>::</span><span class=n>task</span><span class=p>::</span><span class=n>Context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>std</span><span class=p>::</span><span class=n>task</span><span class=p>::</span><span class=n>Poll</span><span class=p>::</span><span class=n>Ready</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>let</span><span class=w> </span><span class=n>waker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=nf>waker</span><span class=p>()</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>let</span><span class=w> </span><span class=n>mut</span><span class=w> </span><span class=n>cx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Context</span><span class=p>::</span><span class=nf>from_waker</span><span class=p>(</span><span class=o>&amp;</span><span class=n>waker</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pin</span><span class=o>!</span><span class=p>(</span><span class=n>f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>let</span><span class=w> </span><span class=nf>Ready</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>crate</span><span class=p>::</span><span class=n>runtime</span><span class=p>::</span><span class=n>coop</span><span class=p>::</span><span class=nf>budget</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=n>f</span><span class=p>.</span><span class=nf>as_mut</span><span class=p>().</span><span class=nf>poll</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mut</span><span class=w> </span><span class=n>cx</span><span class=p>))</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nf>Ok</span><span class=p>(</span><span class=n>v</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>self</span><span class=p>.</span><span class=nf>park</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>这里实际上就是一直调用该函数了，除此之外，还包括了</span><span class=w> </span><span class=nf>spawn</span><span class=p>()</span><span class=w> </span><span class=err>函数。在执行</span><span class=w> </span><span class=nf>spawn</span><span class=p>()</span><span class=w> </span><span class=err>函数时，有两种方法：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>*</span><span class=w> </span><span class=n>Runtime</span><span class=p>[</span><span class=n>runtime</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=p>]</span><span class=w> </span><span class=err>最终会调用具体</span><span class=w> </span><span class=n>Scheduler</span><span class=w> </span><span class=err>执行，例如</span><span class=w> </span><span class=n>MultiThread</span><span class=w> </span><span class=err>对应了</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=w> </span><span class=err>中的</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>实现。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>*</span><span class=w> </span><span class=n>tokio</span><span class=p>::</span><span class=nf>spawn</span><span class=p>()</span><span class=w> </span><span class=err>这也是最常用的，在</span><span class=w> </span><span class=n>lib</span><span class=p>.</span><span class=n>rs</span><span class=w> </span><span class=err>中通过</span><span class=w> </span><span class=n>pub</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=n>task</span><span class=p>::</span><span class=n>spawn</span><span class=w> </span><span class=err>将相关实现保留到了库级别。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Handle</span><span class=p>::</span><span class=nf>spawn</span><span class=p>()</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>Handle</span><span class=p>::</span><span class=nf>spawn_named</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>runtime</span><span class=p>::</span><span class=n>task</span><span class=p>::</span><span class=n>Id</span><span class=p>::</span><span class=nf>next</span><span class=p>()</span><span class=w> </span><span class=err>获取任务</span><span class=n>ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|-</span><span class=n>MultiThread</span><span class=p>::</span><span class=n>Handle</span><span class=p>::</span><span class=nf>spawn</span><span class=p>()</span><span class=w> </span><span class=err>这里通过</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=k>inner</span><span class=p>.</span><span class=nf>spawn</span><span class=p>(</span><span class=n>future</span><span class=p>,</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=err>调用，如下以</span><span class=w> </span><span class=n>MultiThread</span><span class=w> </span><span class=err>实现为例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>task</span><span class=p>::</span><span class=nf>spawn</span><span class=p>()</span><span class=w> </span><span class=n>task</span><span class=o>/</span><span class=n>spawn</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>task</span><span class=p>::</span><span class=nf>spawn_inner</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>MultiThread</span><span class=p>::</span><span class=n>Handle</span><span class=p>::</span><span class=nf>spawn</span><span class=p>()</span><span class=w> </span><span class=err>会通过</span><span class=w> </span><span class=n>context</span><span class=p>::</span><span class=n>with_current</span><span class=w> </span><span class=err>调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>这种方式要求</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=err>是</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;static
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1># MultiThread
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>runtime/scheduler/multi_thread/worker.rs
</span></span></span><span class=line><span class=cl><span class=s1>/// State shared across all workers
</span></span></span><span class=line><span class=cl><span class=s1>pub(crate) struct Shared {
</span></span></span><span class=line><span class=cl><span class=s1>    pub(crate) owned: OwnedTasks&lt;Arc&lt;Handle&gt;&gt;, // 添加到该Executor的任务列表
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Per-worker remote state. All other workers have access to this and is
</span></span></span><span class=line><span class=cl><span class=s1>    /// how they communicate between each other.
</span></span></span><span class=line><span class=cl><span class=s1>    remotes: Box&lt;[Remote]&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Global task queue used for:
</span></span></span><span class=line><span class=cl><span class=s1>    ///  1. Submit work to the scheduler while **not** currently on a worker thread.
</span></span></span><span class=line><span class=cl><span class=s1>    ///  2. Submit work to the scheduler when a worker run queue is saturated
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) inject: inject::Shared&lt;Arc&lt;Handle&gt;&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Coordinates idle workers
</span></span></span><span class=line><span class=cl><span class=s1>    idle: Idle,
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Data synchronized by the scheduler mutex
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) synced: Mutex&lt;Synced&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Cores that have observed the shutdown signal
</span></span></span><span class=line><span class=cl><span class=s1>    ///
</span></span></span><span class=line><span class=cl><span class=s1>    /// The core is **not** placed back in the worker to avoid it from being
</span></span></span><span class=line><span class=cl><span class=s1>    /// stolen by a thread that was spawned as part of `block_in_place`.
</span></span></span><span class=line><span class=cl><span class=s1>    #[allow(clippy::vec_box)] // we&#39;</span><span class=n>re</span><span class=w> </span><span class=n>moving</span><span class=w> </span><span class=n>an</span><span class=w> </span><span class=n>already</span><span class=o>-</span><span class=n>boxed</span><span class=w> </span><span class=n>value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>shutdown_cores</span><span class=p>:</span><span class=w> </span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>Vec</span><span class=o>&lt;</span><span class=n>Box</span><span class=o>&lt;</span><span class=n>Core</span><span class=o>&gt;&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>The</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>cores</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=n>have</span><span class=w> </span><span class=n>observed</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>trace</span><span class=w> </span><span class=n>signal</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>trace_status</span><span class=p>:</span><span class=w> </span><span class=n>TraceStatus</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Scheduler</span><span class=w> </span><span class=n>configuration</span><span class=w> </span><span class=n>options</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>config</span><span class=p>:</span><span class=w> </span><span class=n>Config</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Collects</span><span class=w> </span><span class=n>metrics</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>runtime</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>scheduler_metrics</span><span class=p>:</span><span class=w> </span><span class=n>SchedulerMetrics</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>worker_metrics</span><span class=p>:</span><span class=w> </span><span class=n>Box</span><span class=o>&lt;</span><span class=p>[</span><span class=n>WorkerMetrics</span><span class=p>]</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Only</span><span class=w> </span><span class=n>held</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>trigger</span><span class=w> </span><span class=n>some</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>drop</span><span class=p>.</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>used</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>get</span><span class=w> </span><span class=n>internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>runtime</span><span class=w> </span><span class=n>metrics</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=n>can</span><span class=w> </span><span class=n>be</span><span class=w> </span><span class=n>useful</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=n>doing</span><span class=w> </span><span class=n>performance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>investigations</span><span class=p>.</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=n>does</span><span class=w> </span><span class=nf>nothing</span><span class=w> </span><span class=p>(</span><span class=n>empty</span><span class=w> </span><span class=n>struct</span><span class=p>,</span><span class=w> </span><span class=n>no</span><span class=w> </span><span class=k>drop</span><span class=w> </span><span class=n>impl</span><span class=p>)</span><span class=w> </span><span class=n>unless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>tokio_internal_mt_counters</span><span class=o>`</span><span class=w> </span><span class=o>`</span><span class=n>cfg</span><span class=o>`</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=kt>set</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_counters</span><span class=p>:</span><span class=w> </span><span class=n>Counters</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>///</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>multi</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Task</span><span class=w> </span><span class=n>spawner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>shared</span><span class=p>:</span><span class=w> </span><span class=n>worker</span><span class=p>::</span><span class=n>Shared</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Resource</span><span class=w> </span><span class=n>driver</span><span class=w> </span><span class=n>handles</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=n>driver</span><span class=p>::</span><span class=n>Handle</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Blocking</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=n>spawner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>blocking_spawner</span><span class=p>:</span><span class=w> </span><span class=n>blocking</span><span class=p>::</span><span class=n>Spawner</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Current</span><span class=w> </span><span class=n>random</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=n>generator</span><span class=w> </span><span class=n>seed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>seed_generator</span><span class=p>:</span><span class=w> </span><span class=n>RngSeedGenerator</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>const</span><span class=w> </span><span class=n>TOKEN_WAKEUP</span><span class=p>:</span><span class=w> </span><span class=n>mio</span><span class=p>::</span><span class=n>Token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mio</span><span class=p>::</span><span class=nf>Token</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>const</span><span class=w> </span><span class=n>TOKEN_SIGNAL</span><span class=p>:</span><span class=w> </span><span class=n>mio</span><span class=p>::</span><span class=n>Token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mio</span><span class=p>::</span><span class=nf>Token</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>scheduled_io</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>ScheduledIo</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>linked_list_pointers</span><span class=p>:</span><span class=w> </span><span class=n>UnsafeCell</span><span class=o>&lt;</span><span class=n>linked_list</span><span class=p>::</span><span class=n>Pointers</span><span class=o>&lt;</span><span class=n>Self</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>readiness</span><span class=p>:</span><span class=w> </span><span class=n>AtomicUsize</span><span class=p>,</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=err>为了兼容</span><span class=mi>32</span><span class=err>位，只用了</span><span class=mi>32</span><span class=err>位</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>waiters</span><span class=p>:</span><span class=w> </span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>Waiters</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Driver</span><span class=p>::</span><span class=nf>park</span><span class=p>()</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>driver</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>Driver</span><span class=p>::</span><span class=nf>turn</span><span class=p>()</span><span class=w> </span><span class=err>会获取</span><span class=n>IO</span><span class=err>然后调度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=n>ScheduledIo</span><span class=p>::</span><span class=nf>set_readiness</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>这里对应的唤醒实现为</span><span class=w> </span><span class=n>Handle</span><span class=p>.</span><span class=nf>unpark</span><span class=p>()</span><span class=w> </span><span class=err>实现。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>///</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=n>returned</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=o>`</span><span class=nf>readiness</span><span class=p>()</span><span class=o>`</span><span class=err>，这里会应用</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=err>接口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>struct</span><span class=w> </span><span class=n>Readiness</span><span class=o>&lt;</span><span class=s1>&#39;a&gt; {
</span></span></span><span class=line><span class=cl><span class=s1>    scheduled_io: &amp;&#39;</span><span class=n>a</span><span class=w> </span><span class=n>ScheduledIo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>state</span><span class=p>:</span><span class=w> </span><span class=n>State</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Entry</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>waiter</span><span class=w> </span><span class=o>`</span><span class=n>LinkedList</span><span class=o>`</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>waiter</span><span class=p>:</span><span class=w> </span><span class=n>UnsafeCell</span><span class=o>&lt;</span><span class=n>Waiter</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>registration</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Registration</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>associated</span><span class=w> </span><span class=n>runtime</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>TODO</span><span class=p>:</span><span class=w> </span><span class=n>this</span><span class=w> </span><span class=n>can</span><span class=w> </span><span class=n>probably</span><span class=w> </span><span class=n>be</span><span class=w> </span><span class=n>moved</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=o>`</span><span class=n>ScheduledIo</span><span class=o>`</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>handle</span><span class=p>:</span><span class=w> </span><span class=n>scheduler</span><span class=p>::</span><span class=n>Handle</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Reference</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=n>stored</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>driver</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>shared</span><span class=p>:</span><span class=w> </span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>ScheduledIo</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>net</span><span class=o>/</span><span class=n>tcp</span><span class=o>/</span><span class=n>stream</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pub</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>TcpStream</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>io</span><span class=p>:</span><span class=w> </span><span class=n>PollEvented</span><span class=o>&lt;</span><span class=n>mio</span><span class=p>::</span><span class=n>net</span><span class=p>::</span><span class=n>TcpStream</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>io</span><span class=o>/</span><span class=n>poll_evented</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>PollEvented</span><span class=o>&lt;</span><span class=n>E</span><span class=p>:</span><span class=w> </span><span class=n>Source</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>io</span><span class=p>:</span><span class=w> </span><span class=k>Option</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registration</span><span class=p>:</span><span class=w> </span><span class=n>Registration</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>fn</span><span class=w> </span><span class=nf>new</span><span class=p>(</span><span class=n>io</span><span class=p>:</span><span class=w> </span><span class=n>E</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>io</span><span class=p>::</span><span class=n>Result</span><span class=o>&lt;</span><span class=n>Self</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PollEvented</span><span class=p>::</span><span class=nf>new_with_interest</span><span class=p>(</span><span class=n>io</span><span class=p>,</span><span class=w> </span><span class=n>Interest</span><span class=p>::</span><span class=n>READABLE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Interest</span><span class=p>::</span><span class=n>WRITABLE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>fn</span><span class=w> </span><span class=nf>new_with_interest</span><span class=p>(</span><span class=n>io</span><span class=p>:</span><span class=w> </span><span class=n>E</span><span class=p>,</span><span class=w> </span><span class=n>interest</span><span class=p>:</span><span class=w> </span><span class=n>Interest</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>io</span><span class=p>::</span><span class=n>Result</span><span class=o>&lt;</span><span class=n>Self</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Self</span><span class=p>::</span><span class=nf>new_with_interest_and_handle</span><span class=p>(</span><span class=n>io</span><span class=p>,</span><span class=w> </span><span class=n>interest</span><span class=p>,</span><span class=w> </span><span class=n>scheduler</span><span class=p>::</span><span class=n>Handle</span><span class=p>::</span><span class=nf>current</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>fn</span><span class=w> </span><span class=nf>new_with_interest_and_handle</span><span class=p>(</span><span class=n>mut</span><span class=w> </span><span class=n>io</span><span class=p>:</span><span class=w> </span><span class=n>E</span><span class=p>,</span><span class=w> </span><span class=n>interest</span><span class=p>:</span><span class=w> </span><span class=n>Interest</span><span class=p>,</span><span class=w> </span><span class=n>handle</span><span class=p>:</span><span class=w> </span><span class=n>scheduler</span><span class=p>::</span><span class=n>Handle</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>io</span><span class=p>::</span><span class=n>Result</span><span class=o>&lt;</span><span class=n>Self</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>let</span><span class=w> </span><span class=n>registration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Registration</span><span class=p>::</span><span class=nf>new_with_interest_and_handle</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mut</span><span class=w> </span><span class=n>io</span><span class=p>,</span><span class=w> </span><span class=n>interest</span><span class=p>,</span><span class=w> </span><span class=n>handle</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Ok</span><span class=p>(</span><span class=n>Self</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>io</span><span class=p>:</span><span class=w> </span><span class=nf>Some</span><span class=p>(</span><span class=n>io</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registration</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>}</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>registration</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>fn</span><span class=w> </span><span class=nf>new_with_interest_and_handle</span><span class=p>(</span><span class=n>io</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=n>mut</span><span class=w> </span><span class=n>impl</span><span class=w> </span><span class=n>Source</span><span class=p>,</span><span class=w> </span><span class=n>interest</span><span class=p>:</span><span class=w> </span><span class=n>Interest</span><span class=p>,</span><span class=w> </span><span class=n>handle</span><span class=p>:</span><span class=w> </span><span class=n>scheduler</span><span class=p>::</span><span class=n>Handle</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>io</span><span class=p>::</span><span class=n>Result</span><span class=o>&lt;</span><span class=n>Registration</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>let</span><span class=w> </span><span class=n>shared</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handle</span><span class=p>.</span><span class=nf>driver</span><span class=p>().</span><span class=nf>io</span><span class=p>().</span><span class=nf>add_source</span><span class=p>(</span><span class=n>io</span><span class=p>,</span><span class=w> </span><span class=n>interest</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=err>这里的数据结构是怎么保存的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Ok</span><span class=p>(</span><span class=n>Registration</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=n>handle</span><span class=p>,</span><span class=w> </span><span class=n>shared</span><span class=w> </span><span class=err>}</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>add_source</span><span class=p>()</span><span class=w> </span><span class=err>对应的实现在</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>driver</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>driver</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>///</span><span class=w> </span><span class=n>I</span><span class=o>/</span><span class=n>O</span><span class=w> </span><span class=n>driver</span><span class=p>,</span><span class=w> </span><span class=n>backed</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>Mio</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Driver</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=no>True</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=n>an</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>signal</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>received</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>signal_ready</span><span class=p>:</span><span class=w> </span><span class=kt>bool</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Reuse</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>mio</span><span class=p>::</span><span class=n>Events</span><span class=o>`</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=n>across</span><span class=w> </span><span class=n>calls</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>poll</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>events</span><span class=p>:</span><span class=w> </span><span class=n>mio</span><span class=p>::</span><span class=n>Events</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>The</span><span class=w> </span><span class=n>system</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>queue</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>poll</span><span class=p>:</span><span class=w> </span><span class=n>mio</span><span class=p>::</span><span class=n>Poll</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>///</span><span class=w> </span><span class=n>A</span><span class=w> </span><span class=n>reference</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>an</span><span class=w> </span><span class=n>I</span><span class=o>/</span><span class=n>O</span><span class=w> </span><span class=n>driver</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Registers</span><span class=w> </span><span class=n>I</span><span class=o>/</span><span class=n>O</span><span class=w> </span><span class=n>resources</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span><span class=p>:</span><span class=w> </span><span class=n>mio</span><span class=p>::</span><span class=n>Registry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Tracks</span><span class=w> </span><span class=k>all</span><span class=w> </span><span class=n>registrations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registrations</span><span class=p>:</span><span class=w> </span><span class=n>RegistrationSet</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>State</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=n>should</span><span class=w> </span><span class=n>be</span><span class=w> </span><span class=n>synchronized</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>synced</span><span class=p>:</span><span class=w> </span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>registration_set</span><span class=p>::</span><span class=n>Synced</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Used</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>wake</span><span class=w> </span><span class=n>up</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>reactor</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>call</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=o>`</span><span class=n>turn</span><span class=o>`</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=k>Not</span><span class=w> </span><span class=n>supported</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=o>`</span><span class=n>Wasi</span><span class=o>`</span><span class=w> </span><span class=n>due</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>lack</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>threading</span><span class=w> </span><span class=n>support</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>#[cfg(not(target_os = &#34;wasi&#34;))]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>waker</span><span class=p>:</span><span class=w> </span><span class=n>mio</span><span class=p>::</span><span class=n>Waker</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>metrics</span><span class=p>:</span><span class=w> </span><span class=n>IoDriverMetrics</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>impl</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>fn</span><span class=w> </span><span class=nf>add_source</span><span class=p>(</span><span class=o>&amp;</span><span class=n>self</span><span class=p>,</span><span class=w> </span><span class=n>source</span><span class=p>:</span><span class=w> </span><span class=o>&amp;</span><span class=n>mut</span><span class=w> </span><span class=n>impl</span><span class=w> </span><span class=n>mio</span><span class=p>::</span><span class=n>event</span><span class=p>::</span><span class=n>Source</span><span class=p>,</span><span class=w> </span><span class=n>interest</span><span class=p>:</span><span class=w> </span><span class=n>Interest</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>io</span><span class=p>::</span><span class=n>Result</span><span class=o>&lt;</span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>ScheduledIo</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>let</span><span class=w> </span><span class=n>scheduled_io</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=n>registrations</span><span class=p>.</span><span class=nf>allocate</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mut</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=n>synced</span><span class=p>.</span><span class=k>lock</span><span class=p>())</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>let</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>scheduled_io</span><span class=p>.</span><span class=nf>token</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>//</span><span class=w> </span><span class=n>we</span><span class=w> </span><span class=n>should</span><span class=w> </span><span class=n>remove</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>scheduled_io</span><span class=o>`</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>registrations</span><span class=o>`</span><span class=w> </span><span class=kt>set</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>registering</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>//</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>source</span><span class=o>`</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>OS</span><span class=w> </span><span class=n>fails</span><span class=p>.</span><span class=w> </span><span class=n>Otherwise</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=n>will</span><span class=w> </span><span class=n>leak</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>scheduled_io</span><span class=o>`</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>let</span><span class=w> </span><span class=nf>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=n>registry</span><span class=p>.</span><span class=nf>register</span><span class=p>(</span><span class=n>source</span><span class=p>,</span><span class=w> </span><span class=n>token</span><span class=p>,</span><span class=w> </span><span class=n>interest</span><span class=p>.</span><span class=nf>to_mio</span><span class=p>())</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>//</span><span class=w> </span><span class=n>safety</span><span class=p>:</span><span class=w> </span><span class=o>`</span><span class=n>scheduled_io</span><span class=o>`</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>part</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>registrations</span><span class=o>`</span><span class=w> </span><span class=kt>set</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unsafe</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>self</span><span class=p>.</span><span class=n>registrations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=nf>remove</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mut</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=n>synced</span><span class=p>.</span><span class=k>lock</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=n>scheduled_io</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=err>}</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nf>Err</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>//</span><span class=w> </span><span class=n>TODO</span><span class=p>:</span><span class=w> </span><span class=n>move</span><span class=w> </span><span class=n>this</span><span class=w> </span><span class=n>logic</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=o>`</span><span class=n>RegistrationSet</span><span class=o>`</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>`</span><span class=n>CountedLinkedList</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>self</span><span class=p>.</span><span class=n>metrics</span><span class=p>.</span><span class=nf>incr_fd_count</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>Ok</span><span class=p>(</span><span class=n>scheduled_io</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>几乎每个模块里都会有</span><span class=w> </span><span class=n>Driver</span><span class=w> </span><span class=err>和</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>两个模块，如下以简单的</span><span class=w> </span><span class=n>signal</span><span class=w> </span><span class=err>为例。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>docs</span><span class=p>.</span><span class=n>rs</span><span class=o>/</span><span class=n>tokio</span><span class=o>/</span><span class=n>latest</span><span class=o>/</span><span class=n>tokio</span><span class=o>/</span><span class=n>signal</span><span class=o>/</span><span class=k>index</span><span class=p>.</span><span class=n>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>signal</span><span class=o>/</span><span class=k>mod</span><span class=p>.</span><span class=n>rs</span><span class=p>:</span><span class=mi>33</span><span class=p>:</span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=kt>time</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=p>:</span><span class=mi>5</span><span class=p>:</span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>io</span><span class=o>/</span><span class=n>driver</span><span class=p>.</span><span class=n>rs</span><span class=p>:</span><span class=mi>32</span><span class=p>:</span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>driver</span><span class=p>.</span><span class=n>rs</span><span class=p>:</span><span class=mi>21</span><span class=p>:</span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=p>:</span><span class=mi>14</span><span class=p>:</span><span class=n>pub</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>current_thread</span><span class=o>/</span><span class=k>mod</span><span class=p>.</span><span class=n>rs</span><span class=p>:</span><span class=mi>32</span><span class=p>:</span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread_alt</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=p>:</span><span class=mi>17</span><span class=p>:</span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=p>:</span><span class=mi>21</span><span class=p>:</span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>signal</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=nf>signal_with_handle</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>|-</span><span class=nf>signal_enable</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>|-</span><span class=n>Handle</span><span class=p>::</span><span class=nf>check_inner</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pub</span><span class=w> </span><span class=n>fn</span><span class=w> </span><span class=nf>signal</span><span class=p>(</span><span class=n>kind</span><span class=p>:</span><span class=w> </span><span class=n>SignalKind</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>io</span><span class=p>::</span><span class=n>Result</span><span class=o>&lt;</span><span class=n>Signal</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>let</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>scheduler</span><span class=p>::</span><span class=n>Handle</span><span class=p>::</span><span class=nf>current</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>let</span><span class=w> </span><span class=n>rx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nf>signal_with_handle</span><span class=p>(</span><span class=n>kind</span><span class=p>,</span><span class=w> </span><span class=n>handle</span><span class=p>.</span><span class=nf>driver</span><span class=p>().</span><span class=nf>signal</span><span class=p>())</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Ok</span><span class=p>(</span><span class=n>Signal</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>inner</span><span class=p>:</span><span class=w> </span><span class=n>RxFuture</span><span class=p>::</span><span class=nf>new</span><span class=p>(</span><span class=n>rx</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>}</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>defer</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Defer</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>deferred</span><span class=p>:</span><span class=w> </span><span class=n>RefCell</span><span class=o>&lt;</span><span class=n>Vec</span><span class=o>&lt;</span><span class=n>Waker</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=err>这里是个数组啊</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>worker</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>worker</span><span class=p>:</span><span class=w> </span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Worker</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>core</span><span class=p>:</span><span class=w> </span><span class=n>RefCell</span><span class=o>&lt;</span><span class=k>Option</span><span class=o>&lt;</span><span class=n>Box</span><span class=o>&lt;</span><span class=n>Core</span><span class=o>&gt;&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>defer</span><span class=p>:</span><span class=w> </span><span class=n>Defer</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>worker</span><span class=p>.</span><span class=n>rs</span><span class=w> </span><span class=err>这里的</span><span class=w> </span><span class=n>Run</span><span class=w> </span><span class=err>也会调用如下函数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Handle</span><span class=p>::</span><span class=nf>block_on</span><span class=p>()[</span><span class=n>runtime</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>|-</span><span class=n>context</span><span class=p>::</span><span class=nf>enter_runtime</span><span class=p>()[</span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>worker</span><span class=p>.</span><span class=n>rs</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>其中设置，就在上述的</span><span class=w> </span><span class=nf>enter_runtime</span><span class=p>()</span><span class=w> </span><span class=err>函数中。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>zhuanlan</span><span class=p>.</span><span class=n>zhihu</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>p</span><span class=o>/</span><span class=mi>104098627</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>juejin</span><span class=p>.</span><span class=n>cn</span><span class=o>/</span><span class=n>post</span><span class=o>/</span><span class=mi>7216217118588747837</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>rustmagazine</span><span class=p>.</span><span class=n>github</span><span class=p>.</span><span class=n>io</span><span class=o>/</span><span class=n>rust_magazine_2021</span><span class=o>/</span><span class=n>chapter_12</span><span class=o>/</span><span class=n>monoio</span><span class=p>.</span><span class=n>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>rust</span><span class=o>-</span><span class=n>lang</span><span class=p>.</span><span class=n>github</span><span class=p>.</span><span class=n>io</span><span class=o>/</span><span class=n>async</span><span class=o>-</span><span class=n>book</span><span class=o>/</span><span class=mi>02</span><span class=n>_execution</span><span class=o>/</span><span class=mi>04</span><span class=n>_executor</span><span class=p>.</span><span class=n>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>tony612</span><span class=p>.</span><span class=n>github</span><span class=p>.</span><span class=n>io</span><span class=o>/</span><span class=n>tokio</span><span class=o>-</span><span class=n>internals</span><span class=o>/</span><span class=mi>02</span><span class=n>_main_thread_2</span><span class=p>.</span><span class=n>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>www</span><span class=p>.</span><span class=n>driftluo</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>article</span><span class=o>/</span><span class=n>c88d853a</span><span class=o>-</span><span class=mi>7</span><span class=n>ad4</span><span class=o>-</span><span class=mi>47</span><span class=n>ea</span><span class=o>-</span><span class=n>b7b4</span><span class=o>-</span><span class=mi>778</span><span class=n>dec039350</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>xie</span><span class=p>.</span><span class=n>infoq</span><span class=p>.</span><span class=n>cn</span><span class=o>/</span><span class=n>article</span><span class=o>/</span><span class=mi>5694</span><span class=n>ce615d1095cf6e1a5d0ae</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>zhuanlan</span><span class=p>.</span><span class=n>zhihu</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>p</span><span class=o>/</span><span class=mi>129273132</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>stevenbai</span><span class=p>.</span><span class=n>top</span><span class=o>/</span><span class=n>books</span><span class=o>-</span><span class=n>futures</span><span class=o>-</span><span class=n>explained</span><span class=o>/</span><span class=n>book</span><span class=o>/</span><span class=mi>6</span><span class=n>_future_example</span><span class=p>.</span><span class=n>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>juejin</span><span class=p>.</span><span class=n>cn</span><span class=o>/</span><span class=n>post</span><span class=o>/</span><span class=mi>7063022099689897991</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>zlotus</span><span class=p>.</span><span class=n>github</span><span class=p>.</span><span class=n>io</span><span class=o>/</span><span class=mi>2021</span><span class=o>/</span><span class=mi>04</span><span class=o>/</span><span class=mi>14</span><span class=o>/</span><span class=n>writing</span><span class=o>-</span><span class=n>an</span><span class=o>-</span><span class=n>os</span><span class=o>-</span><span class=k>in</span><span class=o>-</span><span class=n>rust</span><span class=o>-</span><span class=mi>4</span><span class=p>.</span><span class=mi>1</span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>zhuanlan</span><span class=p>.</span><span class=n>zhihu</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>p</span><span class=o>/</span><span class=mi>66028983</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>dongs</span><span class=p>.</span><span class=n>xyz</span><span class=o>/</span><span class=n>post</span><span class=o>/</span><span class=n>behind</span><span class=o>-</span><span class=n>tokio</span><span class=o>-</span><span class=n>spawn</span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>这里有个自己实现的，应该是字节的代码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>www</span><span class=p>.</span><span class=n>ihcblog</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>rust</span><span class=o>-</span><span class=n>runtime</span><span class=o>-</span><span class=n>design</span><span class=o>-</span><span class=mi>1</span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>stevenbai</span><span class=p>.</span><span class=n>top</span><span class=o>/</span><span class=n>books</span><span class=o>-</span><span class=n>futures</span><span class=o>-</span><span class=n>explained</span><span class=o>/</span><span class=n>book</span><span class=o>/</span><span class=mi>1</span><span class=n>_futures_in_rust</span><span class=p>.</span><span class=n>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>rust</span><span class=o>-</span><span class=n>book</span><span class=p>.</span><span class=n>junmajinlong</span><span class=p>.</span><span class=n>com</span><span class=o>/</span><span class=n>ch100</span><span class=o>/</span><span class=mi>01</span><span class=n>_understand_tokio_runtime</span><span class=p>.</span><span class=n>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>lemire</span><span class=p>.</span><span class=n>me</span><span class=o>/</span><span class=n>blog</span><span class=o>/</span><span class=mi>2016</span><span class=o>/</span><span class=mi>06</span><span class=o>/</span><span class=mi>27</span><span class=o>/</span><span class=n>a</span><span class=o>-</span><span class=n>fast</span><span class=o>-</span><span class=n>alternative</span><span class=o>-</span><span class=k>to</span><span class=o>-</span><span class=n>the</span><span class=o>-</span><span class=n>modulo</span><span class=o>-</span><span class=n>reduction</span><span class=o>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>src</span><span class=o>/</span><span class=n>util</span><span class=o>/</span><span class=n>rand</span><span class=p>.</span><span class=n>rs</span><span class=w> </span><span class=err>这里有个</span><span class=w> </span><span class=n>FastRand</span><span class=w> </span><span class=err>的实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>worker</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>调度运行的核心</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>如何优雅关闭</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>tokio</span><span class=p>.</span><span class=n>rs</span><span class=o>/</span><span class=n>tokio</span><span class=o>/</span><span class=n>topics</span><span class=o>/</span><span class=n>shutdown</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1># MultiThread
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>//</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>handle</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>shared</span><span class=p>:</span><span class=w> </span><span class=n>worker</span><span class=p>::</span><span class=n>Shared</span><span class=p>,</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=err>详见如下</span><span class=w> </span><span class=n>Shared</span><span class=w> </span><span class=err>实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>driver</span><span class=p>:</span><span class=w> </span><span class=n>driver</span><span class=p>::</span><span class=n>Handle</span><span class=p>,</span><span class=w> </span><span class=o>//</span><span class=w> </span><span class=err>应该是对应</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Handle</span><span class=p>[</span><span class=n>runtime</span><span class=o>/</span><span class=n>driver</span><span class=p>.</span><span class=n>rs</span><span class=p>]</span><span class=w> </span><span class=err>实现</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>blocking_spawner</span><span class=p>:</span><span class=w> </span><span class=n>blocking</span><span class=p>::</span><span class=n>Spawner</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>seed_generator</span><span class=p>:</span><span class=w> </span><span class=n>RngSeedGenerator</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=w> </span><span class=err>下面这个结构体里的</span><span class=w> </span><span class=n>inject</span><span class=o>+</span><span class=n>synced</span><span class=w> </span><span class=err>操作实在是没有搞懂啊，整这么复杂吗</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>worker</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Shared</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>remotes</span><span class=p>:</span><span class=w> </span><span class=n>Box</span><span class=o>&lt;</span><span class=p>[</span><span class=n>Remote</span><span class=p>]</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>inject</span><span class=p>:</span><span class=w> </span><span class=n>inject</span><span class=p>::</span><span class=n>Shared</span><span class=o>&lt;</span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Handle</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>idle</span><span class=p>:</span><span class=w> </span><span class=n>Idle</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>owned</span><span class=p>:</span><span class=w> </span><span class=n>OwnedTasks</span><span class=o>&lt;</span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>Handle</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>synced</span><span class=p>:</span><span class=w> </span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>Synced</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>shutdown_cores</span><span class=p>:</span><span class=w> </span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>Vec</span><span class=o>&lt;</span><span class=n>Box</span><span class=o>&lt;</span><span class=n>Core</span><span class=o>&gt;&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>trace_status</span><span class=p>:</span><span class=w> </span><span class=n>TraceStatus</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>config</span><span class=p>:</span><span class=w> </span><span class=n>Config</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>scheduler_metrics</span><span class=p>:</span><span class=w> </span><span class=n>SchedulerMetrics</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>worker_metrics</span><span class=p>:</span><span class=w> </span><span class=n>Box</span><span class=o>&lt;</span><span class=p>[</span><span class=n>WorkerMetrics</span><span class=p>]</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_counters</span><span class=p>:</span><span class=w> </span><span class=n>Counters</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=w> </span><span class=err>这里的</span><span class=w> </span><span class=n>mutex</span><span class=w> </span><span class=err>执行了</span><span class=w> </span><span class=k>lock</span><span class=p>()</span><span class=w> </span><span class=err>之后竟然可以跟</span><span class=w> </span><span class=p>.</span><span class=n>inject</span><span class=w> </span><span class=err>怀疑是</span><span class=w> </span><span class=n>loom</span><span class=w> </span><span class=err>工具的原因</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>multi_thread</span><span class=o>/</span><span class=n>worker</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>fn</span><span class=w> </span><span class=nf>close</span><span class=p>(</span><span class=o>&amp;</span><span class=n>self</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=n>shared</span><span class=p>.</span><span class=n>inject</span><span class=p>.</span><span class=nf>close</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mut</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=n>shared</span><span class=p>.</span><span class=n>synced</span><span class=p>.</span><span class=k>lock</span><span class=p>().</span><span class=n>inject</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>self</span><span class=p>.</span><span class=nf>notify_all</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=w> </span><span class=n>runtime</span><span class=o>/</span><span class=n>scheduler</span><span class=o>/</span><span class=n>inject</span><span class=o>/</span><span class=n>shared</span><span class=p>.</span><span class=n>rs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>pub</span><span class=p>(</span><span class=n>crate</span><span class=p>)</span><span class=w> </span><span class=n>struct</span><span class=w> </span><span class=n>Shared</span><span class=o>&lt;</span><span class=n>T</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;static&gt; {
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) len: AtomicUsize,
</span></span></span><span class=line><span class=cl><span class=s1>    _p: PhantomData&lt;T&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>// runtime/scheduler/inject/synced.rs
</span></span></span><span class=line><span class=cl><span class=s1>pub(crate) struct Synced {
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) is_closed: bool,
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) head: Option&lt;task::RawTask&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) tail: Option&lt;task::RawTask&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>全局任务获取，详见
</span></span></span><span class=line><span class=cl><span class=s1>next_remote_task()
</span></span></span><span class=line><span class=cl><span class=s1> |-
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>/// State shared across all workers
</span></span></span><span class=line><span class=cl><span class=s1>pub(crate) struct Shared {
</span></span></span><span class=line><span class=cl><span class=s1>    /// Per-worker remote state. All other workers have access to this and is
</span></span></span><span class=line><span class=cl><span class=s1>    /// how they communicate between each other.
</span></span></span><span class=line><span class=cl><span class=s1>    remotes: Box&lt;[Remote]&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Global task queue used for:
</span></span></span><span class=line><span class=cl><span class=s1>    ///  1. Submit work to the scheduler while **not** currently on a worker thread.
</span></span></span><span class=line><span class=cl><span class=s1>    ///  2. Submit work to the scheduler when a worker run queue is saturated
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) inject: inject::Shared&lt;Arc&lt;Handle&gt;&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Coordinates idle workers
</span></span></span><span class=line><span class=cl><span class=s1>    idle: Idle,
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Collection of all active tasks spawned onto this executor.
</span></span></span><span class=line><span class=cl><span class=s1>    pub(crate) owned: OwnedTasks&lt;Arc&lt;Handle&gt;&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Data synchronized by the scheduler mutex
</span></span></span><span class=line><span class=cl><span class=s1>    pub(super) synced: Mutex&lt;Synced&gt;,
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    /// Cores that have observed the shutdown signal
</span></span></span><span class=line><span class=cl><span class=s1>    ///
</span></span></span><span class=line><span class=cl><span class=s1>    /// The core is **not** placed back in the worker to avoid it from being
</span></span></span><span class=line><span class=cl><span class=s1>    /// stolen by a thread that was spawned as part of `block_in_place`.
</span></span></span><span class=line><span class=cl><span class=s1>    #[allow(clippy::vec_box)] // we&#39;</span><span class=n>re</span><span class=w> </span><span class=n>moving</span><span class=w> </span><span class=n>an</span><span class=w> </span><span class=n>already</span><span class=o>-</span><span class=n>boxed</span><span class=w> </span><span class=n>value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>shutdown_cores</span><span class=p>:</span><span class=w> </span><span class=n>Mutex</span><span class=o>&lt;</span><span class=n>Vec</span><span class=o>&lt;</span><span class=n>Box</span><span class=o>&lt;</span><span class=n>Core</span><span class=o>&gt;&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>The</span><span class=w> </span><span class=n>number</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>cores</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=n>have</span><span class=w> </span><span class=n>observed</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>trace</span><span class=w> </span><span class=n>signal</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>trace_status</span><span class=p>:</span><span class=w> </span><span class=n>TraceStatus</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Scheduler</span><span class=w> </span><span class=n>configuration</span><span class=w> </span><span class=n>options</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>config</span><span class=p>:</span><span class=w> </span><span class=n>Config</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Collects</span><span class=w> </span><span class=n>metrics</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>runtime</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>scheduler_metrics</span><span class=p>:</span><span class=w> </span><span class=n>SchedulerMetrics</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>pub</span><span class=p>(</span><span class=n>super</span><span class=p>)</span><span class=w> </span><span class=n>worker_metrics</span><span class=p>:</span><span class=w> </span><span class=n>Box</span><span class=o>&lt;</span><span class=p>[</span><span class=n>WorkerMetrics</span><span class=p>]</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>Only</span><span class=w> </span><span class=n>held</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>trigger</span><span class=w> </span><span class=n>some</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=k>drop</span><span class=p>.</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>used</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>get</span><span class=w> </span><span class=n>internal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>runtime</span><span class=w> </span><span class=n>metrics</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=n>can</span><span class=w> </span><span class=n>be</span><span class=w> </span><span class=n>useful</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=n>doing</span><span class=w> </span><span class=n>performance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>investigations</span><span class=p>.</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=n>does</span><span class=w> </span><span class=nf>nothing</span><span class=w> </span><span class=p>(</span><span class=n>empty</span><span class=w> </span><span class=n>struct</span><span class=p>,</span><span class=w> </span><span class=n>no</span><span class=w> </span><span class=k>drop</span><span class=w> </span><span class=n>impl</span><span class=p>)</span><span class=w> </span><span class=n>unless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>///</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>tokio_internal_mt_counters</span><span class=o>`</span><span class=w> </span><span class=o>`</span><span class=n>cfg</span><span class=o>`</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=kt>set</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>_counters</span><span class=p>:</span><span class=w> </span><span class=n>Counters</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>fn</span><span class=w> </span><span class=nf>next_remote_task</span><span class=p>(</span><span class=o>&amp;</span><span class=n>self</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>Option</span><span class=o>&lt;</span><span class=n>Notified</span><span class=o>&gt;</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=n>shared</span><span class=p>.</span><span class=n>inject</span><span class=p>.</span><span class=nf>is_empty</span><span class=p>()</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>None</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>let</span><span class=w> </span><span class=n>mut</span><span class=w> </span><span class=n>synced</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=n>shared</span><span class=p>.</span><span class=n>synced</span><span class=p>.</span><span class=k>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>//</span><span class=w> </span><span class=n>safety</span><span class=p>:</span><span class=w> </span><span class=n>passing</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>correct</span><span class=w> </span><span class=o>`</span><span class=n>idle</span><span class=p>::</span><span class=n>Synced</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>unsafe</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=n>self</span><span class=p>.</span><span class=n>shared</span><span class=p>.</span><span class=n>inject</span><span class=p>.</span><span class=nf>pop</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mut</span><span class=w> </span><span class=n>synced</span><span class=p>.</span><span class=n>inject</span><span class=p>)</span><span class=w> </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span></code></pre></div><a class=anchor id=mio></a><h1>MIO <a href=#mio aria-hidden=true>#</a></h1><p>Rust 一个轻量级异步 IO 库，对不同操作系统的底层 API 封装，例如 Linux 采用 <code>epoll</code>，Windows 采用 <code>IOCP</code>，OSX 下为 <code>kqueue</code> 等。实现采用与 <code>epoll</code> 类似的 Readiness 机制，所以大部分的接口能做到一一映射，而 <code>IOCP</code> 基于 Completion 有很多适配代码。</p><p>如下是简单示例，注意，需要开启 <code>features=["os-poll", "net"]</code> 才可以。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>log</span>::<span class=n>info</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>mio</span>::<span class=n>net</span>::<span class=n>TcpListener</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>mio</span>::<span class=p>{</span><span class=n>Events</span><span class=p>,</span><span class=w> </span><span class=n>Interest</span><span class=p>,</span><span class=w> </span><span class=n>Poll</span><span class=p>,</span><span class=w> </span><span class=n>Token</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>env_logger</span>::<span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=no>SERVER</span>: <span class=nc>Token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Token</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w> </span><span class=c1>// to identify which event.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>poll</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Poll</span>::<span class=n>new</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Events</span>::<span class=n>with_capacity</span><span class=p>(</span><span class=mi>128</span><span class=p>);</span><span class=w> </span><span class=c1>// storage for events.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;127.0.0.1:9090&#34;</span><span class=p>.</span><span class=n>parse</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TcpListener</span>::<span class=n>bind</span><span class=p>(</span><span class=n>addr</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>poll</span><span class=p>.</span><span class=n>registry</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>register</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>server</span><span class=p>,</span><span class=w> </span><span class=no>SERVER</span><span class=p>,</span><span class=w> </span><span class=n>Interest</span>::<span class=no>READABLE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>info!</span><span class=p>(</span><span class=s>&#34;Listening {}.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>poll</span><span class=p>.</span><span class=n>poll</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>events</span><span class=p>,</span><span class=w> </span><span class=nb>None</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w> </span><span class=c1>// blocking until we got an event.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>events</span><span class=p>.</span><span class=n>iter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>match</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=n>token</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=no>SERVER</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>let</span><span class=w> </span><span class=p>(</span><span class=n>conn</span><span class=p>,</span><span class=w> </span><span class=n>peer</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>server</span><span class=p>.</span><span class=n>accept</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=fm>info!</span><span class=p>(</span><span class=s>&#34;Got new connection {}.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>peer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nb>drop</span><span class=p>(</span><span class=n>conn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>unreachable!</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><a class=anchor id=其它></a><h1>其它 <a href=#%e5%85%b6%e5%ae%83 aria-hidden=true>#</a></h1><p>在 <code>4165601b</code> 提交中引入了新的 multi-threaded runtime 实现，可以有效提升调度效率，不过在超过 16 核之后，由于 mutex 会引入比较大的性能下降，所以当前仅作为测试版本，详见 <code>tokio/src/runtime/scheduler/multi_thread_alt</code> 中的实现。</p><a class=anchor id=参考></a><h1>参考 <a href=#%e5%8f%82%e8%80%83 aria-hidden=true>#</a></h1><ul><li><a href=https://tokio.rs/blog/2019-10-scheduler>Making the Tokio scheduler 10x faster</a> 官方关于内部调度器的优化介绍。</li><li><a href=https://hegdenu.net/posts/task-scheduled-time-in-console/>Task Scheduled Time in Console</a> 一个不错的 Tokio 调度监控实现。</li></ul></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#runtime>Runtime</a><ul><li><a href=#spawn>Spawn</a></li><li><a href=#parkunpark>Park/Unpark</a></li></ul></li><li><a href=#future>Future</a><ul><li><a href=#leaffuture>LeafFuture</a></li><li><a href=#io>IO</a></li><li><a href=#sleep>Sleep</a></li></ul></li><li><a href=#调用队列>调用队列</a></li><li><a href=#源码解析>源码解析</a><ul><li><a href=#task>Task</a></li></ul></li><li><a href=#mio>MIO</a></li><li><a href=#其它>其它</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>