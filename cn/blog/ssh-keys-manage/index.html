<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>SSH 密钥管理 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="服务端会保存自己的公私钥，客户端每次链接时会确认是否为上次记录主机。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>SSH 密钥管理</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2016-07-26</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/linux/ role=button>linux</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/security/ role=button>security</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/ssh/ role=button>ssh</a></div></div><hr><div class=content><p>服务端会保存自己的公私钥，客户端每次链接时会确认是否为上次记录主机。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p>通过 SSH 远程链接到新的主机时，会有如下的提示</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ssh 127.0.0.1
</span></span><span class=line><span class=cl>The authenticity of host &#39;127.0.0.1 (127.0.0.1)&#39; can&#39;t be established.
</span></span><span class=line><span class=cl>ECDSA key fingerprint is SHA256:QUfCwW6Br5EwwESsulN2TEidBoDNca888RNflZG++bI.
</span></span><span class=line><span class=cl>Are you sure you want to continue connecting (yes/no)? yes
</span></span></code></pre></div><p>当输入 <code>yes</code> 确认之后，会将服务端的公钥添加到 <code>~/.ssh/known_hosts</code> 文件里，此外，系统也有一个这样的文件，通常为 <code>/etc/ssh/ssh_known_hosts</code> 保存一些对所有用户都可信赖的远程主机的公钥。</p><a class=anchor id=中间人攻击></a><h2>中间人攻击 <a href=#%e4%b8%ad%e9%97%b4%e4%ba%ba%e6%94%bb%e5%87%bb aria-hidden=true>#</a></h2><p>登陆时的整个过程如下：1) 远程主机收到用户的登录请求，把自己的公钥发给用户；2) 用户使用这个公钥，将登录密码加密后，发送回来；3) 远程主机用自己的私钥，解密登录密码，如果密码正确，就同意用户登录。</p><p>实际上在真正实施时会存在中间人攻击 (Man-in-the-middle Attack)，简单来说：如果有人截获了登录请求，然后冒充远程主机，将伪造的公钥发给用户，因为 SSH 中的公钥没有类似 HTTPS 的证书中心，就无法判断公钥的合法性，这样攻击者就可能会获取到用户的密码。</p><a class=anchor id=ssh解决方案></a><h2>SSH解决方案 <a href=#ssh%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 aria-hidden=true>#</a></h2><p>关键就是，如何对 Server 的公钥进行认证，在 HTTPS 中是通过证书认证，而 SSH 的公私钥都是自己生成的，每个客户端只能自己确认。也就是说，对于主机合法性的判断完全交给了用户，所以，首次登录就会出现如上的提示。</p><p>也就是说，ssh 客户端会将远端主机的公钥指纹打印出来，由用户自己判断是否要信任这个公钥或者主机。所谓的 &ldquo;公钥指纹&rdquo; 实际上，实际上是对公钥的 MD5 或者 SHA256 值。</p><p>那么，用户如何知道远程主机的公钥指纹应该是多少？SSH 没有给出具体的方案，一般远程主机可以在自己的网站上贴出公钥指纹，以便用户自行核对，也可以自己集中管理。</p><p>假设用户经过风险衡量后，决定接受这个远程主机公钥，那么会再次提示如下内容，表示 host 主机已经得到认可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Warning: Permanently added &#39;host,12.18.429.21&#39; (RSA) to the list of known hosts.
</span></span></code></pre></div><p>然后，会要求输入登录密码，在密码验证通过后，远程主机的公钥会被保存在文件 <code>$HOME/.ssh/known_hosts</code> 之中，下次系统就会认出它的公钥已经保存在本地了，从而跳过警告部分，直接提示输入密码。</p><a class=anchor id=配置></a><h1>配置 <a href=#%e9%85%8d%e7%bd%ae aria-hidden=true>#</a></h1><p>使用时 OpenSSH 默认会创建证书信息，包括了服务端和客户端。</p><a class=anchor id=服务端></a><h2>服务端 <a href=#%e6%9c%8d%e5%8a%a1%e7%ab%af aria-hidden=true>#</a></h2><p>在交互过程中，会采用非对称加密完成，例如 RSA、DSA、ECDSA 等算法，其中公钥会分发给各个客户端，而私钥会保存在服务端，通常不建议共享。</p><p>对于 OpenSSH 来说，会保存在 <code>/etc/ssh</code> 目录下，一般为 <code>ssh_host_&lt;rsa/dsa/ecdsa>_key</code> (路径可以在配置文件中进行修改) ，通常是在服务启动的时候自动生成，也可以通过 <code>ssh-keygen</code> 手动生成。</p><p>当客户端连接到服务器之后，会将服务端的 Key 保存为 Known Host ，一般保存在 <code>/etc/ssh/known_hosts</code> 以及 <code>~/.ssh/known_hosts</code> 文件中。</p><p>默认 Host Key 只有 root 用户可读，但是，如果有人获取到了 Host Key ，那么就可以发起中间人攻击，为此，有些 SSH 服务提供了配置中心，用于集中管理。</p><a class=anchor id=客户端></a><h2>客户端 <a href=#%e5%ae%a2%e6%88%b7%e7%ab%af aria-hidden=true>#</a></h2><p>如上，已经经过验证的服务端信息会保存在 <code>~/.ssh/known_hosts</code> 文件中，默认会生成类似如下内容的信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>127.0.0.1 ecdsa-sha2-nistp256 AAAA....=
</span></span></code></pre></div><p>包括了主机、相关算法以及主机公钥信息，如果开启了 <code>HashKnownHosts yes</code> 配置，就可以看到有如下内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>|1|c2UrTftB8P0W1m+YyxnTYo+Th0M=|tw98264YL5dxT7v6EiEXfcTlUc8= ecdsa-sha2-nistp256 AAAA....=
</span></span></code></pre></div><p>主机名以哈希加密形式存储，这样可以隐藏主机名称和IP地址对外暴露， 哈希过的主机名以 <code>|</code> 字符开头，每一单行上只能允许一个哈希主机名出现。</p><a class=anchor id=常用命令></a><h1>常用命令 <a href=#%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4 aria-hidden=true>#</a></h1><p>通过 <code>ssh-keyscan</code> 命令可以获取服务器公钥，一般会根据不同的加密方法有多个密钥。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 如果不指定类型会打印所有服务端支持类型，类型有ecdsa、rsa、ed25519
</span></span><span class=line><span class=cl>$ ssh-keyscan -t ecdsa -p 22 127.0.0.1
</span></span><span class=line><span class=cl>$ ssh-keyscan -t ecdsa -p 22 127.0.0.1 2&gt;/dev/null | ssh-keygen -E sha256 -lf -
</span></span></code></pre></div><p>对于 <code>ssh-keygen</code> 命令，除了可以生成公私钥之外，还可以通过 <code>-l</code> 查看，并通过 <code>-E</code> 指定类型参数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ssh-keygen -t rsa -f ~/.ssh/id_rsa -N &#34;&#34; -C &#34;foobar@kidding.com&#34;
</span></span><span class=line><span class=cl>参数：
</span></span><span class=line><span class=cl>    -t:   加密类型
</span></span><span class=line><span class=cl>    -f:   指定输出文件
</span></span><span class=line><span class=cl>    -N:   通过该密码加密私钥，为空则会自动登陆
</span></span><span class=line><span class=cl>    -C:   注释，通常为邮箱名称，会保存在公钥中
</span></span></code></pre></div><p>查看本地保存公钥的 SHA256 签名，也可以通过 <code>-E md5</code> 查看对应的 MD5 值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ ssh-keygen -E sha256 -lf ~/.ssh/known_hosts
</span></span><span class=line><span class=cl>$ ssh-keygen -E sha256 -lf /etc/ssh/ssh_host_ecdsa_key.pub
</span></span></code></pre></div><a class=anchor id=常见问题></a><h1>常见问题 <a href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98 aria-hidden=true>#</a></h1><a class=anchor id=登陆禁止></a><h2>登陆禁止 <a href=#%e7%99%bb%e9%99%86%e7%a6%81%e6%ad%a2 aria-hidden=true>#</a></h2><p>有时候需要 SSH 登陆到别的 Linux 主机上去时，可能会弹出如下类似提示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span class=line><span class=cl>WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!
</span></span><span class=line><span class=cl>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span class=line><span class=cl>IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
</span></span><span class=line><span class=cl>... ...
</span></span><span class=line><span class=cl>Host key verification failed.
</span></span></code></pre></div><p>在客户端第一次使用 SSH 连接时，会把访问过的计算机公钥记录在 <code>~/.ssh/known_hosts</code> 文件中，下次访问时，OpenSSH 会核对公钥，如果公钥不同，则会发出警告，避免受到 DNS Hijack 之类的攻击。</p><p>可以通过 <code>ssh-keygen -l -f ~/.ssh/known_hosts</code> 命令查看，但是如果主机重装或者重新生成了公钥，那么就会出现如上的报错，可以通过如下方式解决：</p><ul><li>通过 <code>ssh-keygen -f "~/.ssh/known_hosts -R HOST:PORT</code> 手动删除修改 <code>known_hosts</code> 里相应的记录；</li><li>修改配置文件 <code>~/.ssh/config</code> 添加 <code>StrictHostKeyChecking no</code> 和 <code>UserKnownHostsFile /dev/null</code> 即可。</li></ul><p>注意第二种安全性比较低。</p></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#中间人攻击>中间人攻击</a></li><li><a href=#ssh解决方案>SSH解决方案</a></li></ul></li><li><a href=#配置>配置</a><ul><li><a href=#服务端>服务端</a></li><li><a href=#客户端>客户端</a></li></ul></li><li><a href=#常用命令>常用命令</a></li><li><a href=#常见问题>常见问题</a><ul><li><a href=#登陆禁止>登陆禁止</a></li></ul></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>