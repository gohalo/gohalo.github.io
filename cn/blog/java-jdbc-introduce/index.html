<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Java JDBC 驱动介绍 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="JDBC (Java Datebase Connectivity) 实际是一个独立于特定数据库管理系统、通用的 SQL 数据库存取和操作的公共接口，它是 JAVA 访问数据库的一种标准。也就是说它只是接口规范，具体实现是各数据库厂商提供的驱动程序。
接下来，先看看 JDBC 的使用方法，然后看看其具体的实现原理。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>Java JDBC 驱动介绍</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2015-10-19</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/language/ role=button>language</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/java/ role=button>java</a></div></div><hr><div class=content><p>JDBC (Java Datebase Connectivity) 实际是一个独立于特定数据库管理系统、通用的 SQL 数据库存取和操作的公共接口，它是 JAVA 访问数据库的一种标准。也就是说它只是接口规范，具体实现是各数据库厂商提供的驱动程序。</p><p>接下来，先看看 JDBC 的使用方法，然后看看其具体的实现原理。</p><a class=anchor id=简介></a><h1>简介 <a href=#%e7%ae%80%e4%bb%8b aria-hidden=true>#</a></h1><p>JDBC 作为 JAVA 的接口规范，为上层提供了统一的接口。</p><p>对于 Java 中的持久化方案，可以通过 JDBC 直接访问数据库，封装接口，或者直接使用第三方 O/R (Object Relational Mapping，对象关系映射) 工具，如 Hibernate、mybatis；这些工具都是对 JDBC 的封装。</p><p>在 JDBC 中常用的接口有：</p><ul><li>Java.sql.Driver 接口<br>JDBC 驱动程序需要实现的接口，供数据库厂商使用，不同数据库提供不用的实现；应用程序通过驱动程序管理器类 (java.sql.DriverManager) 去调用这些 Driver 实现。</li><li>DriverManager类<br>用来创建连接，它本身就是一个创建Connection的工厂，设计的时候使用的就是Factory模式，给各数据库厂商提供接口，各数据库厂商需要实现它； Connection接口，根据提供的不同驱动产生不同的连接； Statement 接口，用来发送SQL语句；</li><li>Resultset 接口<br>用来接收查询语句返回的查询结果。</li></ul><p>接下来简单介绍 JDBC 的使用方法。</p><a class=anchor id=简单使用-jdbc-接口></a><h2>简单使用 JDBC 接口 <a href=#%e7%ae%80%e5%8d%95%e4%bd%bf%e7%94%a8-jdbc-%e6%8e%a5%e5%8f%a3 aria-hidden=true>#</a></h2><p>JDBC 使用步骤大致包括了：A) 注册加载一个驱动；B) 创建数据库连接；C) 创建 statement，发送 SQL 语句；D) 执行 SQL 语句；E) 处理返回的结果；F) 关闭 statement 和 connection 。</p><a class=anchor id=1-加载与注册驱动></a><h4>1. 加载与注册驱动 <a href=#1-%e5%8a%a0%e8%bd%bd%e4%b8%8e%e6%b3%a8%e5%86%8c%e9%a9%b1%e5%8a%a8 aria-hidden=true>#</a></h4><p>通过调用 Class 类的静态方法 forName()，向其传递要加载的 JDBC 驱动的类名。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Class.forName(&#34;com.mysql.jdbc.Driver&#34;);             // 注册MYSQL数据库驱动器
</span></span><span class=line><span class=cl>Class.forName(&#34;oracle.jdbc.driver.OracleDriver&#34;);   // 注册ORACLE数据库驱动器
</span></span></code></pre></div><a class=anchor id=2-建立连接></a><h4>2. 建立连接 <a href=#2-%e5%bb%ba%e7%ab%8b%e8%bf%9e%e6%8e%a5 aria-hidden=true>#</a></h4><p>通过调用 DriverManager 类的 getConnection() 方法建立到数据库的连接。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Connection conn = DriverManager.getConnection(url, uid, pwd);
</span></span></code></pre></div><p>其中，JDBC URL 用于标识一个被注册的驱动程序，驱动程序管理器通过这个 URL 选择正确的驱动，从而建立到数据库的连接。</p><p>JDBC URL 的标准由三部分组成，各部分间用冒号 <code>":"</code> 分隔，格式为 <code>协议:(子协议):(子名称)</code>；其中，JDBC URL 中的协议总是 jdbc；子协议用于标识一个数据库驱动程序；子名称是一种标识数据库的方法，子名称根据不同的子协议而变化，用子名称的目的是为了定位数据库提供足够的信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>URL: jdbc:mysql://localhost:3306/mydbname           // MySQL的JDBC
</span></span><span class=line><span class=cl>URL: jdbc:oracle:thin:@localhost:1521:mydbname      // Oracle的JDBC
</span></span></code></pre></div><p>注：上述的 URL 标示的方法是一个 Java Native Interface, JNI 方式的命名，允许 Java 代码和其它语言进行交互。</p><a class=anchor id=3-访问数据库></a><h4>3. 访问数据库 <a href=#3-%e8%ae%bf%e9%97%ae%e6%95%b0%e6%8d%ae%e5%ba%93 aria-hidden=true>#</a></h4><p>数据库连接用于向服务器发送命令以及 SQL 语句，在 java.sql 包中有 3 个接口分别定义了对数据库的调用的不同方式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*--- Statement 对象用于执行静态的SQL语句，并且返回执行结果 */</span>
</span></span><span class=line><span class=cl><span class=n>Statement</span> <span class=n>sm</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=na>createStatement</span><span class=o>();</span>                 <span class=c1>// 创建该对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sm</span><span class=o>.</span><span class=na>executeQuery</span><span class=o>(</span><span class=n>sql</span><span class=o>);</span>                                  <span class=c1>// 数据查询语句select
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sm</span><span class=o>.</span><span class=na>executeUpdate</span><span class=o>(</span><span class=n>sql</span><span class=o>);</span>                                 <span class=c1>// 数据更新语句delete、update、insert、drop等
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/*--- PreparedStatement 接口是Statement的子接口，它表示一条预编译过的SQL语句
</span></span></span><span class=line><span class=cl><span class=cm> * 该对象所代表的SQL语句中的参数用问号表示，并调用PreparedStatement对象的setXXX()方法来设置这些参数
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>sql</span> <span class=o>=</span> <span class=s>&#34;INSERT INTO user (id,name) VALUES (?,?)&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>PreparedStatement</span> <span class=n>ps</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=na>prepareStatement</span><span class=o>(</span><span class=n>sql</span><span class=o>);</span>     <span class=c1>// 创建对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ps</span><span class=o>.</span><span class=na>setInt</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=mi>1</span><span class=o>);</span>                                       <span class=c1>// 设置参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ps</span><span class=o>.</span><span class=na>setString</span><span class=o>(</span><span class=mi>2</span><span class=o>,</span> <span class=s>&#34;admin&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ResultSet</span> <span class=n>rs</span> <span class=o>=</span> <span class=n>ps</span><span class=o>.</span><span class=na>executeQuery</span><span class=o>();</span>                      <span class=c1>// 查询操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=n>ps</span><span class=o>.</span><span class=na>executeUpdate</span><span class=o>();</span>                            <span class=c1>// 更新操作
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*--- Callable Statement 当不直接使用 SQL 语句，而是调用数据库中的存储过程时，要用到该接口
</span></span></span><span class=line><span class=cl><span class=cm> * 其中 CallabelStatement 是从 PreparedStatement 继承
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>sql</span> <span class=o>=</span> <span class=s>&#34;{call insert_users(?,?)}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>CallableStatement</span> <span class=n>st</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=na>prepareCall</span><span class=o>(</span><span class=n>sql</span><span class=o>);</span>          <span class=c1>// 调用存储过程
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>st</span><span class=o>.</span><span class=na>setInt</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=mi>1</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>st</span><span class=o>.</span><span class=na>setString</span><span class=o>(</span><span class=mi>2</span><span class=o>,</span> <span class=s>&#34;admin&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>st</span><span class=o>.</span><span class=na>execute</span><span class=o>();</span>                                          <span class=c1>// 执行SQL语句，可以是任何类型的SQL
</span></span></span></code></pre></div><p>代码中建议使用 PreparedStatement，而非 Statement；相比来说，前者的代码可读性和可维护性较高，可以提高 SQL 执行性能，更加安全（如防止 sql 注入）。</p><p>SQL 注入是利用某些系统没有对用户输入的数据进行充分的检查，而在用户输入数据中注入非法的 SQL 语句段或命令，从而利用系统的 SQL 引擎完成恶意行为的做法。</p><a class=anchor id=4-处理执行结果></a><h4>4. 处理执行结果 <a href=#4-%e5%a4%84%e7%90%86%e6%89%a7%e8%a1%8c%e7%bb%93%e6%9e%9c aria-hidden=true>#</a></h4><p>查询语句，返回记录集 ResultSet；更新语句，返回数字，表示该更新影响的记录数。该对象以逻辑表格的形式封装了查询操作的结果集，相关接口由数据库驱动实现。</p><p>ResultSet 接口的常用方法：通过 <code>next()</code> 将游标往后移动一行，成功返回true，该对象维护了一个指向当前数据行的游标，初始的时候，游标在第一行之前，可以通过 ResultSet 对象的 <code>next()</code> 方法移动到下一行。</p><p><code>getXXX(String name)</code>：返回当前游标下某个字段的值，如：<code>getInt("id")</code> 或 <code>getSting("name")</code>。</p><a class=anchor id=5-释放数据库连接></a><h4>5. 释放数据库连接 <a href=#5-%e9%87%8a%e6%94%be%e6%95%b0%e6%8d%ae%e5%ba%93%e8%bf%9e%e6%8e%a5 aria-hidden=true>#</a></h4><p>一般是在 finally 语句里面进行释放资源。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rs.close();                                            // 关闭结果集
</span></span><span class=line><span class=cl>ps.close(); / st.close(); / sm.close();                // 相应地接口
</span></span><span class=line><span class=cl>conn.close();                                          // 关闭链接
</span></span></code></pre></div><p>下图是使用 JDBC 的通用流程。</p><p><img alt=JDBC的基本调用流程 src=images/jdbc_basic_cycle.png class="mx-auto d-block"></p><p>相关的示例可以参考如下代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// javac GetConnection.java
</span></span></span><span class=line><span class=cl><span class=c1>// java -classpath .:/usr/share/java/mysql-connector-java.jar GetConnection
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.sql.*</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.text.SimpleDateFormat</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>GetConnection</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>){</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用Class.forName()方法加载驱动程序
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=s>&#34;com.mysql.jdbc.Driver&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;成功加载MySQL驱动！&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span><span class=k>catch</span><span class=o>(</span><span class=n>ClassNotFoundException</span> <span class=n>e1</span><span class=o>){</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;找不到MySQL驱动!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>e1</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>url</span><span class=o>=</span><span class=s>&#34;jdbc:mysql://localhost:3306/mysql&#34;</span><span class=o>;</span>    <span class=c1>// JDBC的URL
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 调用DriverManager对象的getConnection()方法，获得一个Connection对象
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Connection</span> <span class=n>conn</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span> <span class=o>=</span> <span class=n>DriverManager</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=n>url</span><span class=o>,</span><span class=s>&#34;root&#34;</span><span class=o>,</span><span class=s>&#34;password&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Statement</span> <span class=n>stmt</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=na>createStatement</span><span class=o>();</span> <span class=c1>// 创建Statement对象
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;成功连接到数据库！&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ResultSet</span> <span class=n>rs</span> <span class=o>=</span> <span class=n>stmt</span><span class=o>.</span><span class=na>executeQuery</span><span class=o>(</span><span class=s>&#34;select now() now&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span><span class=o>(</span><span class=n>rs</span><span class=o>.</span><span class=na>next</span><span class=o>()){</span>
</span></span><span class=line><span class=cl>                <span class=c1>//Retrieve by column name
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>java</span><span class=o>.</span><span class=na>sql</span><span class=o>.</span><span class=na>Timestamp</span> <span class=n>time</span> <span class=o>=</span> <span class=n>rs</span><span class=o>.</span><span class=na>getTimestamp</span><span class=o>(</span><span class=s>&#34;now&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>SimpleDateFormat</span> <span class=n>sdf</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SimpleDateFormat</span><span class=o>(</span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>String</span> <span class=n>str</span> <span class=o>=</span> <span class=n>sdf</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=n>time</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;NOW: &#34;</span> <span class=o>+</span> <span class=n>str</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;释放相关资源！&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>rs</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>stmt</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SQLException</span> <span class=n>e</span><span class=o>){</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>如果还没有安装 JDBC 可以通过如下的方式安装。</p><p>在 CentOS 中可以通过 <code>yum install mysql-connector-java</code> 命令安装 JDBC 驱动，此时，默认会保存在 <code>/usr/share/java/mysql-connector-java.jar</code> ，使用这个包需要包含全路径，可以设置 <code>CLASSPATH</code> 环境变量，或者在运行时通过 <code>-classpath</code> 指定：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ javac GetConnection
</span></span><span class=line><span class=cl>$ java -classpath .:/usr/share/java/mysql-connector-java.jar GetConnection
</span></span></code></pre></div><p>在 Eclipse 中可通过 <code>[右健] -> Properties -> Java Build Path -> Libraries -> Add External JARs</code> 。</p><p>当然，也可以从 <a href=http://www.mysql.com/products/connector/>MySQL官网</a> 下载不同的 MySQL Connectors 版本。</p><a class=anchor id=批量处理></a><h2>批量处理 <a href=#%e6%89%b9%e9%87%8f%e5%a4%84%e7%90%86 aria-hidden=true>#</a></h2><p>需要批量插入或者更新记录时，可以采用 Java 的批量更新机制，这一机制允许多条语句一次性提交给数据库批量处理，通常比单独提交处理更有效率。有如下两种方式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/*--- Statement批量处理 */</span>
</span></span><span class=line><span class=cl><span class=n>stmt</span><span class=o>.</span><span class=na>addBatch</span><span class=o>(</span><span class=s>&#34;insert into test value(1, &#39;foobar&#39;)&#34;</span><span class=o>);</span> <span class=c1>// 添加需要批量处理的SQL语句或是参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>stmt</span><span class=o>.</span><span class=na>addBatch</span><span class=o>(</span><span class=s>&#34;insert into test value(2, &#39;oooops&#39;)&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>stmt</span><span class=o>.</span><span class=na>addBatch</span><span class=o>(</span><span class=s>&#34;select * from test&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>stmt</span><span class=o>.</span><span class=na>executeBatch</span><span class=o>();</span>                                  <span class=c1>// 执行批量处理语句，返回影响行数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>stmt</span><span class=o>.</span><span class=na>clearBatch</span><span class=o>();</span>                                    <span class=c1>// 清除stmt中积攒的参数列表
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/*--- PreparedStatement批量传参 */</span>
</span></span><span class=line><span class=cl><span class=n>PreparedStatement</span> <span class=n>ps</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=na>preparedStatement</span><span class=o>(</span><span class=n>sql</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=o>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=o>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=mi>100000</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ps</span><span class=o>.</span><span class=na>setInt</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ps</span><span class=o>.</span><span class=na>setString</span><span class=o>(</span><span class=mi>2</span><span class=o>,</span> <span class=s>&#34;name&#34;</span><span class=o>+</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ps</span><span class=o>.</span><span class=na>setString</span><span class=o>(</span><span class=mi>3</span><span class=o>,</span> <span class=s>&#34;email&#34;</span><span class=o>+</span><span class=n>i</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ps</span><span class=o>.</span><span class=na>addBatch</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=o>((</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=o>)%</span><span class=mi>1000</span><span class=o>==</span><span class=mi>0</span><span class=o>){</span>
</span></span><span class=line><span class=cl>        <span class=n>ps</span><span class=o>.</span><span class=na>executeBatch</span><span class=o>();</span>   <span class=c1>// 批量处理
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ps</span><span class=o>.</span><span class=na>clearBatch</span><span class=o>();</span>     <span class=c1>// 清空ps中积攒的sql
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>通常会遇到两种批量执行 SQL 的情况：多条 SQL 语句批量处理；一个 SQL 语句的批量传参。实际上，上述的执行过程仍然是串行的，也就是说当第一条执行完成后，才会执行下一条，可以执行不同类型的 DML。批量执行的 SQL 最终接口为 <code>executeBatchInternal()@PreparedStatement.class</code> 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span> <span class=kt>long</span><span class=o>[]</span> <span class=nf>executeBatchInternal</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>batchHasPlainStatements</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=o>.</span><span class=na>connection</span><span class=o>.</span><span class=na>getRewriteBatchedStatements</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>canRewriteAsMultiValueInsertAtSqlLevel</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>executeBatchedInserts</span><span class=o>(</span><span class=n>batchTimeout</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>connection</span><span class=o>.</span><span class=na>versionMeetsMinimum</span><span class=o>(</span><span class=mi>4</span><span class=o>,</span> <span class=mi>1</span><span class=o>,</span> <span class=mi>0</span><span class=o>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=k>this</span><span class=o>.</span><span class=na>batchHasPlainStatements</span>
</span></span><span class=line><span class=cl>                 <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=o>.</span><span class=na>batchedArgs</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>                 <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=o>.</span><span class=na>batchedArgs</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>&gt;</span> <span class=mi>3</span> <span class=cm>/* cost of option setting rt-wise */</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>executePreparedBatchAsMultiStatement</span><span class=o>(</span><span class=n>batchTimeout</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>executeBatchSerially</span><span class=o>(</span><span class=n>batchTimeout</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>statementExecuting</span><span class=o>.</span><span class=na>set</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>clearBatch</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>如上所述，JDBC 驱动默认情况下会无视 <code>executeBatch()</code> 语句，把期望批量执行的一组 SQL 语句拆散，一条一条地发给 MySQL 数据库，直接造成较低的性能。</p><p>而且在没有设置 autocommit 时，也是每条 SQL 提交一次。</p><p>只有把 <code>rewriteBatchedStatements</code> 参数置为 <code>true</code>，驱动才会帮你批量执行 SQL 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>jdbc:mysql://ip:port/db?rewriteBatchedStatements=true
</span></span></code></pre></div><p><code>rewriteBatchedStatements</code> 对于 <code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code> 都有效，只不过对 <code>INSERT</code> 会预先重排一下 SQL 语句。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>batchDelete(10条): 一次请求，内容: &#34;delete from t where id = 1; delete from t where id = 2; ......&#34;
</span></span><span class=line><span class=cl>batchUpdate(10条): 一次请求，内容: &#34;update t set ... where id = 1; update t set ... where id = 2; ......&#34;
</span></span><span class=line><span class=cl>batchInsert(10条): 一次请求，内容: &#34;insert into t(...) values(...), (...), ...&#34;
</span></span></code></pre></div><p>需要注意的是，即使 <code>rewriteBatchedStatements=true</code>，<code>batchDelete()</code> 和 <code>batchUpdate()</code> 也不一定会走批量。当 <code>batchSize&lt;=3</code> 时，驱动会宁愿一条一条地执行 SQL 。</p><p>其它的操作如执行事务、获取元数据、批量执行等操作，以后再补充。</p><a class=anchor id=源码解析></a><h1>源码解析 <a href=#%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90 aria-hidden=true>#</a></h1><p>如上，JDBC 提供了一个统一的接口，对于不同的驱动，除了加载驱动以及建立链接时的 URL 不同只外，其它的操作基本相同。</p><p>除了需要 JDBC 的源码之外，还需要 openjdk 的源码。</p><p><img alt=JDBC框架整体架构 src=images/jdbc_structure.png class="mx-auto d-block"></p><p>DriverManager 类，实际是在 rt.jar 包中，而其源码在 openjdk 中，对应 <code>DriverManager.java</code> 。</p><a class=anchor id=注册加载></a><h2>注册加载 <a href=#%e6%b3%a8%e5%86%8c%e5%8a%a0%e8%bd%bd aria-hidden=true>#</a></h2><p>应用程序首先通过如下程序加载驱动器。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=s>&#34;com.mysql.jdbc.Driver&#34;</span><span class=o>);</span>
</span></span></code></pre></div><p>首先介绍一下什么是 <code>Class.forName()</code> 。</p><a class=anchor id=classforname></a><h4>Class.forName() <a href=#classforname aria-hidden=true>#</a></h4><p>简单来说 <code>Class.forName(xxx.xx)</code> 就是要求 JVM 查找并加载指定的类，在加载的同时会执行该类的静态代码段，其返回值是一个类。</p><p>而 <code>newInstance()</code> 就是根据类初始化一个实例，也就是说如下的两种方式，其效果是一样的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>A</span> <span class=n>a</span> <span class=o>=</span> <span class=o>(</span><span class=n>A</span><span class=o>)</span><span class=n>Class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=s>&#34;package.A&#34;</span><span class=o>).</span><span class=na>newInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>A</span> <span class=n>a</span> <span class=o>=</span> <span class=k>new</span> <span class=n>A</span><span class=o>();</span>
</span></span></code></pre></div><p><code>Class.forName().newInstance()</code> 和 <code>new()</code> 区别是：A) 前者是一个方法，后者是一个关键字；B) 前者生成对象只能调用无参的构造函数，而后者没有限制。</p><p>使用 <code>Class.forName()</code> 的目的是为了动态加载类，如需要实例化对象，还需要调用 <code>newInstance()</code> 。而实际上，在我们的示例中，并没有调用 <code>newInstance()</code>，Why？？？</p><p>如上所述，JVM 要先加载 class，而静态代码是和 class 绑定的，class 装载成功就表示执行了你的静态代码了，而且以后的实例化等操作将不会再执行这段静态代码了。</p><p>实际上，JDBC 规范中明确要求这个 Driver 类必须向 DriverManager 注册自己，例如，对于 MySQL 来说，在 <code>src/com/mysql/jdbc/Driver.java</code> 中，实现了 <code>java.sql.Driver</code> 接口，在初始化时有如下操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Driver</span> <span class=kd>extends</span> <span class=n>NonRegisteringDriver</span> <span class=kd>implements</span> <span class=n>java</span><span class=o>.</span><span class=na>sql</span><span class=o>.</span><span class=na>Driver</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>static</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>java</span><span class=o>.</span><span class=na>sql</span><span class=o>.</span><span class=na>DriverManager</span><span class=o>.</span><span class=na>registerDriver</span><span class=o>(</span><span class=k>new</span> <span class=n>Driver</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SQLException</span> <span class=n>E</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=s>&#34;Can&#39;t register driver!&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=nf>Driver</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Required for Class.forName().newInstance()
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>也就是说，对于 JDBC 是否使用了 <code>newInstance()</code>，两者是一样的。</p><a class=anchor id=drivermanager></a><h2>DriverManager <a href=#drivermanager aria-hidden=true>#</a></h2><p>在继续讲解之前，可以看到，对应 DriverManager 类有一个静态匿名函数，也就是执行 <code>loadInitialDrivers()</code> 函数。</p><p>在 <code>jdk/src/share/classes/java/sql/DriverManager.java</code> 中，通过 <code>registeredDrivers.addIfAbsent()</code> 将新建的 DriverInfo 信息保存。</p><a class=anchor id=获取链接></a><h2>获取链接 <a href=#%e8%8e%b7%e5%8f%96%e9%93%be%e6%8e%a5 aria-hidden=true>#</a></h2><p>实际上获取链接有多个接口，其入参是不同的，通常会使用如下的接口。在该函数中，如果正常，则会返回一个链接，否则会返回 NULL 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Drivermanager</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=n>url</span><span class=o>,</span> <span class=n>name</span><span class=o>,</span> <span class=n>password</span><span class=o>);</span>
</span></span></code></pre></div><p>而对于所有的接口，最终会调用如下的私有函数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=n>Connection</span> <span class=nf>getConnection</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>url</span><span class=o>,</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>Properties</span> <span class=n>info</span><span class=o>,</span> <span class=n>Class</span> <span class=n>caller</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=o>(</span><span class=n>DriverInfo</span> <span class=n>aDriver</span> <span class=o>:</span> <span class=n>registeredDrivers</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>Connection</span> <span class=n>con</span> <span class=o>=</span> <span class=n>aDriver</span><span class=o>.</span><span class=na>driver</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=n>url</span><span class=o>,</span> <span class=n>info</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>也就是最终会调用 JDBC-MySQL Driver 的 <code>connect()</code> 函数。该函数先通过 <code>parseURL()</code> 解析 URL 中的信息，并保存在 Properties 中，该对象用于保存一些配置信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// ### 1  @src/com/mysql/jdbc/NonRegisteringDriver.java
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>public</span> <span class=n>java</span><span class=o>.</span><span class=na>sql</span><span class=o>.</span><span class=na>Connection</span> <span class=nf>connect</span><span class=o>(</span><span class=n>String</span> <span class=n>url</span><span class=o>,</span> <span class=n>Properties</span> <span class=n>info</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>                       <span class=c1>// 对传入的URL进行一些判断，如负载均衡等
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// parseURL函数声明：public Properties parseURL(String url, Properties defaults)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>((</span><span class=n>props</span> <span class=o>=</span> <span class=n>parseURL</span><span class=o>(</span><span class=n>url</span><span class=o>,</span> <span class=n>info</span><span class=o>))</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>                        <span class=c1>// 解析完参数后返回Properties对象，然后会初始化链接
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>Connection</span> <span class=n>newConn</span> <span class=o>=</span> <span class=n>com</span><span class=o>.</span><span class=na>mysql</span><span class=o>.</span><span class=na>jdbc</span><span class=o>.</span><span class=na>ConnectionImpl</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=n>host</span><span class=o>(</span><span class=n>props</span><span class=o>),</span> <span class=n>port</span><span class=o>(</span><span class=n>props</span><span class=o>),</span> <span class=n>props</span><span class=o>,</span> <span class=n>database</span><span class=o>(</span><span class=n>props</span><span class=o>),</span> <span class=n>url</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>newConn</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ### 2
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>protected</span> <span class=kd>static</span> <span class=n>Connection</span> <span class=nf>getInstance</span><span class=o>(...)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>Util</span><span class=o>.</span><span class=na>isJdbc4</span><span class=o>())</span> <span class=o>{</span>       <span class=c1>// 老接口
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=k>new</span> <span class=n>ConnectionImpl</span><span class=o>(</span><span class=n>hostToConnectTo</span><span class=o>,</span> <span class=n>portToConnectTo</span><span class=o>,</span> <span class=n>info</span><span class=o>,</span> <span class=n>databaseToConnectTo</span><span class=o>,</span> <span class=n>url</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>(</span><span class=n>Connection</span><span class=o>)</span> <span class=n>Util</span><span class=o>.</span><span class=na>handleNewInstance</span><span class=o>(</span><span class=n>JDBC_4_CONNECTION_CTOR</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>Object</span><span class=o>[]</span> <span class=o>{</span> <span class=n>hostToConnectTo</span><span class=o>,</span> <span class=n>Integer</span><span class=o>.</span><span class=na>valueOf</span><span class=o>(</span><span class=n>portToConnectTo</span><span class=o>),</span> <span class=n>info</span><span class=o>,</span> <span class=n>databaseToConnectTo</span><span class=o>,</span> <span class=n>url</span> <span class=o>},</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>而 <code>Util.handleNewInstance()</code> 函数实际执行 <code>Class.forName("com.mysql.jdbc.JDBC4Connection").newInstance()</code> 。该函数会调用基类 <code>class ConnectionImpl</code> 的构造函数。</p><p>也就是说，对于 JDBC4 最终调用的仍然与老接口类似。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=nf>ConnectionImpl</span><span class=o>(...)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=o>.</span><span class=na>dbmd</span> <span class=o>=</span> <span class=n>getMetaData</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>    <span class=c1>// 获取数据库信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>initializeSafeStatementInterceptors</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>createNewIO</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>                       <span class=c1>// 创建远程IO链接
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>unSafeStatementInterceptors</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><a class=anchor id=socket的连接创建></a><h2>Socket的连接创建 <a href=#socket%e7%9a%84%e8%bf%9e%e6%8e%a5%e5%88%9b%e5%bb%ba aria-hidden=true>#</a></h2><p>连接创建是通过 <code>ConnectionImp::createNewIO()</code> 方法执行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>createNewIO</span><span class=o>(</span><span class=kt>boolean</span> <span class=n>isForReconnect</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>connectOneTryOnly</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>connectOneTryOnly</span><span class=o>(...)</span> <span class=kd>throws</span> <span class=n>SQLException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>coreConnect</span><span class=o>(</span><span class=n>mergedProps</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>private</span> <span class=kt>void</span> <span class=nf>coreConnect</span><span class=o>(</span><span class=n>Properties</span> <span class=n>mergedProps</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SQLException</span><span class=o>,</span> <span class=n>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=o>.</span><span class=na>io</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MysqlIO</span><span class=o>(...);</span>   <span class=c1>// MysqlIO的创建，用来于服务器进行通信
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>doHandshake</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>user</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>password</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>database</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nf>MysqlIO</span><span class=o>(...)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建得到一个socket
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>mysqlConnection</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>socketFactory</span><span class=o>.</span><span class=na>connect</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>host</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>port</span><span class=o>,</span> <span class=n>props</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建input流
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>connection</span><span class=o>.</span><span class=na>getUseReadAheadInput</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建output流
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=o>.</span><span class=na>mysqlOutput</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BufferedOutputStream</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>mysqlConnection</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>(),</span> <span class=mi>16384</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><a class=anchor id=执行sql></a><h2>执行SQL <a href=#%e6%89%a7%e8%a1%8csql aria-hidden=true>#</a></h2><p><code>createStatement()</code> 有三类接口，最终都会调用如下接口。其中前两个参数为：对返回的结果集进行指定相应的模式功能，可参照 ResultSet 的常量设置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public java.sql.Statement createStatement(...) throws SQLException {
</span></span><span class=line><span class=cl>    checkClosed();
</span></span><span class=line><span class=cl>    // getLoadBalanceSafeProxy() 为相应的连接
</span></span><span class=line><span class=cl>    StatementImpl stmt = new StatementImpl(getLoadBalanceSafeProxy(), this.database);
</span></span><span class=line><span class=cl>    stmt.setResultSetType(resultSetType);
</span></span><span class=line><span class=cl>    stmt.setResultSetConcurrency(resultSetConcurrency);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return stmt;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public java.sql.ResultSet executeQuery(String sql) throws SQLException {
</span></span><span class=line><span class=cl>    ... ...
</span></span><span class=line><span class=cl>    if (locallyScopedConn.getCacheResultSetMetadata()) { // 是否应用缓存ResultSetMeta
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    // ConnectionImpl中执行sql语句
</span></span><span class=line><span class=cl>    this.results = locallyScopedConn.execSQL(this, sql, -1, null,
</span></span><span class=line><span class=cl>            this.resultSetType, this.resultSetConcurrency,
</span></span><span class=line><span class=cl>            doStreaming,
</span></span><span class=line><span class=cl>            this.currentCatalog, cachedFields);
</span></span><span class=line><span class=cl>    ... ...
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public synchronized ResultSetInternalMethods execSQL(...) {
</span></span><span class=line><span class=cl>    ... ...
</span></span><span class=line><span class=cl>    // 进入MysqlIO中执行查询操作
</span></span><span class=line><span class=cl>    return this.io.sqlQueryDirect(callingStatement, sql,
</span></span><span class=line><span class=cl>            encoding, null, maxRows, resultSetType,
</span></span><span class=line><span class=cl>            resultSetConcurrency, streamResults, catalog,
</span></span><span class=line><span class=cl>            cachedMetadata);
</span></span><span class=line><span class=cl>    ... ...
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>final ResultSetInternalMethods sqlQueryDirect(...) throws Exception {
</span></span><span class=line><span class=cl>    ... ...
</span></span><span class=line><span class=cl>    // 发送查询命与sql查询语句，并得到查询结果(socket处理)
</span></span><span class=line><span class=cl>    Buffer resultPacket = sendCommand(MysqlDefs.QUERY, null, queryPacket, false, null, 0);
</span></span><span class=line><span class=cl>    ... ...
</span></span><span class=line><span class=cl>    // 封装成ResultSet
</span></span><span class=line><span class=cl>    ResultSetInternalMethods rs = readAllResults(callingStatement, maxRows, resultSetType,
</span></span><span class=line><span class=cl>            resultSetConcurrency, streamResults, catalog, resultPacket,
</span></span><span class=line><span class=cl>            false, -1L, cachedMetadata);
</span></span><span class=line><span class=cl>    ... ...
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>很多接口还没有深入了解，有时间继续。</p></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#简单使用-jdbc-接口>简单使用 JDBC 接口</a></li><li><a href=#批量处理>批量处理</a></li></ul></li><li><a href=#源码解析>源码解析</a><ul><li><a href=#注册加载>注册加载</a></li><li><a href=#drivermanager>DriverManager</a></li><li><a href=#获取链接>获取链接</a></li><li><a href=#socket的连接创建>Socket的连接创建</a></li><li><a href=#执行sql>执行SQL</a></li></ul></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>