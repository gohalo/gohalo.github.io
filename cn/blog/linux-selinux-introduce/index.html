<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>SELinux 简介 | GoHalo</title><link rel=apple-touch-icon sizes=180x180 href=https://gohalo.github.io/favicon/apple-touch-icon.png><link rel=icon href=https://gohalo.github.io/favicon/favicon.ico sizes=any><link rel=icon type=image/png sizes=32x32 href=https://gohalo.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://gohalo.github.io/favicon/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://gohalo.github.io/favicon/site.webmanifest><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=google-site-verification content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0"><meta name=description content="Security-Enhanced Linux, SELinux 给 Linux 带来的最重要价值是：提供了一个灵活的，可配置的 MAC 机制。包括了内核中的模块，以及用户态的工具，对于用户来说是透明的，只有同时满足了 &amp;ldquo;标准 Linux 访问控制&amp;rdquo; 和 &amp;ldquo;SELinux 访问控制&amp;rdquo; 时，主体才能访问客体。
"><link rel=stylesheet href=https://gohalo.github.io/font-awesome/css/font-awesome.min.css><link rel=stylesheet href=/css/syntax.min.c70103877c799b924f50023b6b01eca010d7e2808885a74f9ea662cc47379ae1.css integrity="sha256-xwEDh3x5m5JPUAI7awHsoBDX4oCIhadPnqZizEc3muE=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.c4814ac9dc5fab259f313a787ded4f8e.css integrity="md5-xIFKydxfqyWfMTp4fe1Pjg==" crossorigin=anonymous><style type=text/css>.main p{text-indent:2em}.main li p{text-indent:0}</style><noscript><style>img.lazyload{display:none}</style></noscript></head><body><div class=sticky-top><div class=header-bar></div><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/cn aria-label=GoHalo>GoHalo</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown aria-expanded=false>项目</a><ul class=dropdown-menu aria-labelledby=navbarDropdown><li><a class=dropdown-item href=/cn/project/bastion/>Bastion</a></li><li><a class="dropdown-item disabled" href=/cn/project/bootserver/>BootServer</a></li></ul></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/>博客</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/archives/>归档</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/blog/tags/>标签</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/slide/>幻灯片</a></li><li class=nav-item><a class=nav-link aria-current=page href=/cn/docs/>文档</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn dropdown-toggle" id=header-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
中文</button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=header-languages><li><a class=dropdown-item rel=alternate href=https://gohalo.github.io/en hreflang=en lang=en>English</a></li></ul></div><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=/cn/about><i class="fa fa-user" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/gohalo title=GitHub><i class="fa fa-github-alt" aria-hidden=true></i></a></li><li class=nav-item><button id=mode class="btn nav-link social-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><i class="fa fa-star" aria-hidden=true></i></span>
<span class=toggle-light><i class="fa fa-cog" aria-hidden=true></i></span></button></li></ul></div></div></nav></div><div class="main container-xxl" role=document><div class="blog row"><div class="col-md-12 col-xl-9 mt-4"><div class=header><h1>SELinux 简介</h1><div class="meta mb-3"><i class="fa fa-calendar" aria-hidden=true></i>
<span class=mx-2>2015-10-03</span>
<i class="fa fa-tags" aria-hidden=true></i>
<a class=text-body href=https://gohalo.github.io/cn/tags/linux/ role=button>linux</a>
<a class=text-body href=https://gohalo.github.io/cn/tags/security/ role=button>security</a></div></div><hr><div class=content><p>Security-Enhanced Linux, SELinux 给 Linux 带来的最重要价值是：提供了一个灵活的，可配置的 MAC 机制。包括了内核中的模块，以及用户态的工具，对于用户来说是透明的，只有同时满足了 &ldquo;标准 Linux 访问控制&rdquo; 和 &ldquo;SELinux 访问控制&rdquo; 时，主体才能访问客体。</p><img src=images/selinux-logo.jpg alt="SELinux Logo" width=200px>
<a class=anchor id=selinux></a><h1>SELinux <a href=#selinux aria-hidden=true>#</a></h1><p>SELinux 是一种强制存取控制 (Mandatory Access Control, MAC) 的实现，它的作法是以最小权限原则 (Principle of least privilege) 为基础。最初由美国国家安全局 (Natinal Security Agency) 设计，可以直接参考 <a href=https://www.nsa.gov/research/selinux/>www.nsa.gov</a> 。</p><p>最初的 Linux 采用的是自主式存取控制 (Discretionary Access Control, DAC)，基本上就是根据程序的拥有者与文件资源的 rwx 权限来判断存取的能力。这种策略存在着一些问题，如 root 可以读取所有的文档；如果将权限误设置为 777，那么所有的用户都可以读取该文件了。</p><p>而 MAC 可以依据条件决定是否有存取权限，可以规范个别细致的项目进行存取控制，提供完整的彻底化规范限制。可以对文件，目录，网络，套接字等进行规范，所有动作必须先得到 DAC 授权，然后得到 MAC 授权才可以存取。</p><a class=anchor id=运行机制></a><h2>运行机制 <a href=#%e8%bf%90%e8%a1%8c%e6%9c%ba%e5%88%b6 aria-hidden=true>#</a></h2><p>在 SELinux 中，访问控制属性叫做安全上下文。所有客体（文件、进程间通讯通道、套接字、网络主机等）和主体（进程）都有与其关联的安全上下文，一个安全上下文由三部分组成：用户、角色和类型标识符。</p><p><img alt="selinux decision process" src=images/selinux-decision-process.png class="mx-auto d-block"></p><p>当一个 subject (如一个应用) 试图访问一个 object (如一个文件) 时，在 Kernel 中的策略执行服务器将检查 AVC (Access Vector Cache)。如果基于 AVC 中的数据不能做出决定，则请求安全服务器，根据查询结果允许或拒绝访问。</p><p>SELinux 总共分为三个等级，</p><ul><li><code>Enforcing</code> 默认模式会在系统上启用并实施 SELinux 的安全性政策，包括拒绝访问及记录行动。</li><li><code>Permissive</code> 启用但不会实施安全性政策，而只会发出警告及记录行动，在排除错误时比较有用。</li><li><code>Disabled</code> 已被停用。</li></ul><p>SElinux 主要是用来管理程序，因此其主体 (Subject) 等价于程序；目标 (Object) 主要是指文件系统；政策 (Policy) 设置的基本的安全存储策略。</p><a class=anchor id=配置文件></a><h2>配置文件 <a href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-hidden=true>#</a></h2><p>SELinux 配置文件以及策略文件都位于 <code>/etc/selinux</code> 目录下，相关的策略可以通过如下方式进行设置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 列出SELinux的所有布尔值
</span></span><span class=line><span class=cl># getsebool -a
</span></span><span class=line><span class=cl>----- 设置SELinux布尔值，-P表示持久化，即使reboot之后，仍然有效
</span></span><span class=line><span class=cl># setsebool -P dhcpd_disable_trans=0
</span></span></code></pre></div><a class=anchor id=查看></a><h2>查看 <a href=#%e6%9f%a5%e7%9c%8b aria-hidden=true>#</a></h2><p>通过 <code>-Z</code> 选项可以查看策略，如 <code>ls -Z</code>、<code>ps -Z</code>、<code>id -Z</code> 等，除了常规的参数之外还会有 Security Context ，由 (identify:role:type) 三部分组成；安全性本文 (Security Context) 保存在 inode 中。</p><p><img alt="selinux context" src=images/selinux-context.png class="mx-auto d-block"></p><p>字段的含义如下：</p><ul><li>user<br>用户区域，指的是 selinux 环境下的用户，与登陆用户的影射关系可通过 <code>semanage login -l</code> 查看，常有 user_u(登陆用户)；system_u(Linux启动过程中默认值)；root(也就是root用户)。</li><li>role<br>通常由于安全类型的分组，常见的有object_r(通常为文件，实际只是一个占位符)。</li><li>type<br>与role类型实际决定了那些角色可以执行那些类型，这两种类型实际决定了那些。</li><li>level<br>控制级别，Multi-Category Security(MCS)。</li></ul><a class=anchor id=常见操作></a><h2>常见操作 <a href=#%e5%b8%b8%e8%a7%81%e6%93%8d%e4%bd%9c aria-hidden=true>#</a></h2><p>SELinux 缺省会通过 Linux 审计系统 auditd 将日志写在 <code>/var/log/audit/audit.log</code> 内。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 查看SELinux状态
</span></span><span class=line><span class=cl># sestatus -v                 # 如果SELinux status参数为enabled即为开启状态
</span></span><span class=line><span class=cl># getenforce                  # 也可以用这个命令检查
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 关闭SELinux
</span></span><span class=line><span class=cl># setenforce 0                # 设置SELinux 成为permissive(0)或者enforcing(1)模式
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cat /etc/selinux/config     # 可以直接设置配置文件
</span></span><span class=line><span class=cl>SELINUX=enforcing/disabled
</span></span></code></pre></div><p>当由 Diabled 切换至 Permissive 或 Enforcing 模式时，最好重启，重新标签文件系统。SELinux 包含了很多策略软件包 (policy package)，后缀名为 .pp，一般保存在 <code>/etc/selinux</code> 目录下，可以通过 find 命令查找。</p><p>出现权限问题后可以通过 setroubleshoot 工具包。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ echo &gt; /var/log/audit/audit.log                        # 清空，防止有过多的信息
</span></span><span class=line><span class=cl>$ sealert -a /var/log/audit/audit.log &gt; /tmp/result.txt  # 输出信息
</span></span></code></pre></div><p>其中的结果包括了建议执行的命令。</p><a class=anchor id=配置实例></a><h1>配置实例 <a href=#%e9%85%8d%e7%bd%ae%e5%ae%9e%e4%be%8b aria-hidden=true>#</a></h1><a class=anchor id=apache-服务标准配置修改></a><h2>Apache 服务标准配置修改 <a href=#apache-%e6%9c%8d%e5%8a%a1%e6%a0%87%e5%87%86%e9%85%8d%e7%bd%ae%e4%bf%ae%e6%94%b9 aria-hidden=true>#</a></h2><p>主要查看下如何通过 SELinux 修改 Apache 的权限配置。</p><a class=anchor id=1-让-apache-可以访问非默认目录></a><h4>1. 让 Apache 可以访问非默认目录 <a href=#1-%e8%ae%a9-apache-%e5%8f%af%e4%bb%a5%e8%ae%bf%e9%97%ae%e9%9d%9e%e9%bb%98%e8%ae%a4%e7%9b%ae%e5%bd%95 aria-hidden=true>#</a></h4><p>首先，获取默认 <code>/var/www</code> 目录的 SELinux 上下文。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># semanage fcontext -l | grep &#39;/var/www&#39;
</span></span><span class=line><span class=cl>/var/www(/.*)?          all     files   system_u:object_r:httpd_sys_content_t:s0
</span></span></code></pre></div><p>也就是 Apache 只能访问包含 <code>httpd_sys_content_t</code> 标签的文件，假设希望其使用 <code>/opt/www</code> 作为网站文件目录，就需要给这个目录下的文件增加 <code>httpd_sys_content_t</code> 标签，分两步实现。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 1. 为/opt/www目录下的文件添加默认标签类型
</span></span><span class=line><span class=cl># semanage fcontext -a -t httpd_sys_content_t &#39;/srv/www(/.*)?&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 2. 用新的标签类型标注已有文件
</span></span><span class=line><span class=cl># restorecon -Rv /srv/www
</span></span></code></pre></div><p>其中 restorecon 命令用于恢复文件默认标签，比较常用，比如从用户主目录下将某个文件复制到 Apache 网站目录下，Apache 默认是无法访问，因为用户主目录的下的文件标签是 <code>user_home_t</code>，此时就需要 restorecon 将其恢复为可被 Apache 访问的 <code>httpd_sys_content_t</code> 类型。</p><a class=anchor id=2-让-apache-侦听非标准端口></a><h4>2. 让 Apache 侦听非标准端口 <a href=#2-%e8%ae%a9-apache-%e4%be%a6%e5%90%ac%e9%9d%9e%e6%a0%87%e5%87%86%e7%ab%af%e5%8f%a3 aria-hidden=true>#</a></h4><p>默认情况下 Apache 只侦听 80 和 443 两个端口，若是直接指定其侦听 888 端口的话，会在通过 systemclt 启动或者重起时报 Permission denied 错误。</p><p>这个时候，若是在桌面环境下 SELinux 故障排除工具应该已经弹出来报错了。若是在终端下，可以通过查看 <code>/var/log/{messages, audit/audit.log}</code> 日志，用 <code>sealert -l</code> 加编号的方式查看，或者直接使用 <code>sealert -b</code> 浏览。</p><a class=anchor id=3-允许-apache-访问创建私人网站></a><h4>3. 允许 Apache 访问创建私人网站 <a href=#3-%e5%85%81%e8%ae%b8-apache-%e8%ae%bf%e9%97%ae%e5%88%9b%e5%bb%ba%e7%a7%81%e4%ba%ba%e7%bd%91%e7%ab%99 aria-hidden=true>#</a></h4><p>若是希望用户可以通过在 <code>~/public_html/</code> 放置文件的方式创建自己的个人网站的话，那么需要在 Apache 策略中允许该操作执行。使用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># setsebool httpd_enable_homedirs 1
</span></span></code></pre></div><p>setsebool 用来切换由布尔值控制的 SELinux 策略的，当前布尔值策略的状态可以通过 getsebool 来获知。</p><a class=anchor id=capabilities></a><h1>capabilities <a href=#capabilities aria-hidden=true>#</a></h1><p>通常 capabilities 是和 SELinux 配合使用的，以往，如果要运行一个需要 root 权限的程序，那么需要保证有运行权限，且是 root 用户；通过 capabilities 就可以只赋予程序所需要的权限。</p><p>以 ping 命令为例，因为需要发送 raw 格式数据，部分发行版本使用了 <code>setuid + root</code>，实际上只需要赋予 <code>CAP_NET_RAW</code> 权限，然后去除 setuid 即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>----- 直接复制一个ping命令，然后进行测试
</span></span><span class=line><span class=cl># cp ping anotherping
</span></span><span class=line><span class=cl># chcon -t ping_exec_t anotherping
</span></span><span class=line><span class=cl>$ ping -c 1 127.0.0.1
</span></span><span class=line><span class=cl>PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
</span></span><span class=line><span class=cl>64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.057 ms
</span></span><span class=line><span class=cl>$ anotherping -c 1 127.0.0.1
</span></span><span class=line><span class=cl>ping: icmp open socket: Operation not permitted
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>----- 新增CAP_NET_RAW权限，然后用非root用户重新测试
</span></span><span class=line><span class=cl># setcap cap_net_raw+ep anotherping
</span></span><span class=line><span class=cl>$ anotherping -c 1 127.0.0.1
</span></span><span class=line><span class=cl>PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
</span></span><span class=line><span class=cl>64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.054 ms
</span></span></code></pre></div></div></div><div class="sidebar col-xl-3 mt-2"><div id=toc class=position-fixed><nav id=TableOfContents><ul><li><a href=#selinux>SELinux</a><ul><li><a href=#运行机制>运行机制</a></li><li><a href=#配置文件>配置文件</a></li><li><a href=#查看>查看</a></li><li><a href=#常见操作>常见操作</a></li></ul></li><li><a href=#配置实例>配置实例</a><ul><li><a href=#apache-服务标准配置修改>Apache 服务标准配置修改</a></li></ul></li><li><a href=#capabilities>capabilities</a></li></ul></nav></div></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class=text-center>Built by GoHalo, generated with <a class=text-muted href=https://gohugo.io>Hugo</a>, and hosted on GitHub Pages</div></div><div class=row><div class=text-center>Copyright © 2013-2025 GoHalo. All Rights Reserved.</div></div></div></footer><script src=https://gohalo.github.io/bootstrap/js/bootstrap.bundle.min.js></script>
<script src=/main.b9cbcb174709877512d64e24f297f66a40c8d91c9a81128cb04bdd7b10247df8.js integrity="sha256-ucvLF0cJh3US1k4k8pf2akDI2RyagRKMsEvdexAkffg=" crossorigin=anonymous></script>
<a href=# class="btn btn-light btn-lg backtop" title=返回顶部><i class="fa fa-angle-double-up" aria-hidden=true></i></a></body></html>